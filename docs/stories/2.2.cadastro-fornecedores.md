# Story 2.2: Cadastro de Fornecedores Progressivo

## Status: Ready for Review

## Story

**As a** usuario,
**I want** cadastrar fornecedores de forma rapida,
**so that** eu possa registrar minhas compras e contas a pagar associadas.

## Acceptance Criteria

1. Model Fornecedor no Prisma: id, tenantId, name (obrigatorio), phone, email, document (CNPJ/CPF), address (JSON), notes, createdAt, updatedAt
2. Formulario progressivo identico ao de Clientes (nome obrigatorio, demais expandiveis)
3. Lista com busca por nome/telefone/documento
4. Tela de detalhe do fornecedor
5. Edicao inline dos campos
6. RLS aplicado - fornecedores isolados por tenant

## Tasks / Subtasks

- [x] Adicionar model Fornecedor ao Prisma schema (AC: 1, 6)
  - [x] Adicionar model `Fornecedor` em `prisma/schema.prisma` com campos: id (cuid), tenantId (String, FK para Tenant), name (String), phone (String?), email (String?), document (String?), address (Json?), notes (String?), createdAt, updatedAt
  - [x] Adicionar relation `fornecedores Fornecedor[]` no model Tenant
  - [x] Criar indice `@@index([tenantId, name])`
  - [x] `@@map("fornecedores")`
  - [x] Executar `npx prisma generate`
- [x] Criar service de fornecedores (AC: 1, 3, 6)
  - [x] Criar `src/modules/cadastros/fornecedor.service.ts`
  - [x] Funcao `createFornecedor(data)`: cria fornecedor usando `prisma` (com tenant auto-inject)
  - [x] Funcao `listFornecedores({ search?, page?, pageSize? })`: lista com busca e paginacao
  - [x] Funcao `getFornecedor(id)`: busca por id
  - [x] Funcao `updateFornecedor(id, data)`: atualiza campos
  - [x] Funcao `deleteFornecedor(id)`: deleta fornecedor
  - [x] Reutilizar mesmo padrao do `cliente.service.ts`
- [x] Criar Zod schemas de validacao (AC: 1)
  - [x] Criar `src/modules/cadastros/fornecedor.schema.ts`
  - [x] `createFornecedorSchema`: name (min 2, obrigatorio), phone/email/document/address/notes todos opcionais
  - [x] `updateFornecedorSchema`: todos campos optional (partial)
  - [x] `listFornecedorQuerySchema`: search, page, pageSize
  - [x] Validacao de document (CPF/CNPJ) quando preenchido via `isValidDocument`
- [x] Criar API routes REST (AC: 1, 3, 6)
  - [x] Criar `src/app/api/v1/fornecedores/route.ts` com GET (listar) e POST (criar)
  - [x] Criar `src/app/api/v1/fornecedores/[id]/route.ts` com GET, PATCH, DELETE
  - [x] Todos endpoints usam `withTenantApi`
- [x] Criar pagina de lista de fornecedores (AC: 2, 3)
  - [x] Criar `src/app/(dashboard)/cadastros/fornecedores/page.tsx` como Client Component
  - [x] Header com titulo "Fornecedores" e botao "+ Novo Fornecedor"
  - [x] Campo de busca com debounce (300ms)
  - [x] Lista em cards com nome, telefone, email
  - [x] Paginacao com contagem total
  - [x] Empty state com CTA "Cadastre seu primeiro fornecedor"
  - [x] Loading skeleton
- [x] Criar formulario progressivo de novo fornecedor (AC: 2, 5)
  - [x] Criar `src/app/(dashboard)/cadastros/fornecedores/novo/page.tsx` como Client Component
  - [x] Campo inicial visivel: nome (obrigatorio)
  - [x] Botao "Mais detalhes" expande: telefone, email, CPF/CNPJ (com validacao), endereco, observacoes
  - [x] Botoes "Salvar" e "Cancelar"
  - [x] Redirect para lista apos salvar com toast
- [x] Criar tela de detalhe do fornecedor (AC: 4, 5)
  - [x] Criar `src/app/(dashboard)/cadastros/fornecedores/[id]/page.tsx` como Client Component
  - [x] Exibir todos os campos
  - [x] Edicao inline: clicar no campo abre input
  - [x] Secao placeholder "Historico de Compras"
  - [x] Botao "Excluir fornecedor" com dialog de confirmacao

## Dev Notes

**Source Tree relevante:**
```
src/
├── app/(dashboard)/cadastros/fornecedores/
│   ├── page.tsx                # Lista de fornecedores
│   ├── novo/page.tsx           # Formulario novo fornecedor
│   └── [id]/page.tsx           # Detalhe do fornecedor
├── app/api/v1/fornecedores/
│   ├── route.ts                # GET + POST
│   └── [id]/route.ts           # GET + PATCH + DELETE
└── modules/cadastros/
    ├── fornecedor.service.ts   # Business logic
    └── fornecedor.schema.ts    # Zod schemas
```

**Depende de:** Story 2.1 (padrao de CRUD de cadastros, validateCPF, isValidDocument ja implementados)

**Reutilizacao do Story 2.1:** O padrao de service, schema, API route e UI e identico ao de Clientes. A diferenca principal e que Fornecedor nao tem phone como obrigatorio (apenas name e obrigatorio).

**Padrao de API:** Mesmo `withTenantApi` wrapper do Story 2.1.

**Componentes shadcn/ui:** Mesmos do Story 2.1 (Button, Input, Card, Dialog, Skeleton, Sonner).

**Coding Standards:**
- Services em kebab-case: `fornecedor.service.ts`
- API routes: `/api/v1/fornecedores`
- Schemas: `createFornecedorSchema`

### Testing

- **Localizacao:** `tests/unit/modules/cadastros/`
- **Framework:** Vitest
- **Testes necessarios:**
  - `createFornecedorSchema` valida input correto e rejeita invalido
  - Service `createFornecedor` chama prisma.fornecedor.create
  - Service `listFornecedores` com paginacao e busca
  - Service `getFornecedor` retorna fornecedor por id
  - Service `updateFornecedor` atualiza campos
- **Mocks:** Mock do `prisma` para testes de service

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-07 | 1.0 | Criacao inicial da story | Sarah (PO) |
| 2026-02-07 | 1.1 | Implementacao completa | James (Dev) |

## Dev Agent Record

### Agent Model Used
Claude Opus 4.6 (via Claude Code)

### Debug Log References
- No blocking issues - same pattern as Story 2.1

### Completion Notes List
- Prisma model Fornecedor with tenantId FK, index on [tenantId, name]
- Key difference from Cliente: phone is optional (only name required)
- Full CRUD service following same pattern as cliente.service.ts
- Zod schemas with name-only required validation
- REST API: GET/POST /api/v1/fornecedores, GET/PATCH/DELETE /api/v1/fornecedores/[id]
- Progressive form: name visible, "Mais detalhes" expands phone, email, CPF/CNPJ, address, notes
- List with 300ms debounce search, pagination, empty state, loading skeleton
- Detail page with inline editing, delete with confirmation dialog
- "Historico de Compras" placeholder section
- 15 new tests (9 schema + 6 service), 83 total passing
- No new dependencies

### File List
- `prisma/schema.prisma` (modified - added Fornecedor model + Tenant relation)
- `src/modules/cadastros/fornecedor.service.ts` (new - CRUD service)
- `src/modules/cadastros/fornecedor.schema.ts` (new - Zod schemas)
- `src/app/api/v1/fornecedores/route.ts` (new - GET + POST)
- `src/app/api/v1/fornecedores/[id]/route.ts` (new - GET + PATCH + DELETE)
- `src/app/(dashboard)/cadastros/fornecedores/page.tsx` (new - list page)
- `src/app/(dashboard)/cadastros/fornecedores/novo/page.tsx` (new - progressive form)
- `src/app/(dashboard)/cadastros/fornecedores/[id]/page.tsx` (new - detail + inline edit)
- `tests/unit/modules/cadastros/fornecedor-schema.test.ts` (new - 9 tests)
- `tests/unit/modules/cadastros/fornecedor-service.test.ts` (new - 6 tests)

## QA Results
*A ser preenchido pelo QA agent*
