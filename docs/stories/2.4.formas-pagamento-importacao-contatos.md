# Story 2.4: Formas de Pagamento e Importacao de Contatos

## Status: Draft

## Story

**As a** usuario,
**I want** ter formas de pagamento pre-configuradas e poder importar contatos do celular,
**so that** eu nao precise configurar tudo do zero.

## Acceptance Criteria

1. Model FormaPagamento no Prisma: id, tenantId, name, type (pix/dinheiro/debito/credito/boleto/outro), active, isDefault, installments (max parcelas), fee (taxa percentual em centesimos), createdAt
2. Formas de pagamento pre-criadas no onboarding com base na resposta do wizard (step 5)
3. Tela de gerenciamento: ativar/desativar, editar nome, definir taxa, definir parcelas maximas
4. API de importacao de contatos: recebe lista de contatos (nome + telefone) e cria clientes em batch (com de-duplicacao por telefone)
5. Botao "Importar Contatos" na tela de clientes que acessa Contacts API do navegador (com permissao LGPD)
6. Feedback visual da importacao: X contatos importados, Y duplicados ignorados

## Tasks / Subtasks

- [ ] Adicionar model FormaPagamento ao Prisma schema (AC: 1)
  - [ ] Adicionar model `FormaPagamento` em `prisma/schema.prisma`: id (cuid), tenantId (String, FK para Tenant), name (String), type (String), active (Boolean, default true), isDefault (Boolean, default false), installments (Int, default 1), fee (Int, default 0, percentual em centesimos - 250 = 2.50%), createdAt, updatedAt
  - [ ] Adicionar relation `formasPagamento FormaPagamento[]` no model Tenant
  - [ ] Criar indice `@@index([tenantId])`
  - [ ] `@@map("formas_pagamento")`
  - [ ] Executar `npx prisma generate`
- [ ] Criar service de formas de pagamento (AC: 1, 2, 3)
  - [ ] Criar `src/modules/cadastros/forma-pagamento.service.ts`
  - [ ] Funcao `createFormaPagamento(data)`: cria forma de pagamento
  - [ ] Funcao `createDefaultFormasPagamento(tenantId, paymentMethods: string[])`: cria formas default baseado nas opcoes do onboarding (PIX, DINHEIRO, CARTAO_DEBITO, CARTAO_CREDITO, BOLETO)
  - [ ] Funcao `listFormasPagamento()`: lista todas do tenant (sem paginacao, max ~10)
  - [ ] Funcao `updateFormaPagamento(id, data)`: atualiza nome, active, isDefault, installments, fee
  - [ ] Funcao `toggleFormaPagamento(id)`: alterna active true/false
- [ ] Criar Zod schemas (AC: 1, 3)
  - [ ] Criar `src/modules/cadastros/forma-pagamento.schema.ts`
  - [ ] `createFormaPagamentoSchema`: name (min 1), type (enum: PIX, DINHEIRO, DEBITO, CREDITO, BOLETO, OUTRO), installments (int >= 1, default 1), fee (int >= 0, default 0)
  - [ ] `updateFormaPagamentoSchema`: name, active, isDefault, installments, fee (todos opcionais)
- [ ] Criar API routes de formas de pagamento (AC: 1, 3)
  - [ ] Criar `src/app/api/v1/formas-pagamento/route.ts` com GET e POST
  - [ ] Criar `src/app/api/v1/formas-pagamento/[id]/route.ts` com PATCH
  - [ ] Todos endpoints usam `withTenantApi`
- [ ] Integrar criacao de formas de pagamento no onboarding (AC: 2)
  - [ ] Modificar `src/app/api/v1/onboarding/route.ts`: apos criar tenant, chamar `createDefaultFormasPagamento(tenantId, paymentMethods)`
  - [ ] Formas de pagamento default com configuracoes padrao:
    - PIX: installments=1, fee=0, isDefault=true
    - DINHEIRO: installments=1, fee=0
    - DEBITO: installments=1, fee=150 (1.50%)
    - CREDITO: installments=12, fee=350 (3.50%)
    - BOLETO: installments=1, fee=250 (2.50%)
- [ ] Criar pagina de gerenciamento de formas de pagamento (AC: 3)
  - [ ] Criar `src/app/(dashboard)/configuracoes/formas-pagamento/page.tsx` como Client Component
  - [ ] Lista de formas com toggle ativo/inativo (Switch component)
  - [ ] Para cada forma: nome editavel, taxa (%) editavel, parcelas max editavel
  - [ ] Botao "+ Nova Forma de Pagamento" para custom
  - [ ] Badge "Padrao" na forma marcada como isDefault
  - [ ] Link acessivel via tela de Configuracoes
- [ ] Criar API de importacao de contatos em batch (AC: 4, 6)
  - [ ] Criar `src/app/api/v1/clientes/import/route.ts` com POST
  - [ ] Receber array de `{ name: string, phone: string }[]`
  - [ ] Validar com Zod: cada contato deve ter name e phone
  - [ ] De-duplicacao: buscar clientes existentes do tenant por phone
  - [ ] Criar apenas contatos com phone nao existente
  - [ ] Retornar `{ imported: number, duplicates: number, total: number }`
- [ ] Implementar botao "Importar Contatos" na lista de clientes (AC: 5, 6)
  - [ ] Adicionar botao "Importar Contatos" no header da lista de clientes (ao lado de "+ Novo Cliente")
  - [ ] Ao clicar: mostrar dialog LGPD explicando que contatos serao usados apenas no app
  - [ ] Apos aceitar: usar Contact Picker API (`navigator.contacts.select`) para selecionar contatos
  - [ ] Fallback para navegadores sem Contact Picker: mostrar mensagem informando que importacao nao e suportada
  - [ ] Enviar contatos selecionados para POST `/api/v1/clientes/import`
  - [ ] Mostrar toast com resultado: "X contatos importados, Y duplicados ignorados"
  - [ ] Loading state durante importacao

## Dev Notes

**Source Tree relevante:**
```
src/
├── app/(dashboard)/configuracoes/formas-pagamento/
│   └── page.tsx                    # Gerenciamento formas de pagamento
├── app/api/v1/
│   ├── formas-pagamento/
│   │   ├── route.ts                # GET + POST
│   │   └── [id]/route.ts           # PATCH
│   ├── clientes/
│   │   └── import/route.ts         # POST batch import
│   └── onboarding/route.ts         # Modificar para criar formas (existente)
└── modules/cadastros/
    ├── forma-pagamento.service.ts  # Business logic
    └── forma-pagamento.schema.ts   # Zod schemas
```

**Depende de:** Story 2.1 (model Cliente, API clientes), Story 1.4 (onboarding wizard)

**Taxas em centesimos de percentual:**
- Fee armazenada como Int (centesimos): 350 = 3.50%
- Formatacao: `(fee / 100).toFixed(2) + '%'`
- Isso evita problemas de floating point

**Contact Picker API:**
```typescript
// Check support
const supported = 'contacts' in navigator && 'ContactsManager' in window;

// Request contacts
const contacts = await navigator.contacts.select(
  ['name', 'tel'],
  { multiple: true }
);
```
- Disponivel apenas em Chrome Android e Safari iOS (mobile-first)
- Nao disponivel em desktop - mostrar fallback

**LGPD Compliance:** Exibir dialog antes de acessar contatos explicando finalidade e que dados ficam isolados no tenant.

**Componentes shadcn/ui a utilizar:**
- Switch (novo - para toggle ativo/inativo) - instalar via `npx shadcn@latest add switch`
- Button, Input, Card, Dialog, Skeleton, Sonner (existentes)

**Modificacao no onboarding:** O endpoint POST /api/v1/onboarding atualmente cria o tenant mas nao cria formas de pagamento. Precisamos adicionar a chamada `createDefaultFormasPagamento` apos a criacao do tenant, usando `runWithTenant` para garantir tenant context.

### Testing

- **Localizacao:** `tests/unit/modules/cadastros/`
- **Framework:** Vitest
- **Testes necessarios:**
  - `createDefaultFormasPagamento` cria formas corretas para cada tipo
  - `createFormaPagamentoSchema` valida input
  - Service `toggleFormaPagamento` alterna active
  - Service `updateFormaPagamento` atualiza campos
  - Import batch: cria clientes novos e ignora duplicados por phone
  - Import batch: retorna contagem correta de imported vs duplicates
- **Mocks:** Mock do `prisma` para testes de service

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-07 | 1.0 | Criacao inicial da story | Sarah (PO) |

## Dev Agent Record

### Agent Model Used
*A ser preenchido pelo dev agent*

### Debug Log References
*A ser preenchido pelo dev agent*

### Completion Notes List
*A ser preenchido pelo dev agent*

### File List
*A ser preenchido pelo dev agent*

## QA Results
*A ser preenchido pelo QA agent*
