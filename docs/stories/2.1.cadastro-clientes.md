# Story 2.1: Cadastro de Clientes Progressivo

## Status: Ready for Review

## Story

**As a** usuario,
**I want** cadastrar clientes rapidamente com apenas nome e telefone,
**so that** eu possa comecar a vender sem perder tempo preenchendo formularios longos.

## Acceptance Criteria

1. Model Cliente no Prisma: id, tenantId, name (obrigatorio), phone (obrigatorio), email, document (CPF/CNPJ), address (JSON), notes, createdAt, updatedAt
2. Formulario de criacao com apenas 2 campos visiveis inicialmente (nome e telefone)
3. Botao "Mais detalhes" expande progressivamente: email, CPF/CNPJ, endereco completo, observacoes
4. Lista de clientes com busca por nome/telefone/documento com autocomplete
5. Tela de detalhe do cliente com informacoes e futuro historico de vendas (placeholder)
6. Edicao inline dos campos do cliente
7. Validacao de CPF/CNPJ quando preenchido
8. Paginacao ou scroll infinito na lista
9. RLS aplicado - clientes isolados por tenant

## Tasks / Subtasks

- [x] Adicionar model Cliente ao Prisma schema e gerar migration (AC: 1, 9)
  - [x] Adicionar model `Cliente` em `prisma/schema.prisma` com campos: id (cuid), tenantId (String, FK para Tenant), name (String), phone (String), email (String?), document (String?), address (Json?), notes (String?), createdAt, updatedAt
  - [x] Adicionar relation `clientes Cliente[]` no model Tenant
  - [x] Criar indice composto `@@index([tenantId, name])` e `@@index([tenantId, phone])` para busca
  - [x] `@@map("clientes")`
  - [x] Executar `npx prisma db push` ou `npx prisma generate` para gerar types
- [x] Criar service de clientes (AC: 1, 4, 8, 9)
  - [x] Criar `src/modules/cadastros/cliente.service.ts`
  - [x] Funcao `createCliente(data)`: cria cliente usando `prisma` (com tenant auto-inject)
  - [x] Funcao `listClientes({ search?, page?, pageSize? })`: lista com busca por name/phone/document, paginacao (default 20 por pagina), retorna { data, total, page, pageSize }
  - [x] Funcao `getCliente(id)`: busca por id com tenant filter
  - [x] Funcao `updateCliente(id, data)`: atualiza campos do cliente
  - [x] Funcao `deleteCliente(id)`: soft delete ou hard delete
  - [x] Usar `prisma` (com tenant extension) para todas as queries
- [x] Criar Zod schemas de validacao (AC: 7)
  - [x] Criar `src/modules/cadastros/cliente.schema.ts`
  - [x] `createClienteSchema`: name (min 2), phone (min 8), email (email format, optional), document (CPF/CNPJ validation, optional), address (JSON, optional), notes (optional)
  - [x] `updateClienteSchema`: todos campos optional (partial)
  - [x] `listClienteQuerySchema`: search (string, optional), page (number, default 1), pageSize (number, default 20, max 100)
  - [x] Reutilizar `validateCNPJ` de `src/lib/validators.ts` e adicionar `validateCPF`
- [x] Criar API routes REST (AC: 1, 4, 8, 9)
  - [x] Criar `src/app/api/v1/clientes/route.ts` com GET (listar) e POST (criar)
  - [x] GET: query params search, page, pageSize; usa `withTenantApi` wrapper
  - [x] POST: body validado com Zod; usa `withTenantApi` wrapper
  - [x] Criar `src/app/api/v1/clientes/[id]/route.ts` com GET (detalhe), PATCH (editar), DELETE
  - [x] Todos endpoints usam `withTenantApi` para garantir tenant isolation
  - [x] Retornar formato padrao `{ data: ... }` ou `{ error: ... }`
- [x] Criar pagina de lista de clientes (AC: 2, 3, 4, 8)
  - [x] Criar `src/app/(dashboard)/cadastros/clientes/page.tsx` como Client Component
  - [x] Header com titulo "Clientes" e botao "+ Novo Cliente"
  - [x] Campo de busca com debounce (300ms) para filtrar por nome/telefone/documento
  - [x] Lista em cards mobile-friendly com nome, telefone, e badge de documento se houver
  - [x] Paginacao com botoes "Anterior" e "Proximo" mostrando contagem total
  - [x] Empty state usando componente `EmptyState` com CTA "Cadastre seu primeiro cliente"
  - [x] Loading skeleton enquanto carrega dados
- [x] Criar formulario progressivo de novo cliente (AC: 2, 3, 7)
  - [x] Criar `src/app/(dashboard)/cadastros/clientes/novo/page.tsx` como Client Component
  - [x] Campos iniciais visiveis: nome e telefone (obrigatorios)
  - [x] Botao "Mais detalhes" que expande secao com: email, CPF/CNPJ (com mascara e validacao), endereco (rua, numero, bairro, cidade, estado, cep), observacoes
  - [x] Mascara de input para telefone: (XX) XXXXX-XXXX
  - [x] Mascara de input para CPF (XXX.XXX.XXX-XX) ou CNPJ (XX.XXX.XXX/XXXX-XX)
  - [x] Validacao visual: borda verde se valido, vermelha se invalido
  - [x] Botoes "Salvar" e "Cancelar"
  - [x] Apos salvar, redirect para lista de clientes com toast de sucesso
- [x] Criar tela de detalhe do cliente (AC: 5, 6)
  - [x] Criar `src/app/(dashboard)/cadastros/clientes/[id]/page.tsx` como Client Component
  - [x] Exibir todos os campos do cliente
  - [x] Edicao inline: clicar no campo abre input para editar, salvar com blur/enter
  - [x] Secao placeholder "Historico de Vendas" com empty state
  - [x] Botao "Excluir cliente" com dialog de confirmacao
- [x] Adicionar `validateCPF` ao validators.ts (AC: 7)
  - [x] Implementar algoritmo de validacao de CPF (digitos verificadores)
  - [x] Implementar `formatCPF(value)` com mascara XXX.XXX.XXX-XX
  - [x] Funcao `isValidDocument(value)` que detecta CPF vs CNPJ pelo tamanho e valida

## Dev Notes

**Source Tree relevante:**
```
src/
├── app/(dashboard)/cadastros/clientes/
│   ├── page.tsx                # Lista de clientes (Client Component)
│   ├── novo/page.tsx           # Formulario novo cliente (Client Component)
│   └── [id]/page.tsx           # Detalhe do cliente (Client Component)
├── app/api/v1/clientes/
│   ├── route.ts                # GET (list) + POST (create)
│   └── [id]/route.ts           # GET (detail) + PATCH (update) + DELETE
├── modules/cadastros/
│   ├── cliente.service.ts      # Business logic + DB operations
│   └── cliente.schema.ts       # Zod validation schemas
├── lib/
│   ├── validators.ts           # validateCPF (novo), validateCNPJ (existente)
│   └── prisma.ts               # Prisma client com tenant extension (existente)
├── core/tenant/
│   ├── tenant.middleware.ts    # withTenantApi wrapper (existente)
│   └── tenant.context.ts      # AsyncLocalStorage (existente)
└── components/shared/
    ├── empty-state.tsx         # EmptyState component (existente)
    └── loading-skeleton.tsx    # LoadingSkeleton component (existente)
```

**Depende de:** Story 1.3 (multi-tenant, Prisma client com RLS extension, withTenantApi), Story 1.5 (layout dashboard, EmptyState, LoadingSkeleton)

**Padrao de API com tenant context:**
```typescript
import { withTenantApi } from '@/core/tenant/tenant.middleware';

export async function GET(request: NextRequest) {
  return withTenantApi(request, async (tenantId, userId) => {
    // prisma queries here auto-inject tenantId via extension
    const result = await prisma.cliente.findMany({ ... });
    return NextResponse.json({ data: result });
  });
}
```

**Valores monetarios:** Nao se aplica nesta story (sem valores em centavos).

**Tenant isolation:** Todas as queries via `prisma` (com extension) auto-injetam tenantId. Nao usar `basePrisma` para dados de cadastros.

**Componentes shadcn/ui a utilizar:**
- Button, Input, Card (existentes)
- Dialog (existente - para confirmacao de exclusao)
- Skeleton (existente - para loading state)
- Sonner/toast (existente - para feedback)

**Coding Standards:**
- Services em kebab-case: `cliente.service.ts`
- API routes em kebab-case: `/api/v1/clientes`
- Zod schemas em camelCase + Schema: `createClienteSchema`
- Client Components com `'use client'` para interatividade
- Debounce de busca: 300ms
- Paginacao: default 20 items, max 100

### Testing

- **Localizacao:** `tests/unit/modules/cadastros/` e `tests/unit/lib/`
- **Framework:** Vitest + Testing Library
- **Testes necessarios:**
  - `validateCPF()` valida CPFs corretos e rejeita invalidos
  - `isValidDocument()` detecta CPF vs CNPJ corretamente
  - `createClienteSchema` valida input correto e rejeita invalido
  - `listClienteQuerySchema` valida query params
  - Service `createCliente` chama prisma.cliente.create
  - Service `listClientes` com paginacao e busca
  - Service `getCliente` retorna cliente por id
  - Service `updateCliente` atualiza campos
- **Mocks:** Mock do `prisma` para testes de service
- **E2E (futuro):** Fluxo completo de CRUD de cliente via Playwright

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-07 | 1.0 | Criacao inicial da story | Sarah (PO) |
| 2026-02-07 | 1.1 | Implementacao completa | James (Dev) |

## Dev Agent Record

### Agent Model Used
Claude Opus 4.6 (via Claude Code)

### Debug Log References
- Prisma type error: `create` requires `tenantId` or `tenant` relation even though extension auto-injects. Fixed by passing `tenantId: ''` placeholder that gets overwritten by extension at runtime.

### Completion Notes List
- Prisma model Cliente with tenantId FK, indexes on [tenantId, name] and [tenantId, phone]
- Full CRUD service: createCliente, listClientes (search + pagination), getCliente, updateCliente, deleteCliente
- Zod schemas: createClienteSchema, updateClienteSchema, listClienteQuerySchema with coerce for query params
- REST API: GET/POST /api/v1/clientes, GET/PATCH/DELETE /api/v1/clientes/[id] - all wrapped with withTenantApi
- Progressive form: name+phone visible, "Mais detalhes" expands email, CPF/CNPJ, address, notes
- Phone mask (XX) XXXXX-XXXX, CPF/CNPJ auto-detect mask
- Client list with 300ms debounce search, pagination, empty state, loading skeleton
- Detail page with inline editing (click-to-edit), address display, delete with confirmation dialog
- validateCPF, formatCPF, isValidDocument added to validators.ts
- 31 new tests (12 schema + 8 service + 11 validators), 68 total passing
- No new dependencies added

### File List
- `prisma/schema.prisma` (modified - added Cliente model + Tenant relation)
- `src/modules/cadastros/cliente.service.ts` (new - CRUD service)
- `src/modules/cadastros/cliente.schema.ts` (new - Zod schemas)
- `src/app/api/v1/clientes/route.ts` (new - GET + POST)
- `src/app/api/v1/clientes/[id]/route.ts` (new - GET + PATCH + DELETE)
- `src/app/(dashboard)/cadastros/clientes/page.tsx` (new - list page)
- `src/app/(dashboard)/cadastros/clientes/novo/page.tsx` (new - progressive form)
- `src/app/(dashboard)/cadastros/clientes/[id]/page.tsx` (new - detail + inline edit)
- `src/lib/validators.ts` (modified - added validateCPF, formatCPF, isValidDocument)
- `src/modules/cadastros/.gitkeep` (deleted)
- `tests/unit/modules/cadastros/cliente-schema.test.ts` (new - 12 tests)
- `tests/unit/modules/cadastros/cliente-service.test.ts` (new - 8 tests)
- `tests/unit/lib/validators.test.ts` (modified - added 11 CPF/isValidDocument tests)

## QA Results
*A ser preenchido pelo QA agent*
