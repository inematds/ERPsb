# Story 7.3: Captura de Venda por Foto ou Anotacao

## Status: Draft

## Story

**As a** usuario,
**I want** registrar uma venda tirando foto dos itens ou escrevendo uma anotacao rapida,
**so that** eu nao precise navegar pelo catalogo quando estou com pressa.

## Acceptance Criteria

1. Botao "Venda por foto" na tela de vendas (ao lado de "Nova Venda")
2. Duas opcoes de entrada: "Tirar foto" ou "Escrever anotacao"
3. Para foto: usuario tira foto dos itens no balcao, IA identifica produtos do catalogo
4. Para anotacao: campo de texto livre (ex: "3 camisetas P brancas e 1 bermuda GG pro Joao")
5. IA interpreta entrada e monta lista de itens vinculados a produtos existentes no catalogo
6. Tela de aprovacao com venda pre-montada: itens, quantidades, precos, cliente (se identificado)
7. Usuario pode editar qualquer campo antes de aprovar
8. "Aprovar venda" cria Venda CONFIRMADA (mesmo fluxo da venda rapida 4.1)
9. Se IA nao encontra produto no catalogo, sugere os mais similares (top 3)
10. Campo de cliente pre-preenchido se nome/telefone mencionado na anotacao

## Tasks / Subtasks

- [ ] Criar tela de captura de venda (AC: 1, 2, 3, 4)
  - [ ] Criar `src/app/(dashboard)/vendas/captura/page.tsx` como Client Component
  - [ ] Tabs: "Foto" | "Anotacao"
  - [ ] Tab Foto: reutilizar componente photo-capture da Story 7.2
  - [ ] Tab Anotacao: textarea com placeholder "Descreva a venda... Ex: 3 camisetas P e 1 bermuda GG pro Joao"
  - [ ] Botao "Processar" que envia para IA
  - [ ] Loading state com skeleton
- [ ] Criar prompt de IA para vendas (AC: 5, 9, 10)
  - [ ] Adicionar prompt VENDA no claude-vision.client.ts
  - [ ] Para foto: "Identifique os produtos visiveis na imagem e suas quantidades"
  - [ ] Para texto: "Interprete esta anotacao de venda e extraia itens, quantidades, cliente"
  - [ ] Incluir catalogo de produtos do tenant no prompt (nomes e precos) para matching
  - [ ] Retornar items com productId vinculado quando possivel, ou sugestoes quando nao
- [ ] Criar endpoint de processamento de venda (AC: 5)
  - [ ] Criar `src/app/api/v1/captures/process-sale/route.ts` com POST
  - [ ] Recebe `{ imageUrl?, text?, source }` (um dos dois obrigatorio)
  - [ ] Busca catalogo de produtos do tenant
  - [ ] Envia para Claude com contexto do catalogo
  - [ ] Retorna `{ extractedData, confidence }`
- [ ] Criar tela de aprovacao de venda (AC: 6, 7, 8)
  - [ ] Criar `src/app/(dashboard)/vendas/captura/[id]/page.tsx` como Client Component
  - [ ] Reutilizar layout da tela de nova venda (4.1) mas com dados pre-preenchidos
  - [ ] Lista de itens editavel (quantidade, remover, adicionar)
  - [ ] Para itens nao vinculados: dropdown com sugestoes (AC: 9)
  - [ ] Cliente pre-selecionado se identificado (AC: 10)
  - [ ] Forma de pagamento (selecao manual)
  - [ ] Botao "Aprovar e confirmar venda"
  - [ ] Ao aprovar: cria Venda + ContaReceber + baixa estoque (fluxo padrao)
- [ ] Adicionar botao na pagina de vendas (AC: 1)
  - [ ] Modificar `src/app/(dashboard)/vendas/page.tsx`
  - [ ] Adicionar botao "Venda por foto" (icone Camera) ao lado de "Nova Venda"
  - [ ] Link para `/vendas/captura`
- [ ] Matching inteligente de produtos (AC: 5, 9)
  - [ ] Criar funcao `matchProducts(extractedItems, tenantProducts)` no capture.service
  - [ ] Para cada item extraido:
    - Busca por nome exato (case insensitive)
    - Se nao encontrar: busca por similaridade (ILIKE %nome%)
    - Se nao encontrar: retornar top 3 sugestoes por similaridade
  - [ ] Retornar confidence por item (1.0 = exato, 0.5-0.9 = similar, 0 = nao encontrado)

## Dev Notes

**Source Tree relevante:**
```
src/
├── app/(dashboard)/vendas/captura/
│   ├── page.tsx                       # Captura (foto ou anotacao)
│   └── [id]/page.tsx                  # Aprovacao da venda
├── app/api/v1/captures/
│   └── process-sale/route.ts          # Processar venda com IA
```

**Depende de:** Story 7.1 (infra IA), Story 7.2 (componente photo-capture), Story 4.1 (fluxo de venda)

**Prompt com contexto do catalogo:**
```
Voce e um assistente de vendas. O catalogo de produtos da loja e:
{lista de produtos com nome e preco}

Analise a entrada abaixo e monte uma lista de itens de venda:
{foto ou texto do usuario}

Para cada item, retorne:
- productId: ID do produto do catalogo (se identificado)
- productName: nome do produto
- quantity: quantidade
- unitPrice: preco unitario em centavos
- confidence: 0-1 (quao certo voce esta do match)

Se mencionado, identifique tambem:
- clientName: nome do cliente
- clientPhone: telefone

Retorne APENAS JSON.
```

**CRITICO - Tamanho do catalogo no prompt:**
- Limitar a 200 produtos no prompt (os mais vendidos)
- Se tenant tem mais, usar busca semantica
- Custo do prompt aumenta com catalogo grande

**CRITICO - Anotacao por texto:**
- Aceitar linguagem natural coloquial ("3 camiseta P branca pro Joao")
- Aceitar abreviacoes comuns ("cx" = caixa, "pct" = pacote, "un" = unidade)
- Interpretar "pro Joao" como clientName = "Joao"

### Testing

- **Localizacao:** `tests/unit/modules/capture/`
- **Framework:** Vitest
- **Testes necessarios:**
  - matchProducts: match exato por nome
  - matchProducts: match parcial (ILIKE)
  - matchProducts: retorna sugestoes quando nao encontra
  - Endpoint process-sale: inclui catalogo no prompt
  - Tela aprovacao: exibe itens pre-preenchidos com opcao de editar

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-09 | 1.0 | Criacao inicial da story | Sarah (PO) |

## Dev Agent Record
*A ser preenchido durante implementacao*

## QA Results
*A ser preenchido pelo QA agent*
