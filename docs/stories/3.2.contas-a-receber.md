# Story 3.2: Contas a Receber

## Status: Ready for Review

## Story

**As a** usuario,
**I want** cadastrar o que tenho a receber com datas e clientes,
**so that** eu saiba quanto dinheiro vai entrar e possa cobrar em dia.

## Acceptance Criteria

1. Model ContaReceber no Prisma: id, tenantId, description, amount (centavos), dueDate (DateTime), receivedDate (DateTime?), status (PENDENTE/RECEBIDO/VENCIDO/CANCELADO), category, clientId (FK opcional para Cliente), notes, createdAt, updatedAt
2. Formulario progressivo: descricao (obrigatorio), valor (obrigatorio, input monetario R$), data de vencimento (obrigatorio), cliente (autocomplete opcional), categoria (select)
3. Categorias: Vendas, Servicos, Outros
4. Lista com filtros: status (todos/pendentes/vencidos/recebidos), periodo, cliente
5. Acao "Marcar como Recebido" com 1 toque (registra data de hoje)
6. Indicadores visuais: vencido em vermelho, vence em 3 dias em amarelo, futuro em cinza
7. Botoes placeholder "Cobrar via PIX" e "Lembrar via WhatsApp" (desabilitados, para Epics futuros)
8. RLS aplicado

## Tasks / Subtasks

- [x] Adicionar model ContaReceber ao Prisma schema (AC: 1, 8)
  - [x] Adicionar model `ContaReceber` em `prisma/schema.prisma` com campos: id (cuid), tenantId (String, FK para Tenant), description (String), amount (Int, centavos), dueDate (DateTime), receivedDate (DateTime?), status (String, default "PENDENTE"), category (String), clientId (String?), notes (String?), createdAt, updatedAt
  - [x] Adicionar relation opcional para Cliente (client)
  - [x] Adicionar relation `contasReceber ContaReceber[]` no model Tenant e no model Cliente
  - [x] Criar indices: `@@index([tenantId, status])`, `@@index([tenantId, dueDate])`
  - [x] `@@map("contas_receber")`
  - [x] Executar `npx prisma generate`
- [x] Criar Zod schemas de validacao (AC: 2, 3)
  - [x] Criar `src/modules/financeiro/conta-receber.schema.ts`
  - [x] `createContaReceberSchema`: description (min 2), amount (int positivo), dueDate (date string), category (enum: VENDAS, SERVICOS, OUTROS), clientId (string opcional), notes (opcional)
  - [x] `updateContaReceberSchema`: todos campos opcionais
  - [x] `listContaReceberQuerySchema`: search, page, pageSize, status (PENDENTE/RECEBIDO/VENCIDO/CANCELADO, opcional), clientId (opcional), startDate, endDate
- [x] Criar service de contas a receber (AC: 1, 5, 8)
  - [x] Criar `src/modules/financeiro/conta-receber.service.ts`
  - [x] Funcao `createContaReceber(data)`: cria conta com status PENDENTE
  - [x] Funcao `listContasReceber(query)`: lista com filtros por status, cliente, periodo, busca por description, paginacao
  - [x] Funcao `getContaReceber(id)`: busca por id com include client
  - [x] Funcao `updateContaReceber(id, data)`: atualiza campos
  - [x] Funcao `markAsReceived(id)`: seta status=RECEBIDO, receivedDate=now
  - [x] Funcao `cancelContaReceber(id)`: seta status=CANCELADO
- [x] Criar API routes REST (AC: 1, 4, 5, 8)
  - [x] Criar `src/app/api/v1/contas-receber/route.ts` com GET (listar) e POST (criar)
  - [x] Criar `src/app/api/v1/contas-receber/[id]/route.ts` com GET, PATCH, DELETE
  - [x] Criar `src/app/api/v1/contas-receber/[id]/receber/route.ts` com POST (marcar como recebido)
  - [x] Todos endpoints usam `withTenantApi`
- [x] Criar pagina de lista de contas a receber (AC: 4, 6, 7)
  - [x] Criar `src/app/(dashboard)/financeiro/contas-receber/page.tsx` como Client Component
  - [x] Header com titulo "Contas a Receber" e botao "+ Nova Conta"
  - [x] Filtros: tabs de status (Todos/Pendentes/Vencidos/Recebidos), date range
  - [x] Campo de busca com debounce
  - [x] Lista em cards com: descricao, valor formatado, data vencimento, cliente nome, status badge colorido
  - [x] Cores de status: vermelho (VENCIDO), amarelo (vence em 3 dias), cinza (futuro), verde (RECEBIDO)
  - [x] Botao "Receber" visivel em contas pendentes/vencidas
  - [x] Botoes placeholder: "Cobrar PIX" e "Lembrar WhatsApp" (disabled, com tooltip "Em breve")
  - [x] Totalizador: soma das contas pendentes/vencidas no topo
  - [x] Paginacao, empty state, loading skeleton
- [x] Criar formulario de nova conta a receber (AC: 2, 3)
  - [x] Criar `src/app/(dashboard)/financeiro/contas-receber/novo/page.tsx` como Client Component
  - [x] Campos: descricao, valor (input monetario), data vencimento (date), cliente (autocomplete buscando em /api/v1/clientes), categoria (select: Vendas/Servicos/Outros)
  - [x] Secao expansivel "Detalhes": notas
  - [x] Botoes "Salvar" e "Cancelar"
  - [x] Redirect para lista apos salvar com toast
- [x] Criar tela de detalhe da conta a receber (AC: 5, 6, 7)
  - [x] Criar `src/app/(dashboard)/financeiro/contas-receber/[id]/page.tsx` como Client Component
  - [x] Exibir todos os campos com valor e data formatados
  - [x] Edicao inline dos campos
  - [x] Botao "Marcar como Recebido" com confirmacao
  - [x] Botao "Cancelar Conta" com dialog de confirmacao
  - [x] Botoes placeholder "Cobrar via PIX" e "Lembrar via WhatsApp" (disabled)

## Dev Notes

**Source Tree relevante:**
```
src/
├── app/(dashboard)/financeiro/contas-receber/
│   ├── page.tsx                  # Lista de contas a receber
│   ├── novo/page.tsx             # Formulario nova conta
│   └── [id]/page.tsx             # Detalhe da conta
├── app/api/v1/contas-receber/
│   ├── route.ts                  # GET + POST
│   ├── [id]/route.ts             # GET + PATCH + DELETE
│   └── [id]/receber/route.ts     # POST mark as received
└── modules/financeiro/
    ├── conta-receber.service.ts  # Business logic
    └── conta-receber.schema.ts   # Zod schemas
```

**Depende de:** Story 2.1 (Clientes - autocomplete no formulario), Story 2.3 (formatCurrency/parseCurrency), Story 3.1 (padrao de contas financeiras)

**CRITICO - Valores monetarios em centavos:**
- Mesmo padrao de Story 3.1
- Usar `formatCurrency` e `parseCurrency` de `src/lib/formatters.ts`

**Logica de vencimento:**
- Mesmo padrao de Story 3.1
- VENCIDO: dueDate < hoje e status == PENDENTE
- Alerta amarelo: dueDate <= hoje + 3 dias e status == PENDENTE

**Placeholders para Epics futuros:**
- "Cobrar via PIX": Epic 4 (Vendas) implementara Mercado Pago PIX
- "Lembrar via WhatsApp": Epic 6 (Integracao WhatsApp)
- Botoes devem existir mas estar desabilitados com tooltip "Em breve"

**Coding Standards:**
- Services: `conta-receber.service.ts`
- API routes: `/api/v1/contas-receber`
- Schemas: `createContaReceberSchema`

### Testing

- **Localizacao:** `tests/unit/modules/financeiro/`
- **Framework:** Vitest
- **Testes necessarios:**
  - `createContaReceberSchema` valida campos obrigatorios e rejeita amount negativo
  - `createContaReceberSchema` valida categorias (VENDAS/SERVICOS/OUTROS)
  - Service `createContaReceber` cria com status PENDENTE
  - Service `markAsReceived` seta status RECEBIDO e receivedDate
  - Service `listContasReceber` filtra por status e periodo
  - Service `cancelContaReceber` seta status CANCELADO
- **Mocks:** Mock do `prisma` para testes de service

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-07 | 1.0 | Criacao inicial da story | Sarah (PO) |
| 2026-02-07 | 1.1 | Implementacao completa | James (Dev) |

## Dev Agent Record

### Agent Model Used
Claude Opus 4.6 (via Claude Code)

### Debug Log References
- No issues encountered. Same patterns as Story 3.1.

### Completion Notes List
- ContaReceber Prisma model with status (PENDENTE/RECEBIDO/VENCIDO/CANCELADO), amount in centavos, optional Cliente relation
- 3 categories: Vendas, Servicos, Outros
- Service with markAsReceived (sets status + receivedDate) and cancel
- List page mirrors ContasPagar pattern: status tabs, search, pending total card
- Detail page with PIX/WhatsApp placeholder buttons (disabled with "Em breve" tooltip) for future Epics
- Client autocomplete in form
- 13 new tests (8 schema + 5 service), 165 total passing
- No new dependencies

### File List
- `prisma/schema.prisma` (modified - added ContaReceber model + Tenant/Cliente relations)
- `src/modules/financeiro/conta-receber.schema.ts` (new - Zod schemas)
- `src/modules/financeiro/conta-receber.service.ts` (new - CRUD + markAsReceived + cancel)
- `src/app/api/v1/contas-receber/route.ts` (new - GET + POST)
- `src/app/api/v1/contas-receber/[id]/route.ts` (new - GET + PATCH + DELETE)
- `src/app/api/v1/contas-receber/[id]/receber/route.ts` (new - POST mark as received)
- `src/app/(dashboard)/financeiro/contas-receber/page.tsx` (new - list with status tabs)
- `src/app/(dashboard)/financeiro/contas-receber/novo/page.tsx` (new - form with client autocomplete)
- `src/app/(dashboard)/financeiro/contas-receber/[id]/page.tsx` (new - detail with PIX/WhatsApp placeholders)
- `tests/unit/modules/financeiro/conta-receber-schema.test.ts` (new - 8 tests)
- `tests/unit/modules/financeiro/conta-receber-service.test.ts` (new - 5 tests)

## QA Results
*A ser preenchido pelo QA agent*
