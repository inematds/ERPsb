# Story 3.2: Contas a Receber

## Status: Draft

## Story

**As a** usuario,
**I want** cadastrar o que tenho a receber com datas e clientes,
**so that** eu saiba quanto dinheiro vai entrar e possa cobrar em dia.

## Acceptance Criteria

1. Model ContaReceber no Prisma: id, tenantId, description, amount (centavos), dueDate (DateTime), receivedDate (DateTime?), status (PENDENTE/RECEBIDO/VENCIDO/CANCELADO), category, clientId (FK opcional para Cliente), notes, createdAt, updatedAt
2. Formulario progressivo: descricao (obrigatorio), valor (obrigatorio, input monetario R$), data de vencimento (obrigatorio), cliente (autocomplete opcional), categoria (select)
3. Categorias: Vendas, Servicos, Outros
4. Lista com filtros: status (todos/pendentes/vencidos/recebidos), periodo, cliente
5. Acao "Marcar como Recebido" com 1 toque (registra data de hoje)
6. Indicadores visuais: vencido em vermelho, vence em 3 dias em amarelo, futuro em cinza
7. Botoes placeholder "Cobrar via PIX" e "Lembrar via WhatsApp" (desabilitados, para Epics futuros)
8. RLS aplicado

## Tasks / Subtasks

- [ ] Adicionar model ContaReceber ao Prisma schema (AC: 1, 8)
  - [ ] Adicionar model `ContaReceber` em `prisma/schema.prisma` com campos: id (cuid), tenantId (String, FK para Tenant), description (String), amount (Int, centavos), dueDate (DateTime), receivedDate (DateTime?), status (String, default "PENDENTE"), category (String), clientId (String?), notes (String?), createdAt, updatedAt
  - [ ] Adicionar relation opcional para Cliente (client)
  - [ ] Adicionar relation `contasReceber ContaReceber[]` no model Tenant e no model Cliente
  - [ ] Criar indices: `@@index([tenantId, status])`, `@@index([tenantId, dueDate])`
  - [ ] `@@map("contas_receber")`
  - [ ] Executar `npx prisma generate`
- [ ] Criar Zod schemas de validacao (AC: 2, 3)
  - [ ] Criar `src/modules/financeiro/conta-receber.schema.ts`
  - [ ] `createContaReceberSchema`: description (min 2), amount (int positivo), dueDate (date string), category (enum: VENDAS, SERVICOS, OUTROS), clientId (string opcional), notes (opcional)
  - [ ] `updateContaReceberSchema`: todos campos opcionais
  - [ ] `listContaReceberQuerySchema`: search, page, pageSize, status (PENDENTE/RECEBIDO/VENCIDO/CANCELADO, opcional), clientId (opcional), startDate, endDate
- [ ] Criar service de contas a receber (AC: 1, 5, 8)
  - [ ] Criar `src/modules/financeiro/conta-receber.service.ts`
  - [ ] Funcao `createContaReceber(data)`: cria conta com status PENDENTE
  - [ ] Funcao `listContasReceber(query)`: lista com filtros por status, cliente, periodo, busca por description, paginacao
  - [ ] Funcao `getContaReceber(id)`: busca por id com include client
  - [ ] Funcao `updateContaReceber(id, data)`: atualiza campos
  - [ ] Funcao `markAsReceived(id)`: seta status=RECEBIDO, receivedDate=now
  - [ ] Funcao `cancelContaReceber(id)`: seta status=CANCELADO
- [ ] Criar API routes REST (AC: 1, 4, 5, 8)
  - [ ] Criar `src/app/api/v1/contas-receber/route.ts` com GET (listar) e POST (criar)
  - [ ] Criar `src/app/api/v1/contas-receber/[id]/route.ts` com GET, PATCH, DELETE
  - [ ] Criar `src/app/api/v1/contas-receber/[id]/receber/route.ts` com POST (marcar como recebido)
  - [ ] Todos endpoints usam `withTenantApi`
- [ ] Criar pagina de lista de contas a receber (AC: 4, 6, 7)
  - [ ] Criar `src/app/(dashboard)/financeiro/contas-receber/page.tsx` como Client Component
  - [ ] Header com titulo "Contas a Receber" e botao "+ Nova Conta"
  - [ ] Filtros: tabs de status (Todos/Pendentes/Vencidos/Recebidos), date range
  - [ ] Campo de busca com debounce
  - [ ] Lista em cards com: descricao, valor formatado, data vencimento, cliente nome, status badge colorido
  - [ ] Cores de status: vermelho (VENCIDO), amarelo (vence em 3 dias), cinza (futuro), verde (RECEBIDO)
  - [ ] Botao "Receber" visivel em contas pendentes/vencidas
  - [ ] Botoes placeholder: "Cobrar PIX" e "Lembrar WhatsApp" (disabled, com tooltip "Em breve")
  - [ ] Totalizador: soma das contas pendentes/vencidas no topo
  - [ ] Paginacao, empty state, loading skeleton
- [ ] Criar formulario de nova conta a receber (AC: 2, 3)
  - [ ] Criar `src/app/(dashboard)/financeiro/contas-receber/novo/page.tsx` como Client Component
  - [ ] Campos: descricao, valor (input monetario), data vencimento (date), cliente (autocomplete buscando em /api/v1/clientes), categoria (select: Vendas/Servicos/Outros)
  - [ ] Secao expansivel "Detalhes": notas
  - [ ] Botoes "Salvar" e "Cancelar"
  - [ ] Redirect para lista apos salvar com toast
- [ ] Criar tela de detalhe da conta a receber (AC: 5, 6, 7)
  - [ ] Criar `src/app/(dashboard)/financeiro/contas-receber/[id]/page.tsx` como Client Component
  - [ ] Exibir todos os campos com valor e data formatados
  - [ ] Edicao inline dos campos
  - [ ] Botao "Marcar como Recebido" com confirmacao
  - [ ] Botao "Cancelar Conta" com dialog de confirmacao
  - [ ] Botoes placeholder "Cobrar via PIX" e "Lembrar via WhatsApp" (disabled)

## Dev Notes

**Source Tree relevante:**
```
src/
├── app/(dashboard)/financeiro/contas-receber/
│   ├── page.tsx                  # Lista de contas a receber
│   ├── novo/page.tsx             # Formulario nova conta
│   └── [id]/page.tsx             # Detalhe da conta
├── app/api/v1/contas-receber/
│   ├── route.ts                  # GET + POST
│   ├── [id]/route.ts             # GET + PATCH + DELETE
│   └── [id]/receber/route.ts     # POST mark as received
└── modules/financeiro/
    ├── conta-receber.service.ts  # Business logic
    └── conta-receber.schema.ts   # Zod schemas
```

**Depende de:** Story 2.1 (Clientes - autocomplete no formulario), Story 2.3 (formatCurrency/parseCurrency), Story 3.1 (padrao de contas financeiras)

**CRITICO - Valores monetarios em centavos:**
- Mesmo padrao de Story 3.1
- Usar `formatCurrency` e `parseCurrency` de `src/lib/formatters.ts`

**Logica de vencimento:**
- Mesmo padrao de Story 3.1
- VENCIDO: dueDate < hoje e status == PENDENTE
- Alerta amarelo: dueDate <= hoje + 3 dias e status == PENDENTE

**Placeholders para Epics futuros:**
- "Cobrar via PIX": Epic 4 (Vendas) implementara Mercado Pago PIX
- "Lembrar via WhatsApp": Epic 6 (Integracao WhatsApp)
- Botoes devem existir mas estar desabilitados com tooltip "Em breve"

**Coding Standards:**
- Services: `conta-receber.service.ts`
- API routes: `/api/v1/contas-receber`
- Schemas: `createContaReceberSchema`

### Testing

- **Localizacao:** `tests/unit/modules/financeiro/`
- **Framework:** Vitest
- **Testes necessarios:**
  - `createContaReceberSchema` valida campos obrigatorios e rejeita amount negativo
  - `createContaReceberSchema` valida categorias (VENDAS/SERVICOS/OUTROS)
  - Service `createContaReceber` cria com status PENDENTE
  - Service `markAsReceived` seta status RECEBIDO e receivedDate
  - Service `listContasReceber` filtra por status e periodo
  - Service `cancelContaReceber` seta status CANCELADO
- **Mocks:** Mock do `prisma` para testes de service

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-07 | 1.0 | Criacao inicial da story | Sarah (PO) |

## Dev Agent Record

### Agent Model Used
*A ser preenchido pelo dev agent*

### Debug Log References
*A ser preenchido pelo dev agent*

### Completion Notes List
*A ser preenchido pelo dev agent*

### File List
*A ser preenchido pelo dev agent*

## QA Results
*A ser preenchido pelo QA agent*
