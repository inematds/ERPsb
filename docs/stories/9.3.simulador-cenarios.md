# Story 9.3: Simulador de Cenarios

## Status: Draft

## Story

**As a** usuario,
**I want** simular cenarios como "e se eu der 10% de desconto?" ou "e se o fornecedor subir 15%?",
**so that** eu tome decisoes informadas antes de mudar precos.

## Acceptance Criteria

1. Tela de simulacao em `/precificacao/simulador` com cenarios pre-definidos e personalizados
2. Cenarios pre-definidos:
   - "Dar X% de desconto em um produto" → nova margem
   - "Fornecedor subiu X% no custo" → nova margem com preco atual, ou novo preco sugerido
   - "Mudar forma de pagamento principal" → impacto da taxa
   - "Aumentar preco em X%" → nova margem
3. Para cada cenario, mostrar comparativo ANTES e DEPOIS:
   - Margem antes → margem depois
   - Lucro por unidade antes → depois
   - Lucro mensal estimado antes → depois (baseado em volume medio)
4. Simulacao em lote: "dar 5% de desconto em TODOS os produtos" → tabela com impacto por produto
5. Alerta quando cenario resulta em margem negativa: "ATENCAO: com esse desconto, voce perde R$ X por unidade"
6. Botao "Aplicar" que efetiva a mudanca de preco (com confirmacao)
7. Tambem acessivel pelo chat: "O que acontece se eu der 10% de desconto na Camiseta P?"

## Tasks / Subtasks

- [ ] Criar engine de simulacao (AC: 2, 3)
  - [ ] Adicionar em `src/modules/precificacao/pricing.engine.ts`:
  - [ ] Funcao simularDesconto(productId, percentual): calcula nova margem
  - [ ] Funcao simularAumentoCusto(productId, percentual): calcula nova margem ou novo preco
  - [ ] Funcao simularMudancaTaxa(productId, novaTaxa): calcula nova margem
  - [ ] Funcao simularAumentoPreco(productId, percentual): calcula nova margem
  - [ ] Todas retornam: { antes: PricingResult, depois: PricingResult, diff: {...} }
- [ ] Simulacao em lote (AC: 4)
  - [ ] Funcao simularEmLote(tenantId, tipo, percentual): aplica cenario a todos os produtos
  - [ ] Retorna tabela: [{ produto, margemAntes, margemDepois, lucroAntes, lucroDepois }]
  - [ ] Totalizador: impacto total mensal
- [ ] Criar endpoint de simulacao (AC: 2, 4)
  - [ ] Criar `src/app/api/v1/precificacao/simular/route.ts` com POST
  - [ ] Recebe `{ productId?, type, value }` (productId opcional para lote)
  - [ ] Retorna comparativo antes/depois
- [ ] Criar tela do simulador (AC: 1-6)
  - [ ] Criar `src/app/(dashboard)/precificacao/simulador/page.tsx` como Client Component
  - [ ] Cards de cenarios pre-definidos (clicaveis)
  - [ ] Ao clicar: select de produto + input de percentual
  - [ ] Resultado em cards comparativos (antes vs depois)
  - [ ] Semaforo na margem resultante
  - [ ] Alerta vermelho se margem negativa (AC: 5)
  - [ ] Botao "Aplicar mudanca" com dialog de confirmacao (AC: 6)
  - [ ] Tab "Simulacao em lote" com tabela de todos os produtos
- [ ] Integrar com chat (AC: 7)
  - [ ] Adicionar funcoes de simulacao nas chat-functions
  - [ ] IA interpreta "e se eu der 10% de desconto na Camiseta P?"
  - [ ] Retorna resultado formatado em texto

## Dev Notes

**Depende de:** Story 9.1 (pricing.engine), Story 9.2 (dados de margem)

**Cenarios compostos (futuro):**
- "Fornecedor subiu 10% E quero manter a margem" → qual o novo preco?
- "Quero margem de 30% em todos os produtos" → tabela de precos ajustados
- Para MVP, cenarios simples (1 variavel por vez)

**Simulacao de volume:**
- Usar media de vendas dos ultimos 3 meses como baseline
- "Se vender 20% mais com o desconto" → ponto de equilibrio
- Isso e avancado, pode ser v2.1

### Testing

- **Testes necessarios:**
  - simularDesconto: calcula nova margem corretamente
  - simularDesconto: alerta margem negativa
  - simularAumentoCusto: calcula novo preco para manter margem
  - simularEmLote: aplica a todos os produtos
  - simularEmLote: totaliza impacto mensal

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-09 | 1.0 | Criacao inicial da story | Sarah (PO) |

## Dev Agent Record
*A ser preenchido durante implementacao*

## QA Results
*A ser preenchido pelo QA agent*
