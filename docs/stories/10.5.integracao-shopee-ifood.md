# Story 10.5: Integracao Shopee e iFood

## Status: Draft

## Story

**As a** usuario que vende em multiplos marketplaces,
**I want** conectar Shopee e iFood ao ERPsb,
**so that** todas as minhas vendas online entrem automaticamente no sistema.

## Acceptance Criteria

1. Interface abstrata `MarketplaceAdapter` reutilizada por todos os marketplaces
2. Integracao Shopee com OAuth, sync de produtos, pedidos por webhook, sync de estoque
3. Integracao iFood com OAuth, sync de cardapio, pedidos em tempo real, gestao de status
4. Tela de integracao unificada: todos os marketplaces conectados em um lugar
5. Dashboard: vendas por canal (Presencial, Catalogo Online, Mercado Livre, Shopee, iFood)
6. Alertas de conflito de estoque entre canais

## Tasks / Subtasks

- [ ] Criar interface abstrata MarketplaceAdapter (AC: 1)
  - [ ] Interface TypeScript com metodos:
    - authenticate(code): salvar tokens
    - getProducts(): listar produtos do marketplace
    - createProduct(data): publicar produto
    - updateStock(productId, quantity): atualizar estoque
    - updatePrice(productId, price): atualizar preco
    - getOrders(since): buscar pedidos
    - processWebhook(payload): processar notificacao
  - [ ] Refatorar mercadolivre.client.ts para implementar a interface
- [ ] Criar adapter Shopee (AC: 2)
  - [ ] `src/integrations/marketplaces/shopee.client.ts`
  - [ ] OAuth 2.0 (Partner API)
  - [ ] Sync de produtos, estoque, precos
  - [ ] Webhook de pedidos
  - [ ] Taxa Shopee: ~15-20% (comissao + frete + Ads)
- [ ] Criar adapter iFood (AC: 3)
  - [ ] `src/integrations/marketplaces/ifood.client.ts`
  - [ ] OAuth 2.0 (iFood Partner Portal)
  - [ ] Sync de cardapio (produtos = itens do menu)
  - [ ] Pedidos em tempo real (polling ou webhook)
  - [ ] Gestao de status: CONFIRMADO → PREPARANDO → PRONTO → ENTREGUE
  - [ ] Taxa iFood: ~12-27% (comissao + entrega)
  - [ ] Disponibilidade: pausar loja no iFood via API
- [ ] Tela de integracoes unificada (AC: 4)
  - [ ] Modificar `src/app/(dashboard)/configuracoes/integracoes/page.tsx`
  - [ ] Cards: Mercado Livre, Shopee, iFood (cada um com status e botao conectar)
  - [ ] Badge: "Conectado" / "Desconectado" / "Erro"
- [ ] Dashboard multi-canal (AC: 5)
  - [ ] Adicionar valores SHOPEE, IFOOD ao campo `source` do model Venda
  - [ ] Grafico de barras empilhadas por canal
  - [ ] Tabela comparativa: receita, qtd vendas, ticket medio por canal
  - [ ] % de participacao de cada canal
- [ ] Alertas de conflito (AC: 6)
  - [ ] Ao detectar estoque insuficiente para atender todos os canais: alerta
  - [ ] Sugestao: "Produto X tem 3 unidades mas esta anunciado em 3 canais"
  - [ ] Opcao de pausar produto em canais especificos

## Dev Notes

**Depende de:** Story 10.4 (Mercado Livre - define padrao de integracao)

**Shopee API:**
- Documentacao: https://open.shopee.com
- OAuth 2.0 (Partner level)
- Webhook para pedidos
- Rate limit: 20 req/s

**iFood API:**
- Documentacao: https://developer.ifood.com.br
- OAuth 2.0
- Polling para pedidos (webhook limitado)
- Requer gestao ativa de status (confirmar, preparar, pronto)
- Especifico para alimentacao: cardapio com complementos, tamanhos

**Prioridade de implementacao:**
1. Mercado Livre (maior base, Story 10.4)
2. Shopee (crescimento rapido no Brasil)
3. iFood (especifico para alimentacao)
- Implementar sob demanda baseado nos usuarios ativos

### Testing

- **Testes necessarios:**
  - MarketplaceAdapter: interface implementada por todos os adapters
  - Shopee: OAuth + sync produtos + webhook pedidos
  - iFood: OAuth + sync cardapio + gestao de status
  - Multi-canal: dashboard agrega vendas de todos os canais
  - Conflito: detecta estoque insuficiente para multiplos canais

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-09 | 1.0 | Criacao inicial da story | Sarah (PO) |

## Dev Agent Record
*A ser preenchido durante implementacao*

## QA Results
*A ser preenchido pelo QA agent*
