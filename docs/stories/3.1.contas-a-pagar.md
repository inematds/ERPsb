# Story 3.1: Contas a Pagar

## Status: Ready for Review

## Story

**As a** usuario,
**I want** cadastrar minhas contas a pagar com vencimento e categorias,
**so that** eu nunca esqueca de pagar uma conta e saiba exatamente quanto devo.

## Acceptance Criteria

1. Model ContaPagar no Prisma: id, tenantId, description, amount (centavos), dueDate (DateTime), paidDate (DateTime?), status (PENDENTE/PAGO/VENCIDO/CANCELADO), category, supplierId (FK opcional para Fornecedor), notes, recurrent (boolean), recurrenceType (MENSAL/SEMANAL), createdAt, updatedAt
2. Formulario progressivo: descricao (obrigatorio), valor (obrigatorio, input monetario R$), data de vencimento (obrigatorio), fornecedor (autocomplete opcional), categoria (select)
3. Categorias pre-definidas: Aluguel, Funcionarios, Fornecedores, Impostos, Marketing, Servicos, Outros
4. Lista com filtros: status (todos/pendentes/vencidos/pagos), periodo, categoria
5. Acao "Marcar como Pago" com 1 toque (registra data de hoje)
6. Indicadores visuais: vencido em vermelho, vence em 3 dias em amarelo, futuro em cinza
7. Contas recorrentes: ao marcar como pago, gera automaticamente a proxima parcela
8. RLS aplicado

## Tasks / Subtasks

- [x] Adicionar model ContaPagar ao Prisma schema (AC: 1, 8)
  - [x] Adicionar model `ContaPagar` em `prisma/schema.prisma` com campos: id (cuid), tenantId (String, FK para Tenant), description (String), amount (Int, centavos), dueDate (DateTime), paidDate (DateTime?), status (String, default "PENDENTE"), category (String), supplierId (String?), notes (String?), recurrent (Boolean, default false), recurrenceType (String?), createdAt, updatedAt
  - [x] Adicionar relation opcional para Fornecedor (supplier)
  - [x] Adicionar relation `contasPagar ContaPagar[]` no model Tenant e no model Fornecedor
  - [x] Criar indices: `@@index([tenantId, status])`, `@@index([tenantId, dueDate])`
  - [x] `@@map("contas_pagar")`
  - [x] Executar `npx prisma generate`
- [x] Criar Zod schemas de validacao (AC: 2, 3)
  - [x] Criar `src/modules/financeiro/conta-pagar.schema.ts`
  - [x] `createContaPagarSchema`: description (min 2), amount (int positivo), dueDate (date string), category (enum das categorias), supplierId (string opcional), notes (opcional), recurrent (boolean, default false), recurrenceType (enum MENSAL/SEMANAL, opcional, obrigatorio se recurrent=true)
  - [x] `updateContaPagarSchema`: todos campos opcionais
  - [x] `listContaPagarQuerySchema`: search, page, pageSize, status (PENDENTE/PAGO/VENCIDO/CANCELADO, opcional), category (opcional), startDate, endDate (filtro de periodo)
- [x] Criar service de contas a pagar (AC: 1, 5, 7, 8)
  - [x] Criar `src/modules/financeiro/conta-pagar.service.ts`
  - [x] Funcao `createContaPagar(data)`: cria conta com status PENDENTE
  - [x] Funcao `listContasPagar(query)`: lista com filtros por status, categoria, periodo (dueDate between), busca por description, paginacao
  - [x] Funcao `getContaPagar(id)`: busca por id com include supplier
  - [x] Funcao `updateContaPagar(id, data)`: atualiza campos
  - [x] Funcao `markAsPaid(id)`: seta status=PAGO, paidDate=now; se recurrent, cria proxima parcela (dueDate + recurrenceType)
  - [x] Funcao `cancelContaPagar(id)`: seta status=CANCELADO
  - [x] Funcao `getOverdueContas()`: retorna contas com dueDate < hoje e status=PENDENTE (para atualizar status para VENCIDO)
- [x] Criar API routes REST (AC: 1, 4, 5, 8)
  - [x] Criar `src/app/api/v1/contas-pagar/route.ts` com GET (listar) e POST (criar)
  - [x] Criar `src/app/api/v1/contas-pagar/[id]/route.ts` com GET, PATCH, DELETE
  - [x] Criar `src/app/api/v1/contas-pagar/[id]/pagar/route.ts` com POST (marcar como pago)
  - [x] Todos endpoints usam `withTenantApi`
- [x] Criar pagina de lista de contas a pagar (AC: 4, 6)
  - [x] Criar `src/app/(dashboard)/financeiro/contas-pagar/page.tsx` como Client Component
  - [x] Header com titulo "Contas a Pagar" e botao "+ Nova Conta"
  - [x] Filtros: tabs de status (Todos/Pendentes/Vencidos/Pagos), select de categoria, date range
  - [x] Campo de busca com debounce para descricao
  - [x] Lista em cards com: descricao, valor formatado (R$), data vencimento, categoria badge, status badge colorido
  - [x] Cores de status: vermelho (VENCIDO), amarelo (vence em 3 dias), cinza (futuro), verde (PAGO)
  - [x] Botao "Pagar" visivel em contas pendentes/vencidas
  - [x] Paginacao com contagem total
  - [x] Totalizador: soma das contas pendentes/vencidas exibida no topo
  - [x] Empty state
  - [x] Loading skeleton
- [x] Criar formulario de nova conta a pagar (AC: 2, 3, 7)
  - [x] Criar `src/app/(dashboard)/financeiro/contas-pagar/novo/page.tsx` como Client Component
  - [x] Campos: descricao, valor (input monetario R$), data vencimento (date picker), categoria (select com opcoes pre-definidas), fornecedor (autocomplete buscando em /api/v1/fornecedores)
  - [x] Secao expansivel "Detalhes": notas, toggle recorrente, tipo recorrencia (mensal/semanal)
  - [x] Ao trocar recorrente para true, mostrar select de tipo
  - [x] Botoes "Salvar" e "Cancelar"
  - [x] Redirect para lista apos salvar com toast
- [x] Criar tela de detalhe da conta a pagar (AC: 5, 6)
  - [x] Criar `src/app/(dashboard)/financeiro/contas-pagar/[id]/page.tsx` como Client Component
  - [x] Exibir todos os campos com valor formatado e data formatada (dd/MM/yyyy)
  - [x] Edicao inline dos campos
  - [x] Botao "Marcar como Pago" com confirmacao
  - [x] Botao "Cancelar Conta" com dialog de confirmacao
  - [x] Historico de parcelas (se recorrente) - placeholder

## Dev Notes

**Source Tree relevante:**
```
src/
├── app/(dashboard)/financeiro/contas-pagar/
│   ├── page.tsx                # Lista de contas a pagar
│   ├── novo/page.tsx           # Formulario nova conta
│   └── [id]/page.tsx           # Detalhe da conta
├── app/api/v1/contas-pagar/
│   ├── route.ts                # GET + POST
│   ├── [id]/route.ts           # GET + PATCH + DELETE
│   └── [id]/pagar/route.ts     # POST mark as paid
└── modules/financeiro/
    ├── conta-pagar.service.ts  # Business logic
    └── conta-pagar.schema.ts   # Zod schemas
```

**Depende de:** Story 2.2 (Fornecedores - autocomplete no formulario), Story 2.3 (formatCurrency/parseCurrency)

**CRITICO - Valores monetarios em centavos:**
- `amount` armazenado como `Int` (centavos)
- R$ 150,00 = 15000 centavos no banco
- Usar `formatCurrency` e `parseCurrency` de `src/lib/formatters.ts`

**Logica de vencimento:**
- VENCIDO: dueDate < hoje e status == PENDENTE
- Alerta amarelo: dueDate <= hoje + 3 dias e status == PENDENTE
- A atualizacao de status PENDENTE -> VENCIDO pode ser feita no list service (on-read)

**Logica de recorrencia:**
- Ao marcar como PAGO, se recurrent==true: cria nova ContaPagar com mesmos dados + dueDate incrementada
- MENSAL: adiciona 1 mes a dueDate
- SEMANAL: adiciona 7 dias a dueDate
- Nova conta criada com status PENDENTE

**Datas:**
- Armazenar dueDate como DateTime no UTC
- Exibir com `date-fns` format 'dd/MM/yyyy'
- Input aceita formato brasileiro

**Coding Standards:**
- Services: `conta-pagar.service.ts`
- API routes: `/api/v1/contas-pagar`
- Schemas: `createContaPagarSchema`
- Valores em centavos no service/API, formatados apenas na UI

### Testing

- **Localizacao:** `tests/unit/modules/financeiro/`
- **Framework:** Vitest
- **Testes necessarios:**
  - `createContaPagarSchema` valida campos obrigatorios e rejeita amount negativo
  - `createContaPagarSchema` exige recurrenceType quando recurrent=true
  - Service `createContaPagar` cria com status PENDENTE
  - Service `markAsPaid` seta status PAGO e paidDate
  - Service `markAsPaid` gera proxima parcela se recurrent (MENSAL e SEMANAL)
  - Service `listContasPagar` filtra por status, categoria e periodo
  - Service `cancelContaPagar` seta status CANCELADO
- **Mocks:** Mock do `prisma` para testes de service

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-07 | 1.0 | Criacao inicial da story | Sarah (PO) |
| 2026-02-07 | 1.1 | Implementacao completa | James (Dev) |

## Dev Agent Record

### Agent Model Used
Claude Opus 4.6 (via Claude Code)

### Debug Log References
- Date timezone issue: `new Date('2026-03-01')` creates UTC midnight, but `setMonth`/`setDate` use local timezone (BRT -03:00). Fixed by using `setUTCMonth`/`setUTCDate` for recurrence date arithmetic.

### Completion Notes List
- ContaPagar Prisma model with status (PENDENTE/PAGO/VENCIDO/CANCELADO), amount in centavos, optional Fornecedor relation
- 7 pre-defined categories: Aluguel, Funcionarios, Fornecedores, Impostos, Marketing, Servicos, Outros
- Zod schema with `.refine()` to enforce recurrenceType when recurrent=true
- Service with recurrence logic: markAsPaid creates next installment (MENSAL +1 month, SEMANAL +7 days) using UTC-safe date arithmetic
- Cancel = set status to CANCELADO (soft cancel)
- List page with status tabs (Todos/Pendentes/Vencidos/Pagos), search, pagination, pending total card
- Visual status indicators: red (vencido), yellow (vence em 3 dias), gray (futuro), green (pago)
- One-tap "Pagar" button on list cards with immediate feedback
- Detail page with inline editing, pay/cancel confirmation dialogs
- Form with supplier autocomplete, progressive details expansion (notes, recurrence)
- 21 new tests (12 schema + 9 service), 152 total passing
- No new dependencies

### File List
- `prisma/schema.prisma` (modified - added ContaPagar model + Tenant/Fornecedor relations)
- `src/modules/financeiro/conta-pagar.schema.ts` (new - Zod schemas with recurrence validation)
- `src/modules/financeiro/conta-pagar.service.ts` (new - CRUD + markAsPaid with recurrence + cancel)
- `src/app/api/v1/contas-pagar/route.ts` (new - GET + POST)
- `src/app/api/v1/contas-pagar/[id]/route.ts` (new - GET + PATCH + DELETE)
- `src/app/api/v1/contas-pagar/[id]/pagar/route.ts` (new - POST mark as paid)
- `src/app/(dashboard)/financeiro/contas-pagar/page.tsx` (new - list with status tabs and totals)
- `src/app/(dashboard)/financeiro/contas-pagar/novo/page.tsx` (new - progressive form with supplier autocomplete)
- `src/app/(dashboard)/financeiro/contas-pagar/[id]/page.tsx` (new - detail with inline edit and pay/cancel)
- `tests/unit/modules/financeiro/conta-pagar-schema.test.ts` (new - 12 tests)
- `tests/unit/modules/financeiro/conta-pagar-service.test.ts` (new - 9 tests)

## QA Results
*A ser preenchido pelo QA agent*
