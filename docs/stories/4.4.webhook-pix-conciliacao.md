# Story 4.4: Webhook PIX e Conciliacao Automatica

## Status: Ready for Review

## Story

**As a** usuario,
**I want** que o sistema detecte automaticamente quando um PIX for pago,
**so that** eu nao precise baixar manualmente cada recebimento.

## Acceptance Criteria

1. Endpoint webhook para receber notificacoes do Mercado Pago
2. Webhook valida assinatura do Mercado Pago
3. Ao receber pagamento: atualiza PixCharge e ContaReceber automaticamente
4. Notificacao para o usuario
5. Tratamento de falhas com retry
6. Log de notificacoes para auditoria
7. Endpoint de consulta manual de status (fallback)

## Tasks / Subtasks

- [x] Adicionar models WebhookLog e Notification ao Prisma schema (AC: 4, 6)
  - [x] Model `WebhookLog`: id, tenantId (nullable - webhook pode nao ter tenant), source (String: "mercadopago"), eventType (String), externalId (String?), payload (Json), status (String: "RECEIVED"/"PROCESSED"/"FAILED"), error (String?), createdAt
  - [x] Model `Notification`: id, tenantId (FK), type (String: "PIX_PAID"/"PIX_EXPIRED"), title (String), message (String), read (Boolean default false), metadata (Json?), createdAt
  - [x] Adicionar `notifications Notification[]` no model Tenant
  - [x] Indices: WebhookLog `@@index([source, externalId])`, Notification `@@index([tenantId, read])`
  - [x] Executar `npx prisma generate`
- [x] Criar webhook endpoint Mercado Pago (AC: 1, 2)
  - [x] Criar `src/app/api/webhooks/mercadopago/route.ts`
  - [x] POST handler: recebe notificacao, valida signature com HMAC-SHA256 (MERCADO_PAGO_WEBHOOK_SECRET), loga no WebhookLog, processa
  - [x] Retornar 200 imediatamente (Mercado Pago requer resposta rapida)
  - [x] Se secret nao configurado, aceitar sem validacao (dev mode)
- [x] Criar webhook handler/processor (AC: 3)
  - [x] Criar `src/integrations/pix/pix.webhook.ts`
  - [x] `processWebhookNotification(payload)`: identifica tipo (payment), busca PixCharge por externalId, chama checkPixStatus, cria Notification se status mudou
  - [x] Tratar erros gracefully (log + nao falhar webhook)
- [x] Criar service de notificacoes (AC: 4)
  - [x] Criar `src/modules/notificacoes/notification.service.ts`
  - [x] `createNotification(data)`: cria notificacao para tenant
  - [x] `listNotifications(tenantId, query)`: lista com filtro read/unread, paginacao
  - [x] `markAsRead(id)`: marca como lida
  - [x] `markAllAsRead(tenantId)`: marca todas como lidas
  - [x] `getUnreadCount(tenantId)`: conta nao lidas
- [x] Criar Zod schemas de notificacao
  - [x] Criar `src/modules/notificacoes/notification.schema.ts`
  - [x] `listNotificationsQuerySchema`: page, pageSize, read (boolean optional)
- [x] Criar API routes de notificacao (AC: 4)
  - [x] Criar `src/app/api/v1/notificacoes/route.ts` com GET (listar)
  - [x] Criar `src/app/api/v1/notificacoes/count/route.ts` com GET (unread count)
  - [x] Criar `src/app/api/v1/notificacoes/[id]/read/route.ts` com POST (marcar como lida)
  - [x] Criar `src/app/api/v1/notificacoes/read-all/route.ts` com POST (marcar todas como lidas)
  - [x] Todos com withTenantApi
- [x] Escrever testes (AC: all)
  - [x] `tests/unit/integrations/pix/pix-webhook.test.ts`: webhook handler tests
  - [x] `tests/unit/modules/notificacoes/notification-service.test.ts`: notification service tests
  - [x] `tests/unit/modules/notificacoes/notification-schema.test.ts`: schema tests

## Dev Notes

**Depende de:** Story 4.3 (PixCharge model + Mercado Pago client)

**Source Tree relevante:**
```
src/
├── integrations/pix/
│   └── pix.webhook.ts            # Webhook processor
├── modules/notificacoes/
│   ├── notification.service.ts   # Notification CRUD
│   └── notification.schema.ts    # Zod schemas
├── app/api/
│   ├── webhooks/mercadopago/
│   │   └── route.ts              # Webhook endpoint (no auth)
│   └── v1/notificacoes/
│       ├── route.ts              # GET list
│       ├── count/route.ts        # GET unread count
│       ├── [id]/read/route.ts    # POST mark read
│       └── read-all/route.ts     # POST mark all read
```

**CRITICO - Webhook sem auth tenant:**
- O webhook do Mercado Pago NAO passa pelo withTenantApi
- O tenantId eh descoberto via PixCharge.tenantId (busca por externalId)
- Validacao eh via HMAC signature

**CRITICO - Resposta rapida:**
- Mercado Pago espera resposta 200 em < 5s
- Processar sync no MVP (sem BullMQ - sera adicionado depois com Redis)
- Se der erro, logar e retornar 200 mesmo assim (MP nao deve re-enviar por erro nosso)

**Signature validation (HMAC-SHA256):**
- Mercado Pago envia headers: `x-signature`, `x-request-id`
- `x-signature` formato: `ts=TIMESTAMP,v1=HASH`
- Template para HMAC: `id:{data.id};request-id:{x-request-id};ts:{ts};`
- Comparar HASH com HMAC-SHA256(template, WEBHOOK_SECRET)

**Notification types:**
- `PIX_PAID`: "Pagamento PIX recebido - R$ X,XX de {cliente}"
- `PIX_EXPIRED`: "Cobranca PIX expirada - R$ X,XX"

**MVP sem BullMQ:**
- Processamento direto no webhook handler (sync)
- Retry manual via endpoint GET /api/v1/pix/[id]/status (ja existe da Story 4.3)
- BullMQ sera adicionado quando Redis/Upstash for configurado

### Testing

- **Localizacao:** `tests/unit/integrations/pix/` e `tests/unit/modules/notificacoes/`
- **Framework:** Vitest
- **Testes necessarios:**
  - Webhook: processWebhookNotification processa payment.updated
  - Webhook: processWebhookNotification cria notification quando PIX pago
  - Webhook: processWebhookNotification ignora evento desconhecido
  - Webhook: processWebhookNotification nao falha se PixCharge nao encontrada
  - Notification service: createNotification cria no banco
  - Notification service: listNotifications filtra por read
  - Notification service: markAsRead atualiza read=true
  - Notification service: getUnreadCount retorna count correto
  - Notification schema: listNotificationsQuerySchema defaults
  - Notification schema: page/pageSize coerce
- **Mocks:** Mock do `prisma`, mock do `checkPixStatus`

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-07 | 1.0 | Criacao inicial da story | Sarah (PO) |
| 2026-02-07 | 1.1 | Detalhamento completo das tasks | James (Dev) |
| 2026-02-07 | 1.2 | Implementacao completa - todas tasks concluidas | James (Dev) |

## Dev Agent Record

### Agent Model Used
Claude Opus 4.6 (claude-opus-4-6)

### Debug Log References
- Fix: `z.coerce.boolean()` coerces string 'false' to true. Changed to `z.enum(['true','false']).transform()` for correct query param parsing.
- Fix: TypeScript error comparing narrowed 'PENDING' with 'PAID' - removed redundant previousStatus check.

### Completion Notes List
- WebhookLog Prisma model: source, eventType, externalId, payload (Json), status RECEIVED/PROCESSED/FAILED, error
- Notification Prisma model: tenantId FK, type, title, message, read boolean, metadata Json
- notifications Notification[] added to Tenant model
- Webhook endpoint at /api/webhooks/mercadopago: validates HMAC-SHA256 signature (skips in dev mode), logs all webhooks, processes payment notifications, always returns 200
- pix.webhook.ts: processWebhookNotification finds PixCharge by externalId, calls checkPixStatus, creates PIX_PAID notification
- Notification service: createNotification, listNotifications (filter by read), markAsRead, markAllAsRead, getUnreadCount
- Notification schema: listNotificationsQuerySchema with string-to-boolean transform for read param
- API routes: GET /notificacoes, GET /notificacoes/count, POST /notificacoes/[id]/read, POST /notificacoes/read-all
- MVP approach: sync webhook processing (no BullMQ/Redis needed), manual status check fallback via existing /pix/[id]/status endpoint
- 14 new tests (4 webhook + 6 notification service + 4 notification schema), 252 total passing
- TypeScript clean

### File List
- `prisma/schema.prisma` (modified - added WebhookLog, Notification models, notifications[] on Tenant)
- `src/integrations/pix/pix.webhook.ts` (new - webhook notification processor)
- `src/modules/notificacoes/notification.service.ts` (new - notification CRUD)
- `src/modules/notificacoes/notification.schema.ts` (new - Zod schemas)
- `src/app/api/webhooks/mercadopago/route.ts` (new - webhook endpoint with HMAC validation)
- `src/app/api/v1/notificacoes/route.ts` (new - GET list notifications)
- `src/app/api/v1/notificacoes/count/route.ts` (new - GET unread count)
- `src/app/api/v1/notificacoes/[id]/read/route.ts` (new - POST mark as read)
- `src/app/api/v1/notificacoes/read-all/route.ts` (new - POST mark all as read)
- `tests/unit/integrations/pix/pix-webhook.test.ts` (new - 4 tests)
- `tests/unit/modules/notificacoes/notification-service.test.ts` (new - 6 tests)
- `tests/unit/modules/notificacoes/notification-schema.test.ts` (new - 4 tests)

## QA Results
*A ser preenchido pelo QA agent*
