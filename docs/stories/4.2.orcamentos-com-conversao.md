# Story 4.2: Orcamentos com Conversao

## Status: Draft

## Story

**As a** usuario,
**I want** criar orcamentos e converte-los em vendas com 1 clique,
**so that** eu possa negociar com clientes sem perder o registro.

## Acceptance Criteria

1. Model Orcamento no Prisma: id, tenantId, clientId, items (Json array), subtotal, discount, total, validUntil (DateTime), status (PENDENTE/APROVADO/RECUSADO/CONVERTIDO/EXPIRADO), notes, saleId (FK quando convertido), createdAt, updatedAt
2. Formulario de orcamento: mesma UX de venda mas com data de validade
3. Lista de orcamentos com filtros (status, periodo, cliente)
4. Botao "Converter em Venda" que cria venda a partir dos dados do orcamento
5. Orcamento convertido muda status para CONVERTIDO com link para a venda
6. Orcamentos vencidos mudam automaticamente para status EXPIRADO
7. Opcao de duplicar orcamento existente

## Tasks / Subtasks

- [ ] Adicionar model Orcamento ao Prisma schema (AC: 1)
  - [ ] Adicionar model `Orcamento` em `prisma/schema.prisma`
  - [ ] Relations para Tenant, Cliente, Venda (optional saleId)
  - [ ] Indices: `@@index([tenantId, status])`, `@@index([tenantId, createdAt])`
  - [ ] Executar `npx prisma generate`
- [ ] Criar Zod schemas (AC: 1, 2)
  - [ ] Criar `src/modules/vendas/orcamento.schema.ts`
  - [ ] `createOrcamentoSchema`: clientId (obrigatorio), items (array min 1), discount, validUntil (date), notes
  - [ ] `listOrcamentosQuerySchema`: search, page, pageSize, status, clientId, startDate, endDate
- [ ] Criar service de orcamentos (AC: 1, 4, 5, 6)
  - [ ] Criar `src/modules/vendas/orcamento.service.ts`
  - [ ] `createOrcamento`, `listOrcamentos`, `getOrcamento`, `updateOrcamento`
  - [ ] `convertToVenda(id)`: cria Venda a partir do orcamento, seta status CONVERTIDO, vincula saleId
  - [ ] `duplicateOrcamento(id)`: copia dados do orcamento existente
  - [ ] `markExpired()`: atualiza orcamentos com validUntil < hoje para EXPIRADO
- [ ] Criar API routes (AC: 1, 3, 4)
  - [ ] CRUD routes + converter + duplicar
- [ ] Criar paginas UI (AC: 2, 3, 7)
  - [ ] Lista de orcamentos, formulario novo, detalhe com acao converter

## Dev Notes

**Depende de:** Story 4.1 (Venda - para conversao)

### Testing

- **Localizacao:** `tests/unit/modules/vendas/`
- **Framework:** Vitest
- **Testes:** createOrcamento, convertToVenda (cria venda + seta CONVERTIDO), duplicateOrcamento, markExpired

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-07 | 1.0 | Criacao inicial da story | Sarah (PO) |

## Dev Agent Record

### Agent Model Used
*A ser preenchido*

### Debug Log References
*A ser preenchido*

### Completion Notes List
*A ser preenchido*

### File List
*A ser preenchido*

## QA Results
*A ser preenchido pelo QA agent*
