# Story 4.2: Orcamentos com Conversao

## Status: Ready for Review

## Story

**As a** usuario,
**I want** criar orcamentos e converte-los em vendas com 1 clique,
**so that** eu possa negociar com clientes sem perder o registro.

## Acceptance Criteria

1. Model Orcamento no Prisma: id, tenantId, clientId, items (Json array), subtotal, discount, total, validUntil (DateTime), status (PENDENTE/APROVADO/RECUSADO/CONVERTIDO/EXPIRADO), notes, saleId (FK quando convertido), createdAt, updatedAt
2. Formulario de orcamento: mesma UX de venda mas com data de validade
3. Lista de orcamentos com filtros (status, periodo, cliente)
4. Botao "Converter em Venda" que cria venda a partir dos dados do orcamento
5. Orcamento convertido muda status para CONVERTIDO com link para a venda
6. Orcamentos vencidos mudam automaticamente para status EXPIRADO
7. Opcao de duplicar orcamento existente

## Tasks / Subtasks

- [x] Adicionar model Orcamento ao Prisma schema (AC: 1)
  - [x] Adicionar model `Orcamento` em `prisma/schema.prisma` com campos: id (cuid), tenantId (String, FK Tenant), number (Int?), clientId (String, FK Cliente), items (Json), subtotal (Int), discount (Int, default 0), total (Int), validUntil (DateTime), status (String, default "PENDENTE"), notes (String?), saleId (String?, FK Venda), createdAt, updatedAt
  - [x] Relations para Tenant, Cliente, Venda (optional saleId)
  - [x] Adicionar `orcamentos Orcamento[]` no model Tenant, Cliente, Venda
  - [x] Indices: `@@index([tenantId, status])`, `@@index([tenantId, createdAt])`
  - [x] `@@map("orcamentos")`
  - [x] Executar `npx prisma generate`
- [x] Criar Zod schemas de validacao (AC: 1, 2)
  - [x] Criar `src/modules/vendas/orcamento.schema.ts`
  - [x] `createOrcamentoSchema`: clientId (obrigatorio), items (array min 1 de vendaItemSchema), discount (int >= 0, default 0), validUntil (string ISO date), notes (opcional)
  - [x] `updateOrcamentoSchema`: mesmos campos que create, mas todos opcionais
  - [x] `listOrcamentosQuerySchema`: search, page, pageSize, status, clientId, startDate, endDate
- [x] Criar service de orcamentos (AC: 1, 4, 5, 6, 7)
  - [x] Criar `src/modules/vendas/orcamento.service.ts`
  - [x] `createOrcamento(data)`: calcula subtotal/total a partir de items
  - [x] `listOrcamentos(query)`: lista com filtros por status, cliente, periodo, busca, paginacao
  - [x] `getOrcamento(id)`: busca por id com include client, sale
  - [x] `updateOrcamento(id, data)`: atualiza campos, recalcula totais se items mudarem
  - [x] `convertToVenda(id)`: cria Venda a partir do orcamento, confirma a venda, seta status CONVERTIDO, vincula saleId
  - [x] `duplicateOrcamento(id)`: copia dados do orcamento existente como novo PENDENTE
  - [x] `markExpired()`: atualiza orcamentos PENDENTE com validUntil < hoje para EXPIRADO
- [x] Criar API routes REST (AC: 1, 3, 4, 7)
  - [x] Criar `src/app/api/v1/orcamentos/route.ts` com GET (listar) e POST (criar)
  - [x] Criar `src/app/api/v1/orcamentos/[id]/route.ts` com GET e PUT (atualizar)
  - [x] Criar `src/app/api/v1/orcamentos/[id]/converter/route.ts` com POST (converter em venda)
  - [x] Criar `src/app/api/v1/orcamentos/[id]/duplicar/route.ts` com POST (duplicar)
  - [x] Todos endpoints usam `withTenantApi`
- [x] Criar pagina de lista de orcamentos (AC: 3)
  - [x] Criar `src/app/(dashboard)/vendas/orcamentos/page.tsx` como Client Component
  - [x] Status tabs: Todos, Pendentes, Aprovados, Convertidos, Expirados, Recusados
  - [x] Busca por cliente
  - [x] Lista em cards com: #numero, data, cliente, total, validade, status badge
  - [x] Paginacao
  - [x] Empty state e loading skeleton
  - [x] Botao "Novo Orcamento"
- [x] Criar pagina de novo orcamento (AC: 2)
  - [x] Criar `src/app/(dashboard)/vendas/orcamentos/novo/page.tsx` como Client Component
  - [x] Reutilizar mesma UX de nova venda: busca produto, carrinho, desconto
  - [x] Campo de cliente OBRIGATORIO (diferente de venda)
  - [x] Campo de data de validade (DatePicker ou input date)
  - [x] Campo de notas/observacoes
  - [x] Sem forma de pagamento (sera selecionada na conversao)
  - [x] Botao "Salvar Orcamento"
- [x] Criar pagina de detalhe/edicao do orcamento (AC: 4, 5, 7)
  - [x] Criar `src/app/(dashboard)/vendas/orcamentos/[id]/page.tsx` como Client Component
  - [x] Exibir resumo: itens, valores, cliente, validade, notas
  - [x] Status banners (PENDENTE/CONVERTIDO/EXPIRADO/RECUSADO)
  - [x] Botao "Converter em Venda" (apenas se PENDENTE ou APROVADO)
  - [x] Botao "Duplicar Orcamento"
  - [x] Botao "Recusar" (se PENDENTE)
  - [x] Link para venda gerada (se CONVERTIDO)
- [x] Escrever testes (AC: all)
  - [x] `tests/unit/modules/vendas/orcamento-schema.test.ts`: validacoes do schema
  - [x] `tests/unit/modules/vendas/orcamento-service.test.ts`: service unit tests

## Dev Notes

**Source Tree relevante:**
```
src/
├── app/(dashboard)/vendas/orcamentos/
│   ├── page.tsx                # Lista de orcamentos
│   ├── novo/page.tsx           # Novo orcamento
│   └── [id]/page.tsx           # Detalhe/edicao
├── app/api/v1/orcamentos/
│   ├── route.ts                # GET + POST
│   ├── [id]/route.ts           # GET + PUT
│   ├── [id]/converter/route.ts # POST convert
│   └── [id]/duplicar/route.ts  # POST duplicate
└── modules/vendas/
    ├── orcamento.service.ts    # Business logic
    └── orcamento.schema.ts     # Zod schemas
```

**Depende de:** Story 4.1 (Venda - para conversao), Story 2.3 (Produtos - busca no form)

**CRITICO - Items como JSON:**
- Mesma estrutura de items da Venda (desnormalizado snapshot)
- Cada item: { productId, name, quantity, unitPrice, total } com valores em centavos
- Reutilizar `vendaItemSchema` do venda.schema.ts

**Logica de converter em venda:**
1. Buscar orcamento com todos dados
2. Criar Venda com mesmos items, subtotal, discount, total, clientId
3. Confirmar a venda automaticamente (cria ContaReceber)
4. Atualizar orcamento: status=CONVERTIDO, saleId=venda.id
5. Retornar venda criada

**Numeracao de orcamentos:**
- Usar contagem sequencial por tenant (count + 1) no momento da criacao
- Armazenar no campo `number` do model

**markExpired:**
- Chamado automaticamente ao listar orcamentos (antes do query)
- Atualiza PENDENTE → EXPIRADO onde validUntil < now()

### Testing

- **Localizacao:** `tests/unit/modules/vendas/`
- **Framework:** Vitest
- **Testes necessarios:**
  - Schema: `createOrcamentoSchema` valida items obrigatorio (min 1)
  - Schema: `createOrcamentoSchema` rejeita discount negativo
  - Schema: `createOrcamentoSchema` exige clientId
  - Schema: `createOrcamentoSchema` exige validUntil
  - Schema: defaults discount to 0
  - Service: `createOrcamento` calcula subtotal e total corretamente
  - Service: `convertToVenda` cria venda, confirma, seta CONVERTIDO
  - Service: `convertToVenda` rejeita se nao PENDENTE/APROVADO
  - Service: `duplicateOrcamento` copia dados com status PENDENTE
  - Service: `markExpired` atualiza orcamentos vencidos
  - Service: `listOrcamentos` filtra por status e periodo
- **Mocks:** Mock do `prisma` para testes de service

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-07 | 1.0 | Criacao inicial da story | Sarah (PO) |
| 2026-02-07 | 1.1 | Detalhamento completo das tasks | James (Dev) |
| 2026-02-07 | 1.2 | Implementacao completa - todas tasks concluidas | James (Dev) |

## Dev Agent Record

### Agent Model Used
Claude Opus 4.6 (claude-opus-4-6)

### Debug Log References
- No issues encountered during implementation.

### Completion Notes List
- Orcamento Prisma model with Json items (same snapshot structure as Venda), validUntil, status PENDENTE/APROVADO/RECUSADO/CONVERTIDO/EXPIRADO, sequential number per tenant
- Relations: Tenant, Cliente, Venda (optional saleId for converted quotes)
- orcamentos Orcamento[] added to Tenant, Cliente, Venda models
- Zod schemas: createOrcamentoSchema (clientId required, validUntil required, items min 1), updateOrcamentoSchema (all optional), listOrcamentosQuerySchema
- Service: createOrcamento (auto-calculates subtotal/total, assigns sequential number), listOrcamentos (auto-calls markExpired before listing), getOrcamento, updateOrcamento, convertToVenda (creates Venda + confirms + sets CONVERTIDO), duplicateOrcamento (copies with new PENDENTE + 30 day validity), markExpired (PENDENTE where validUntil < now → EXPIRADO)
- API routes: GET/POST /orcamentos, GET/PUT /orcamentos/[id], POST /orcamentos/[id]/converter, POST /orcamentos/[id]/duplicar
- List page: status tabs (6 statuses), client search, pagination, empty state
- New quote page: similar to nova venda but with required client, date picker for validity, notes field, no payment method
- Detail page: status banners, items list, totals, convert to venda action, duplicate, refuse
- 15 new tests (8 schema + 7 service), 216 total passing
- TypeScript clean

### File List
- `prisma/schema.prisma` (modified - added Orcamento model, orcamentos[] on Tenant/Cliente/Venda)
- `src/modules/vendas/orcamento.schema.ts` (new - Zod schemas for orcamento create, update, list)
- `src/modules/vendas/orcamento.service.ts` (new - CRUD + convertToVenda + duplicate + markExpired)
- `src/app/api/v1/orcamentos/route.ts` (new - GET list + POST create)
- `src/app/api/v1/orcamentos/[id]/route.ts` (new - GET detail + PUT update)
- `src/app/api/v1/orcamentos/[id]/converter/route.ts` (new - POST convert to venda)
- `src/app/api/v1/orcamentos/[id]/duplicar/route.ts` (new - POST duplicate)
- `src/app/(dashboard)/vendas/orcamentos/page.tsx` (new - quote list with filters)
- `src/app/(dashboard)/vendas/orcamentos/novo/page.tsx` (new - new quote form)
- `src/app/(dashboard)/vendas/orcamentos/[id]/page.tsx` (new - quote detail with convert/duplicate/refuse)
- `tests/unit/modules/vendas/orcamento-schema.test.ts` (new - 8 tests)
- `tests/unit/modules/vendas/orcamento-service.test.ts` (new - 7 tests)

## QA Results
*A ser preenchido pelo QA agent*
