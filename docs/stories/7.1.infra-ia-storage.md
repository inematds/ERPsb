# Story 7.1: Infraestrutura de IA e Storage

## Status: Draft

## Story

**As a** desenvolvedor,
**I want** ter a infraestrutura de IA (Claude Vision) e storage (Supabase) configurada,
**so that** as stories de captura inteligente possam processar imagens e armazenar arquivos.

## Acceptance Criteria

1. Model DocumentCapture no Prisma conforme definido no Epic 7.0
2. Adapter para Claude Vision API que recebe imagem (base64 ou URL) e prompt, retorna dados estruturados em JSON
3. Adapter para Supabase Storage que faz upload de imagem e retorna URL publica
4. Endpoint POST /api/v1/captures/upload que recebe imagem (multipart/form-data), salva no Storage e retorna URL
5. Service de extracao que recebe imageUrl + tipo (DESPESA, NOTA_FORNECEDOR, VENDA), chama Claude Vision com prompt especializado e retorna extractedData
6. Prompts de extracao otimizados para cada tipo (despesa, nota fornecedor, venda)
7. Fallback gracioso quando IA nao consegue extrair (retorna campos vazios com confidence=0)
8. Variaveis de ambiente: ANTHROPIC_API_KEY, SUPABASE_STORAGE_URL, SUPABASE_SERVICE_KEY
9. Mock mode: se ANTHROPIC_API_KEY ausente, retorna dados mock (mesmo padrao do WhatsApp adapter)
10. Rate limiting por tenant conforme plano (5/50/200/ilimitado capturas/mes)

## Tasks / Subtasks

- [ ] Adicionar model DocumentCapture ao Prisma schema (AC: 1)
  - [ ] Adicionar model conforme Epic 7.0 com todos os campos e indices
  - [ ] Adicionar relation `captures DocumentCapture[]` no model Tenant
  - [ ] Executar `npx prisma generate`
- [ ] Criar adapter Claude Vision (AC: 2, 6, 7, 9)
  - [ ] Criar `src/integrations/ai/claude-vision.client.ts`
  - [ ] Funcao `extractFromImage(imageBase64, type)`: envia imagem + prompt para Claude Vision API
  - [ ] Prompts especializados por tipo:
    - DESPESA: extrair fornecedor, valor, data, categoria
    - NOTA_FORNECEDOR: extrair fornecedor, CNPJ, itens com quantidade/preco, total, numero nota
    - VENDA: extrair itens, quantidades, cliente (se identificavel)
  - [ ] Parse da resposta em JSON estruturado com campo confidence
  - [ ] Mock mode quando ANTHROPIC_API_KEY ausente
  - [ ] Tratamento de erro (imagem ilegivel, timeout, rate limit)
- [ ] Criar adapter Supabase Storage (AC: 3)
  - [ ] Criar `src/integrations/storage/supabase-storage.client.ts`
  - [ ] Funcao `uploadImage(file, tenantId)`: upload para bucket `captures/{tenantId}/`, retorna URL publica
  - [ ] Funcao `deleteImage(url)`: remove imagem do storage
  - [ ] Validacao: apenas imagens (jpg, png, webp, heic), max 10MB
- [ ] Criar endpoint de upload (AC: 4)
  - [ ] Criar `src/app/api/v1/captures/upload/route.ts` com POST
  - [ ] Recebe multipart/form-data com campo `image`
  - [ ] Valida tipo e tamanho
  - [ ] Salva via adapter Storage
  - [ ] Retorna `{ url: string }`
- [ ] Criar service de extracao (AC: 5, 10)
  - [ ] Criar `src/modules/capture/capture.service.ts`
  - [ ] Funcao `processCapture(tenantId, imageUrl, source, type)`:
    1. Verifica limite mensal do tenant
    2. Cria DocumentCapture com status PENDENTE
    3. Baixa imagem do Storage
    4. Envia para Claude Vision
    5. Salva extractedData e confidence
    6. Atualiza processedAt
  - [ ] Funcao `approveCapture(id)`: cria entidade (ContaPagar/Venda) a partir de extractedData, marca APROVADO
  - [ ] Funcao `rejectCapture(id)`: marca REJEITADO
  - [ ] Funcao `getMonthlyUsage(tenantId)`: conta capturas do mes atual
  - [ ] Funcao `listCaptures(tenantId, query)`: lista com filtros
- [ ] Criar Zod schemas (AC: 4, 5)
  - [ ] Criar `src/modules/capture/capture.schema.ts`
  - [ ] `processImageSchema`: type (enum DESPESA/NOTA_FORNECEDOR/VENDA), source (enum CAMERA/WHATSAPP/MANUAL)
  - [ ] `approveCaptureSchema`: extractedData editado pelo usuario (override da IA)
  - [ ] `listCapturesQuerySchema`: page, pageSize, status, type, startDate, endDate

## Dev Notes

**Source Tree relevante:**
```
src/
├── integrations/
│   ├── ai/
│   │   └── claude-vision.client.ts    # Claude Vision API adapter
│   └── storage/
│       └── supabase-storage.client.ts # Supabase Storage adapter
├── modules/capture/
│   ├── capture.service.ts             # Business logic
│   └── capture.schema.ts             # Zod schemas
└── app/api/v1/captures/
    └── upload/route.ts                # Image upload endpoint
```

**Prompt de extracao (exemplo para NOTA_FORNECEDOR):**
```
Analise esta imagem de uma nota fiscal ou recibo de compra.
Extraia os seguintes dados em formato JSON:
- supplierName: nome do fornecedor/loja
- supplierCnpj: CNPJ se visivel (formato XX.XXX.XXX/XXXX-XX)
- items: array de { description, quantity, unitPrice (centavos), total (centavos) }
- subtotal: em centavos
- total: em centavos
- date: data da nota (formato YYYY-MM-DD)
- invoiceNumber: numero da nota se visivel
- category: uma de [Aluguel, Funcionarios, Fornecedores, Impostos, Marketing, Servicos, Outros]

Se nao conseguir ler algum campo, retorne null para esse campo.
Retorne APENAS o JSON, sem explicacoes.
```

**CRITICO - Seguranca:**
- Imagens sao armazenadas em bucket privado (nao publico)
- URLs assinadas com expiracao de 1h para visualizacao
- Imagens deletadas apos 90 dias (cleanup job)
- Nunca processar imagem sem autenticacao do tenant

**CRITICO - Custo:**
- Claude Haiku para planos Gratis/Starter (~R$ 0,01/foto)
- Claude Sonnet para planos Growth/Pro (~R$ 0,05/foto)
- Processar async (nao bloquear a UI)

### Testing

- **Localizacao:** `tests/unit/modules/capture/`, `tests/unit/integrations/ai/`
- **Framework:** Vitest
- **Testes necessarios:**
  - Claude Vision adapter: mock da API, parse de resposta JSON
  - Claude Vision adapter: fallback quando API retorna erro
  - Storage adapter: mock do Supabase, validacao de tipo/tamanho
  - Service processCapture: cria DocumentCapture, chama IA, salva resultado
  - Service processCapture: respeita limite mensal
  - Service approveCapture: cria ContaPagar a partir de extractedData
  - Service rejectCapture: marca como REJEITADO
  - Schemas: validacao de campos obrigatorios

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-09 | 1.0 | Criacao inicial da story | Sarah (PO) |

## Dev Agent Record
*A ser preenchido durante implementacao*

## QA Results
*A ser preenchido pelo QA agent*
