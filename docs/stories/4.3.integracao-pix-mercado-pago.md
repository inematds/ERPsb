# Story 4.3: Integracao PIX - Mercado Pago (Cobranca e QR Code)

## Status: Ready for Review

## Story

**As a** usuario,
**I want** gerar cobranca PIX em 1 clique com QR code,
**so that** meu cliente possa pagar instantaneamente pelo celular.

## Acceptance Criteria

1. Integracao com API Mercado Pago configurada (credenciais em env vars)
2. Model PixCharge no Prisma: id, tenantId, contaReceberId (FK), externalId, amount, qrCode (base64), qrCodeText, paymentLink, status (PENDING/PAID/EXPIRED/CANCELLED), expiresAt, paidAt, createdAt
3. Botao "Cobrar via PIX" disponivel em conta a receber e tela de venda
4. Ao clicar: chama API Mercado Pago, gera cobranca PIX, exibe QR code
5. Tela de cobranca PIX com: QR code, botao "Copiar codigo PIX", botao "Compartilhar"
6. Cobranca com expiracao configuravel (default: 24h)
7. Status da cobranca atualizado na tela

## Tasks / Subtasks

- [x] Adicionar model PixCharge ao Prisma schema (AC: 2)
  - [x] Adicionar model `PixCharge` em `prisma/schema.prisma` com campos: id (cuid), tenantId (String, FK Tenant), contaReceberId (String, FK ContaReceber), externalId (String?), amount (Int), qrCode (String? - base64), qrCodeText (String?), paymentLink (String?), status (String, default "PENDING"), expiresAt (DateTime), paidAt (DateTime?), createdAt (DateTime)
  - [x] Relations para Tenant e ContaReceber
  - [x] Adicionar `pixCharges PixCharge[]` no model Tenant e ContaReceber
  - [x] Indices: `@@index([tenantId, status])`, `@@index([contaReceberId])`
  - [x] `@@map("pix_charges")`
  - [x] Executar `npx prisma generate`
- [x] Adicionar env vars do Mercado Pago (AC: 1)
  - [x] Adicionar `MERCADO_PAGO_ACCESS_TOKEN` (string, optional) e `MERCADO_PAGO_WEBHOOK_SECRET` (string, optional) ao `src/lib/env.ts`
  - [x] Adicionar ao `.env.example`
- [x] Criar Mercado Pago client (AC: 1)
  - [x] Criar `src/integrations/pix/mercadopago.client.ts`
  - [x] Funcao `createPixPayment(amount, description, expirationMinutes)`: chama POST `/v1/payments` da API Mercado Pago com `payment_method_id: "pix"`, retorna `{ externalId, qrCode, qrCodeText, paymentLink }`
  - [x] Funcao `getPaymentStatus(externalId)`: chama GET `/v1/payments/{id}`, retorna status
  - [x] Funcao `cancelPayment(externalId)`: chama PUT para cancelar pagamento
  - [x] Usar `fetch` nativo com `Authorization: Bearer {token}` header
  - [x] Retornar dados mockados se `MERCADO_PAGO_ACCESS_TOKEN` nao estiver configurado (modo dev/sandbox)
- [x] Criar Zod schemas de validacao (AC: 1, 4)
  - [x] Criar `src/integrations/pix/pix.schema.ts`
  - [x] `createPixChargeSchema`: contaReceberId (obrigatorio), expirationMinutes (int, default 1440 = 24h, min 15, max 43200)
  - [x] `listPixChargesQuerySchema`: page, pageSize, status, contaReceberId
- [x] Criar service PIX (AC: 3, 4, 6, 7)
  - [x] Criar `src/integrations/pix/pix.service.ts`
  - [x] `createPixCharge(data)`: busca ContaReceber, chama mercadopago.client, salva PixCharge no banco, retorna com QR code
  - [x] `getPixCharge(id)`: busca por id com include contaReceber
  - [x] `listPixCharges(query)`: lista com filtros por status, contaReceberId, paginacao
  - [x] `checkPixStatus(id)`: consulta status no Mercado Pago, atualiza PixCharge se mudou, se PAID marca ContaReceber como RECEBIDO
  - [x] `cancelPixCharge(id)`: cancela no Mercado Pago e atualiza status local para CANCELLED
  - [x] `markExpiredCharges()`: atualiza PENDING com expiresAt < now() para EXPIRED
- [x] Criar API routes PIX (AC: 3, 4)
  - [x] Criar `src/app/api/v1/pix/route.ts` com GET (listar) e POST (criar cobranca)
  - [x] Criar `src/app/api/v1/pix/[id]/route.ts` com GET (detalhe)
  - [x] Criar `src/app/api/v1/pix/[id]/status/route.ts` com POST (check status manualmente)
  - [x] Criar `src/app/api/v1/pix/[id]/cancelar/route.ts` com POST (cancelar)
  - [x] Todos endpoints usam `withTenantApi`
- [x] Criar tela de cobranca PIX (AC: 5, 7)
  - [x] Criar `src/app/(dashboard)/financeiro/pix/page.tsx` como Client Component - lista de cobrancas PIX
  - [x] Criar `src/app/(dashboard)/financeiro/pix/[id]/page.tsx` como Client Component - detalhe com QR code grande, botao "Copiar codigo PIX" (clipboard API), botao "Compartilhar" (Web Share API), status badge, botao refresh status, botao cancelar
- [x] Integrar PIX nos fluxos existentes (AC: 3)
  - [x] Adicionar botao "Cobrar via PIX" na pagina de detalhe da conta a receber (`src/app/(dashboard)/financeiro/contas-receber/` - se existir detalhe, ou na lista)
  - [x] Ao clicar, chama POST /api/v1/pix com contaReceberId e redireciona para tela de cobranca PIX
- [x] Escrever testes (AC: all)
  - [x] `tests/unit/integrations/pix/pix-schema.test.ts`: validacoes do schema
  - [x] `tests/unit/integrations/pix/pix-service.test.ts`: service unit tests
  - [x] `tests/unit/integrations/pix/mercadopago-client.test.ts`: client unit tests com mock de fetch

## Dev Notes

**Depende de:** Story 3.2 (ContaReceber), Story 4.1 (Vendas)
**Integracao externa:** Mercado Pago API - requer MERCADO_PAGO_ACCESS_TOKEN em env vars

**Source Tree relevante:**
```
src/
├── integrations/pix/
│   ├── mercadopago.client.ts    # Mercado Pago API client
│   ├── pix.service.ts           # Business logic
│   └── pix.schema.ts            # Zod schemas
├── app/api/v1/pix/
│   ├── route.ts                 # GET list + POST create
│   ├── [id]/route.ts            # GET detail
│   ├── [id]/status/route.ts     # POST check status
│   └── [id]/cancelar/route.ts   # POST cancel
└── app/(dashboard)/financeiro/pix/
    ├── page.tsx                 # Lista de cobrancas PIX
    └── [id]/page.tsx            # Detalhe com QR code
```

**CRITICO - Modo Sandbox:**
- Se `MERCADO_PAGO_ACCESS_TOKEN` nao estiver configurado, retornar dados mockados realistas
- QR code mock: gerar base64 de um QR code placeholder
- Isso permite desenvolvimento e testes sem credenciais reais

**CRITICO - Valores em centavos:**
- `amount` no PixCharge e em centavos (igual ContaReceber)
- API Mercado Pago espera valor em reais (decimal), converter centavos/100 ao chamar API
- Ao receber resposta, armazenar em centavos

**Fluxo de criacao:**
1. Usuario clica "Cobrar via PIX" em uma ContaReceber PENDENTE
2. POST /api/v1/pix com contaReceberId
3. Service busca ContaReceber, valida status PENDENTE
4. Chama Mercado Pago API (ou mock)
5. Salva PixCharge no banco
6. Retorna PixCharge com QR code data
7. Frontend redireciona para /financeiro/pix/{id} com QR code

**Status mapping Mercado Pago:**
- `pending` → PENDING
- `approved` → PAID
- `expired` → EXPIRED
- `cancelled`/`rejected` → CANCELLED

### Testing

- **Localizacao:** `tests/unit/integrations/pix/`
- **Framework:** Vitest
- **Testes necessarios:**
  - Schema: `createPixChargeSchema` exige contaReceberId
  - Schema: `createPixChargeSchema` default expirationMinutes = 1440
  - Schema: rejeita expirationMinutes < 15
  - Schema: rejeita expirationMinutes > 43200
  - Client: `createPixPayment` retorna mock data quando sem token
  - Client: `createPixPayment` faz fetch correto quando com token
  - Client: `getPaymentStatus` retorna status
  - Service: `createPixCharge` cria cobranca e salva no banco
  - Service: `createPixCharge` rejeita ContaReceber nao PENDENTE
  - Service: `checkPixStatus` atualiza PixCharge e ContaReceber quando PAID
  - Service: `cancelPixCharge` atualiza status para CANCELLED
  - Service: `markExpiredCharges` atualiza cobranças vencidas
  - Service: `listPixCharges` filtra por status
- **Mocks:** Mock do `prisma` e do `fetch` (global) para testes

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-07 | 1.0 | Criacao inicial da story | Sarah (PO) |
| 2026-02-07 | 1.1 | Detalhamento completo das tasks | James (Dev) |
| 2026-02-07 | 1.2 | Implementacao completa - todas tasks concluidas | James (Dev) |

## Dev Agent Record

### Agent Model Used
Claude Opus 4.6 (claude-opus-4-6)

### Debug Log References
- No issues encountered during implementation.

### Completion Notes List
- PixCharge Prisma model with FK to ContaReceber and Tenant, status PENDING/PAID/EXPIRED/CANCELLED, expiresAt, paidAt
- pixCharges PixCharge[] added to Tenant and ContaReceber models
- MERCADO_PAGO_ACCESS_TOKEN and MERCADO_PAGO_WEBHOOK_SECRET added as optional env vars (env.ts + .env.example)
- Mercado Pago client: createPixPayment (converts centavos to reais for API), getPaymentStatus (maps MP statuses), cancelPayment. Returns mock data when no token configured (sandbox mode)
- Zod schemas: createPixChargeSchema (contaReceberId required, expirationMinutes default 1440 min 15 max 43200), listPixChargesQuerySchema
- PIX service: createPixCharge (validates ContaReceber PENDENTE, calls MP client, saves PixCharge), getPixCharge, listPixCharges (auto markExpired), checkPixStatus (updates PixCharge + marks ContaReceber RECEBIDO if PAID), cancelPixCharge, markExpiredCharges
- API routes: GET/POST /pix, GET /pix/[id], POST /pix/[id]/status, POST /pix/[id]/cancelar - all with withTenantApi
- List page: status tabs (5 statuses), pagination, links to detail
- Detail page: QR code display, "Copiar codigo" (clipboard API), "Compartilhar" (Web Share API), auto-refresh every 10s for pending, manual status check, cancel button, payment link
- Integrated "Cobrar via PIX" button (QrCode icon) in contas a receber list for PENDENTE/VENCIDO items
- 22 new tests (9 schema + 9 service + 4 client), 238 total passing
- TypeScript clean

### File List
- `prisma/schema.prisma` (modified - added PixCharge model, pixCharges[] on Tenant/ContaReceber)
- `src/lib/env.ts` (modified - added MERCADO_PAGO_ACCESS_TOKEN, MERCADO_PAGO_WEBHOOK_SECRET)
- `.env.example` (modified - added Mercado Pago section)
- `src/integrations/pix/mercadopago.client.ts` (new - Mercado Pago API client with sandbox mode)
- `src/integrations/pix/pix.schema.ts` (new - Zod schemas for PIX charge)
- `src/integrations/pix/pix.service.ts` (new - CRUD + checkStatus + cancel + markExpired)
- `src/app/api/v1/pix/route.ts` (new - GET list + POST create)
- `src/app/api/v1/pix/[id]/route.ts` (new - GET detail)
- `src/app/api/v1/pix/[id]/status/route.ts` (new - POST check status)
- `src/app/api/v1/pix/[id]/cancelar/route.ts` (new - POST cancel)
- `src/app/(dashboard)/financeiro/pix/page.tsx` (new - PIX charges list with filters)
- `src/app/(dashboard)/financeiro/pix/[id]/page.tsx` (new - PIX charge detail with QR code)
- `src/app/(dashboard)/financeiro/contas-receber/page.tsx` (modified - added "Cobrar via PIX" button)
- `tests/unit/integrations/pix/pix-schema.test.ts` (new - 9 tests)
- `tests/unit/integrations/pix/pix-service.test.ts` (new - 9 tests)
- `tests/unit/integrations/pix/mercadopago-client.test.ts` (new - 4 tests)

## QA Results
*A ser preenchido pelo QA agent*
