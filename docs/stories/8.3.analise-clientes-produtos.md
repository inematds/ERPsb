# Story 8.3: Analise de Clientes e Produtos

## Status: Draft

## Story

**As a** usuario,
**I want** perguntar sobre meus clientes e produtos no chat,
**so that** eu saiba quem sao meus melhores clientes e quais produtos mais vendem.

## Acceptance Criteria

1. Novas funcoes de consulta:
   - getInadimplentes(tenantId): clientes com contas vencidas, ordenado por valor
   - getClientesFrequentes(tenantId, top): mais compram (qtd vendas)
   - getClientesInativos(tenantId, dias): nao compram ha X dias
   - getClienteHistorico(tenantId, clientId): resumo completo do cliente
   - getEstoqueBaixo(tenantId): produtos abaixo do minimo
   - getEstoqueValor(tenantId): valor total em estoque
   - getProdutosMaisRentaveis(tenantId, top): maior margem (se custo preenchido)
   - getSazonalidade(tenantId, productId): vendas por mes nos ultimos 12 meses
2. Perguntas sobre cliente especifico: "Quanto a Maria comprou esse ano?"
3. Perguntas sobre produto especifico: "Quanto vendi de Camiseta P?"
4. IA sugere acoes: "Maria nao compra ha 45 dias. Quer enviar uma mensagem?"
5. Integracao com WhatsApp: ao sugerir contato com cliente, oferecer link para enviar mensagem

## Tasks / Subtasks

- [ ] Adicionar funcoes de clientes (AC: 1, 2)
  - [ ] getInadimplentes: ContaReceber vencidas agrupadas por clientId
  - [ ] getClientesFrequentes: count de vendas por cliente, top N
  - [ ] getClientesInativos: clientes cuja ultima venda > X dias atras
  - [ ] getClienteHistorico: total comprado, qtd vendas, ultima compra, contas pendentes
- [ ] Adicionar funcoes de produtos (AC: 1, 3)
  - [ ] getEstoqueBaixo: produtos com saldo < minimo
  - [ ] getEstoqueValor: soma (saldo * costPrice) de todos os produtos
  - [ ] getProdutosMaisRentaveis: (preco - custo) / preco ordenado DESC
  - [ ] getSazonalidade: vendas.items agrupado por mes para productId
- [ ] Registrar tools no Claude adapter (AC: 1-4)
  - [ ] Atualizar definicoes com descricoes claras
  - [ ] IA deve resolver nomes de clientes/produtos para IDs
  - [ ] Busca fuzzy quando nome nao e exato
- [ ] Sugestoes de acao (AC: 4, 5)
  - [ ] Ao identificar cliente inativo, sugerir contato
  - [ ] Ao identificar estoque baixo, sugerir reposicao
  - [ ] Ao identificar inadimplente, sugerir cobranca
  - [ ] Links de acao na resposta (deep links para telas do app)

## Dev Notes

**Depende de:** Story 8.1 (infra), Story 8.2 (consultas financeiras)

**Resolucao de nomes:**
- "Maria" pode ser varias clientes. IA deve:
  1. Buscar por nome (ILIKE %Maria%)
  2. Se encontrar 1: usar esse
  3. Se encontrar varios: perguntar "Encontrei Maria Silva e Maria Santos. Qual?"
  4. Se nao encontrar: "Nao encontrei cliente com esse nome"

**Deep links sugeridos:**
- "Enviar cobranca para Maria" → link para `/financeiro/contas-receber/{id}`
- "Ver estoque de Camiseta P" → link para `/estoque?product={id}`
- "Repor estoque" → link para `/estoque?action=entrada`

### Testing

- **Testes necessarios:**
  - getInadimplentes: retorna clientes com contas vencidas
  - getClientesFrequentes: ordena por qtd vendas DESC
  - getClientesInativos: filtra por ultima venda
  - getEstoqueBaixo: retorna produtos abaixo do minimo
  - getProdutosMaisRentaveis: calcula margem corretamente

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-09 | 1.0 | Criacao inicial da story | Sarah (PO) |

## Dev Agent Record
*A ser preenchido durante implementacao*

## QA Results
*A ser preenchido pelo QA agent*
