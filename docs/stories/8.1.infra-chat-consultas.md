# Story 8.1: Infraestrutura de Chat e Consultas

## Status: Draft

## Story

**As a** usuario,
**I want** ter um chat no sistema onde posso fazer perguntas sobre meu negocio,
**so that** eu obtenha respostas rapidas sem precisar navegar por relatorios.

## Acceptance Criteria

1. Model ChatMessage no Prisma para historico de conversas
2. Componente de chat flutuante (botao no canto inferior direito, abre painel lateral)
3. API POST /api/v1/chat que recebe mensagem do usuario e retorna resposta da IA
4. Integracao com Claude API usando function calling (tool use)
5. Funcoes de consulta ao banco (queries pre-definidas, seguras, com tenantId):
   - getSaldoAtual()
   - getResumoPerido(inicio, fim)
   - getVendasPeriodo(inicio, fim)
   - getContasPendentes(tipo)
   - getTicketMedio(inicio, fim)
6. Streaming da resposta (token a token) para UX responsiva
7. Historico das ultimas 20 mensagens persistido no banco
8. Rate limiting por tenant conforme plano (10/50/200/ilimitado perguntas/mes)
9. Mock mode quando ANTHROPIC_API_KEY ausente (respostas pre-definidas)
10. Indicador de uso: "5 de 10 perguntas usadas este mes"
11. System prompt que define personalidade: amigavel, direto, usa linguagem simples, sempre mostra valores em R$

## Tasks / Subtasks

- [ ] Adicionar model ChatMessage ao Prisma schema (AC: 1)
  - [ ] Model com campos: id, tenantId, userId, role (USER/ASSISTANT), content, metadata (Json), createdAt
  - [ ] Indices: [tenantId, createdAt]
  - [ ] Relation com Tenant
  - [ ] `@@map("chat_messages")`
- [ ] Criar funcoes de consulta ao banco (AC: 5)
  - [ ] Criar `src/modules/chat/chat-functions.ts`
  - [ ] Cada funcao recebe tenantId e parametros, retorna dados formatados
  - [ ] getSaldoAtual(tenantId): saldo atual (soma recebidos - soma pagos)
  - [ ] getResumoPerido(tenantId, inicio, fim): receitas, despesas, lucro, qtd vendas
  - [ ] getVendasPeriodo(tenantId, inicio, fim): total vendido, qtd, ticket medio
  - [ ] getContasPendentes(tenantId, tipo): lista com total e qtd
  - [ ] getTicketMedio(tenantId, inicio, fim): valor medio por venda
  - [ ] Todas funcoes retornam valores ja formatados em centavos
- [ ] Criar adapter Claude com function calling (AC: 4, 6, 11)
  - [ ] Criar `src/integrations/ai/claude-chat.client.ts`
  - [ ] System prompt com personalidade do CFO virtual
  - [ ] Definicao das tools (funcoes) no formato Claude API
  - [ ] Loop de function calling: IA chama funcao → executa → retorna resultado → IA formata resposta
  - [ ] Streaming via ReadableStream
  - [ ] Timeout de 30 segundos
- [ ] Criar service de chat (AC: 7, 8)
  - [ ] Criar `src/modules/chat/chat.service.ts`
  - [ ] Funcao sendMessage(tenantId, userId, message): verifica limite, salva mensagem, chama IA, salva resposta
  - [ ] Funcao getHistory(tenantId, limit): ultimas N mensagens
  - [ ] Funcao getMonthlyUsage(tenantId): contagem do mes
  - [ ] Contexto: enviar ultimas 10 mensagens como historico para a IA
- [ ] Criar endpoint de chat (AC: 3, 6)
  - [ ] Criar `src/app/api/v1/chat/route.ts` com POST
  - [ ] Recebe `{ message: string }`
  - [ ] Retorna streaming response (text/event-stream)
  - [ ] GET para historico
- [ ] Criar componente de chat flutuante (AC: 2, 10)
  - [ ] Criar `src/components/chat/chat-widget.tsx` como Client Component
  - [ ] Botao flutuante no canto inferior direito (icone MessageSquare)
  - [ ] Painel lateral que abre por cima do conteudo (nao desloca layout)
  - [ ] Input de texto com botao enviar
  - [ ] Lista de mensagens com bolhas (usuario direita, assistente esquerda)
  - [ ] Typing indicator enquanto IA processa
  - [ ] Indicador de uso mensal no topo
  - [ ] Botao fechar
  - [ ] Responsivo: mobile ocupa tela inteira, desktop ocupa 400px lateral
- [ ] Adicionar widget ao layout do dashboard (AC: 2)
  - [ ] Modificar `src/app/(dashboard)/layout.tsx`
  - [ ] Incluir ChatWidget como componente global

## Dev Notes

**Source Tree relevante:**
```
src/
├── integrations/ai/
│   └── claude-chat.client.ts          # Claude API com function calling
├── modules/chat/
│   ├── chat.service.ts                # Business logic
│   └── chat-functions.ts             # Funcoes de consulta ao banco
├── components/chat/
│   └── chat-widget.tsx                # Widget flutuante
├── app/api/v1/chat/
│   └── route.ts                       # POST (send) + GET (history)
```

**Depende de:** Nenhuma story nova (usa dados ja existentes no banco)

**CRITICO - Seguranca:**
- IA NUNCA gera SQL diretamente
- Funcoes de consulta sempre filtram por tenantId
- Historico de chat isolado por tenant
- Nao expor dados sensiveis em metadata

**CRITICO - Streaming:**
- Usar ReadableStream + TextEncoder para streaming
- Formato: Server-Sent Events (text/event-stream)
- Cliente: usar fetch com reader para ler stream
- Fallback: se streaming falhar, retornar resposta completa

**System prompt (rascunho):**
```
Voce e o CFO virtual do ERPsb, um assistente financeiro para pequenos negocios brasileiros.

Regras:
- Responda sempre em portugues, linguagem simples e direta
- Use valores em R$ formatados (R$ 1.234,56)
- Quando nao souber, diga "Nao tenho essa informacao" - nunca invente dados
- Seja encorajador quando os numeros forem bons
- Seja honesto mas construtivo quando os numeros forem ruins
- Sugira acoes praticas quando possivel
- Mantenha respostas curtas (2-4 frases para perguntas simples)
```

### Testing

- **Localizacao:** `tests/unit/modules/chat/`
- **Framework:** Vitest
- **Testes necessarios:**
  - chat-functions: getSaldoAtual retorna soma correta
  - chat-functions: getResumoPerido filtra por datas
  - chat-functions: getContasPendentes filtra por tipo
  - chat.service: sendMessage salva mensagem e resposta
  - chat.service: sendMessage respeita limite mensal
  - chat.service: getHistory retorna ultimas N mensagens

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-09 | 1.0 | Criacao inicial da story | Sarah (PO) |

## Dev Agent Record
*A ser preenchido durante implementacao*

## QA Results
*A ser preenchido pelo QA agent*
