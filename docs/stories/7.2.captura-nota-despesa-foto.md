# Story 7.2: Captura de Nota/Despesa por Foto

## Status: Draft

## Story

**As a** usuario,
**I want** tirar uma foto de uma nota de fornecedor ou cupom de despesa e ter os dados preenchidos automaticamente,
**so that** eu registre minhas despesas em segundos, sem digitar nada.

## Acceptance Criteria

1. Botao "Registrar por foto" visivel na tela de contas a pagar (destaque visual, icone de camera)
2. Ao clicar, abre a camera do celular (ou seletor de arquivo no desktop)
3. Preview da foto tirada com opcoes "Usar esta foto" ou "Tirar outra"
4. Indicador de processamento enquanto IA analisa (skeleton com mensagem "Analisando sua nota...")
5. Tela de aprovacao com dados extraidos pre-preenchidos em formulario editavel:
   - Para NOTA_FORNECEDOR: fornecedor, CNPJ, itens (tabela editavel), total, data, numero da nota
   - Para DESPESA: descricao, valor, data, categoria, fornecedor (se identificado)
6. Indicador de confianca por campo (icone verde = alta confianca, amarelo = baixa, vermelho = nao extraido)
7. Botao "Aprovar" cria ContaPagar + entrada de estoque (se itens de produto)
8. Botao "Rejeitar" descarta a captura
9. Ao aprovar nota com itens, sistema tenta vincular produtos existentes por nome (fuzzy match)
10. Foto original acessivel na tela de detalhe da conta a pagar criada
11. Funciona offline: foto salva localmente, processamento quando voltar online (PWA)
12. Toggle para escolher tipo: "Nota de fornecedor" ou "Despesa simples"

## Tasks / Subtasks

- [ ] Criar componente de captura de foto (AC: 2, 3)
  - [ ] Criar `src/components/capture/photo-capture.tsx` como Client Component
  - [ ] Input `<input type="file" accept="image/*" capture="environment">` para mobile
  - [ ] Preview da imagem com crop/rotate basico
  - [ ] Botoes "Usar foto" e "Tirar outra"
  - [ ] Comprimir imagem antes de upload (max 1MB, manter legibilidade)
  - [ ] Suporte a drag-and-drop no desktop
- [ ] Criar tela de captura (AC: 1, 4, 12)
  - [ ] Criar `src/app/(dashboard)/financeiro/captura/page.tsx` como Client Component
  - [ ] Toggle no topo: "Nota de fornecedor" | "Despesa simples"
  - [ ] Componente photo-capture
  - [ ] Ao capturar foto: upload via /api/v1/captures/upload, depois POST /api/v1/captures/process
  - [ ] Loading state com skeleton mostrando "Analisando sua nota..." (2-5 segundos)
  - [ ] Redirect para tela de aprovacao quando processamento concluir
- [ ] Criar tela de aprovacao (AC: 5, 6, 7, 8)
  - [ ] Criar `src/app/(dashboard)/financeiro/captura/[id]/page.tsx` como Client Component
  - [ ] Exibir foto original (thumbnail clicavel para ampliar)
  - [ ] Formulario pre-preenchido com dados extraidos
  - [ ] Para NOTA_FORNECEDOR:
    - Fornecedor (autocomplete, pre-selecionado se encontrado por CNPJ)
    - Tabela de itens editavel (add/remove/editar linhas)
    - Total (calculado automaticamente)
    - Data e numero da nota
  - [ ] Para DESPESA:
    - Descricao, valor, categoria (select), data vencimento
    - Fornecedor (autocomplete, opcional)
  - [ ] Indicador de confianca ao lado de cada campo (baseado em confidence da IA)
  - [ ] Botao "Aprovar e criar conta" (verde, destaque)
  - [ ] Botao "Rejeitar" (vermelho, secundario)
  - [ ] Toast de sucesso com link para conta criada
- [ ] Criar endpoint de processamento (AC: 4, 5)
  - [ ] Criar `src/app/api/v1/captures/process/route.ts` com POST
  - [ ] Recebe `{ imageUrl, type, source }`
  - [ ] Chama capture.service.processCapture()
  - [ ] Retorna `{ id, extractedData, confidence }`
- [ ] Criar endpoint de aprovacao/rejeicao (AC: 7, 8)
  - [ ] Criar `src/app/api/v1/captures/[id]/approve/route.ts` com POST
  - [ ] Recebe extractedData editado pelo usuario
  - [ ] Chama capture.service.approveCapture() que cria ContaPagar (e entrada estoque se aplicavel)
  - [ ] Criar `src/app/api/v1/captures/[id]/reject/route.ts` com POST
- [ ] Adicionar botao na pagina de contas a pagar (AC: 1)
  - [ ] Modificar `src/app/(dashboard)/financeiro/contas-pagar/page.tsx`
  - [ ] Adicionar botao "Registrar por foto" (icone Camera) ao lado do botao "+ Nova Conta"
  - [ ] Link para `/financeiro/captura`
- [ ] Vinculacao de produtos existentes (AC: 9)
  - [ ] No approveCapture, para cada item extraido:
    - Buscar produto por nome (ILIKE fuzzy match)
    - Se encontrar com confianca > 80%, vincular productId
    - Se nao encontrar, criar entrada generica
  - [ ] Criar MovimentacaoEstoque do tipo ENTRADA para cada item vinculado
- [ ] Foto no detalhe da conta (AC: 10)
  - [ ] Modificar `src/app/(dashboard)/financeiro/contas-pagar/[id]/page.tsx`
  - [ ] Se conta tem DocumentCapture vinculado, exibir thumbnail da foto original
  - [ ] Clique abre imagem em modal fullscreen

## Dev Notes

**Source Tree relevante:**
```
src/
├── components/capture/
│   └── photo-capture.tsx              # Componente reutilizavel de captura
├── app/(dashboard)/financeiro/captura/
│   ├── page.tsx                       # Tela de captura (camera + tipo)
│   └── [id]/page.tsx                  # Tela de aprovacao
├── app/api/v1/captures/
│   ├── upload/route.ts                # Upload de imagem (Story 7.1)
│   ├── process/route.ts               # Processar com IA
│   └── [id]/
│       ├── approve/route.ts           # Aprovar captura
│       └── reject/route.ts            # Rejeitar captura
```

**Depende de:** Story 7.1 (infra IA + Storage)

**UX critica - mobile:**
- Camera deve abrir no modo "traseira" (capture="environment")
- Comprimir antes de upload (usuarios com 3G/4G lento)
- Preview rapido antes de enviar (evitar fotos acidentais)
- Loading nao deve parecer travado (usar skeleton animado)

**Logica de aprovacao para NOTA_FORNECEDOR:**
1. Cria ou vincula Fornecedor (por CNPJ ou nome)
2. Cria ContaPagar com amount=total, dueDate=data da nota, category="Fornecedores"
3. Para cada item: busca produto, cria MovimentacaoEstoque ENTRADA
4. Vincula DocumentCapture.contaPagarId

**Logica de aprovacao para DESPESA:**
1. Cria ContaPagar com dados do formulario
2. Vincula DocumentCapture.contaPagarId

### Testing

- **Localizacao:** `tests/unit/modules/capture/`
- **Framework:** Vitest + Testing Library
- **Testes necessarios:**
  - Componente photo-capture: renderiza input file com capture attribute
  - Tela de aprovacao: exibe campos pre-preenchidos
  - Tela de aprovacao: permite editar campos antes de aprovar
  - Endpoint process: chama service e retorna extractedData
  - Endpoint approve: cria ContaPagar + MovimentacaoEstoque
  - Endpoint reject: marca como REJEITADO
  - Vinculacao de produtos: fuzzy match por nome

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-09 | 1.0 | Criacao inicial da story | Sarah (PO) |

## Dev Agent Record
*A ser preenchido durante implementacao*

## QA Results
*A ser preenchido pelo QA agent*
