# Story 9.1: Calculadora de Preco de Venda

## Status: Draft

## Story

**As a** usuario,
**I want** saber exatamente quanto cobrar por um produto considerando todos os custos,
**so that** eu nunca venda com prejuizo sem saber.

## Acceptance Criteria

1. Model CustoFixo no Prisma para registrar custos fixos mensais do negocio (aluguel, luz, internet, etc.)
2. Tela de configuracao de custos fixos: CRUD simples de descricao + valor mensal
3. Novos campos no model Produto: costPrice, packagingCost, shippingCost, otherCosts, desiredMargin
4. Tela da calculadora acessivel em `/precificacao` com:
   - Select de produto (carrega dados salvos) ou calcular sem produto
   - Inputs editaveis: custo do produto, embalagem, frete, outros custos
   - Custo fixo rateado: calculado automaticamente (total custos fixos / media de vendas/mes)
   - Imposto: calculado pelo regime tributario do tenant (Simples Nacional tabela, MEI fixo)
   - Taxa da forma de pagamento: select com taxa ja configurada
   - Margem desejada: slider ou input percentual
5. Resultado em tempo real (calcula a cada mudanca):
   - Custo total detalhado
   - Preco sugerido
   - Preco arredondado (R$ X,90)
   - Lucro por unidade
   - Margem real percentual
6. Botao "Salvar no produto" que atualiza costPrice e preco de venda do produto
7. Educativo: tooltip explicando diferenca entre markup e margem
8. Funciona no modo "rapido" sem selecionar produto (calcular avulso)
9. Historico de calculos recentes (ultimos 10, localStorage)

## Tasks / Subtasks

- [ ] Adicionar model CustoFixo ao Prisma (AC: 1)
  - [ ] Model: id, tenantId, description, amount (centavos), active, createdAt, updatedAt
  - [ ] Relation com Tenant
  - [ ] `@@map("custos_fixos")`
- [ ] Adicionar campos de custo ao Produto (AC: 3)
  - [ ] costPrice Int? (centavos)
  - [ ] packagingCost Int? (centavos)
  - [ ] shippingCost Int? (centavos)
  - [ ] otherCosts Int? (centavos)
  - [ ] desiredMargin Float? (0-1)
  - [ ] suggestedPrice Int? (centavos)
- [ ] Criar API de custos fixos (AC: 1, 2)
  - [ ] Criar `src/app/api/v1/custos-fixos/route.ts` com GET e POST
  - [ ] Criar `src/app/api/v1/custos-fixos/[id]/route.ts` com PUT e DELETE
  - [ ] Service em `src/modules/precificacao/custo-fixo.service.ts`
- [ ] Criar tela de custos fixos (AC: 2)
  - [ ] Criar `src/app/(dashboard)/precificacao/custos-fixos/page.tsx`
  - [ ] Lista de custos fixos com total mensal
  - [ ] Inline add/edit/delete
  - [ ] Categorias sugeridas: Aluguel, Energia, Agua, Internet, Telefone, Contador, Outros
- [ ] Criar engine de calculo (AC: 4, 5)
  - [ ] Criar `src/modules/precificacao/pricing.engine.ts`
  - [ ] Funcao calcularPreco(params):
    ```typescript
    type PricingParams = {
      costPrice: number        // centavos
      packagingCost: number    // centavos
      shippingCost: number     // centavos
      otherCosts: number       // centavos
      fixedCostShare: number   // centavos (rateado)
      taxRate: number          // 0.06 para Simples comercio
      paymentFeeRate: number   // 0.02 para credito
      desiredMargin: number    // 0.30 para 30%
    }

    type PricingResult = {
      baseCost: number         // soma custos diretos
      fixedCost: number        // custo fixo rateado
      totalCost: number        // custo total
      taxAmount: number        // valor imposto
      feeAmount: number        // valor taxa
      suggestedPrice: number   // preco sugerido
      roundedPrice: number     // preco arredondado (X,90)
      profitPerUnit: number    // lucro por unidade
      realMargin: number       // margem real percentual
      markup: number           // markup percentual
    }
    ```
  - [ ] Formula: `precoVenda = custoBase / (1 - margem - aliquota - taxa)`
  - [ ] Arredondar para R$ X,90 (psicologico)
- [ ] Calcular custo fixo rateado (AC: 4)
  - [ ] Funcao calcularRateio(tenantId):
    - Total custos fixos ativos
    - Media de vendas/mes (ultimos 3 meses)
    - Rateio = total / media vendas
  - [ ] Exibir com tooltip explicativo
- [ ] Criar tela da calculadora (AC: 4, 5, 6, 7, 8, 9)
  - [ ] Criar `src/app/(dashboard)/precificacao/page.tsx` como Client Component
  - [ ] Select de produto (carrega dados salvos) ou modo "avulso"
  - [ ] Inputs de custo (pre-preenchidos se produto selecionado)
  - [ ] Custo fixo rateado (calculado, com tooltip)
  - [ ] Select de regime tributario (puxar do ConfigFiscal ou default)
  - [ ] Select de forma de pagamento (para taxa)
  - [ ] Slider de margem desejada (10% a 100%)
  - [ ] Card de resultado (atualiza em tempo real)
  - [ ] Botao "Salvar no produto" (PATCH /api/v1/produtos/[id])
  - [ ] Tooltips educativos (markup vs margem)
  - [ ] Historico recente em localStorage
- [ ] Adicionar link na sidebar ou no financeiro (AC: 4)
  - [ ] Adicionar "Precificacao" na sidebar com icone Calculator

## Dev Notes

**Source Tree relevante:**
```
src/
├── modules/precificacao/
│   ├── pricing.engine.ts              # Motor de calculo
│   ├── custo-fixo.service.ts          # CRUD custos fixos
│   └── precificacao.schema.ts         # Zod schemas
├── app/(dashboard)/precificacao/
│   ├── page.tsx                       # Calculadora principal
│   └── custos-fixos/page.tsx          # Config custos fixos
├── app/api/v1/
│   └── custos-fixos/
│       ├── route.ts                   # GET + POST
│       └── [id]/route.ts             # PUT + DELETE
```

**Depende de:** Nenhuma story nova. Usa ConfigFiscal para aliquota, FormaPagamento para taxa.

**CRITICO - Aliquota do Simples Nacional:**
- MEI: fixo (INSS + ISS ou ICMS), nao percentual sobre faturamento
- Simples Nacional: tabela progressiva por faixa de faturamento (6 anexos)
- Para MVP da calculadora: usar aliquota simplificada (input manual ou default)
  - Comercio: 6%
  - Servicos: 15.5%
  - Industria: 8.5%
- Evolucao futura: calcular pela tabela real com faturamento acumulado

**Arredondamento psicologico:**
- R$ 47,43 → R$ 47,90
- R$ 52,17 → R$ 52,90
- R$ 98,65 → R$ 99,90
- Regra: arredondar centavos para ,90 (se > ,50) ou ,90 do real anterior (se < ,50)

### Testing

- **Localizacao:** `tests/unit/modules/precificacao/`
- **Framework:** Vitest
- **Testes necessarios:**
  - pricing.engine: calcula preco corretamente com todos os custos
  - pricing.engine: formula inversa (precoVenda = custo / (1 - margem - imposto - taxa))
  - pricing.engine: arredondamento psicologico
  - pricing.engine: margem real calculada corretamente
  - pricing.engine: markup vs margem
  - custo-fixo.service: CRUD basico
  - calcularRateio: divide por media de vendas

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-09 | 1.0 | Criacao inicial da story | Sarah (PO) |

## Dev Agent Record
*A ser preenchido durante implementacao*

## QA Results
*A ser preenchido pelo QA agent*
