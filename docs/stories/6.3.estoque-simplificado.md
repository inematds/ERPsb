# Story 6.3: Estoque Simplificado

## Status: Ready for Review

## Story

**As a** usuario,
**I want** controlar meu estoque de forma simples,
**so that** eu saiba o que tenho disponivel e nao venda o que nao tenho.

## Acceptance Criteria

1. Model MovimentacaoEstoque no Prisma: id, tenantId, productId, type (ENTRADA/SAIDA/AJUSTE), quantity, reason (compra/venda/ajuste_manual), referenceId (saleId opcional), notes, createdAt
2. Saldo de estoque calculado como soma de movimentacoes (entradas - saidas) por produto
3. Tela de estoque: lista de produtos com saldo atual, alerta visual quando abaixo do minimo
4. Formulario de entrada manual: produto, quantidade, fornecedor (opcional), observacao
5. Saida automatica vinculada a vendas (ao confirmar venda, baixa automatica)
6. Ajuste manual de estoque com motivo obrigatorio
7. Historico de movimentacoes por produto com filtros
8. Alerta quando produto atinge estoque minimo (notificacao no dashboard + badge)
9. Produtos com estoque zero nao sao bloqueados na venda (aviso, nao bloqueio)

## Tasks / Subtasks

- [x] Adicionar models ao Prisma schema (AC: 1)
  - [x] MovimentacaoEstoque: id, tenantId, productId, type, quantity, reason, referenceId?, notes?, createdAt
  - [x] Produto already has stockMin and trackStock fields
  - [x] Relacao MovimentacaoEstoque -> Produto
  - [x] Rodar prisma generate
- [x] Criar estoque.service.ts (AC: 2, 5, 6, 8)
  - [x] `getSaldoEstoque(tenantId, productId)`: calcula saldo via groupBy
  - [x] `getSaldosTodos(tenantId)`: saldo de todos os produtos com trackStock
  - [x] `registrarEntrada(tenantId, data)`: cria movimentacao ENTRADA
  - [x] `registrarSaida(tenantId, productId, quantity, reason)`: cria movimentacao SAIDA
  - [x] `registrarAjuste(tenantId, data)`: cria movimentacao AJUSTE com motivo
  - [x] `registrarSaidaVenda(tenantId, saleId, items)`: baixa automatica por venda
  - [x] `listarMovimentacoes(tenantId, query)`: historico com filtros
  - [x] `getAlertasEstoque(tenantId)`: produtos abaixo do minimo
- [x] Criar estoque.schema.ts
  - [x] registrarEntradaSchema, registrarAjusteSchema, listMovimentacoesQuerySchema
- [x] Criar API routes (AC: 3, 4, 6, 7)
  - [x] GET `/api/v1/estoque` - lista saldos
  - [x] POST `/api/v1/estoque/entrada` - registrar entrada
  - [x] POST `/api/v1/estoque/ajuste` - registrar ajuste
  - [x] GET `/api/v1/estoque/movimentacoes` - historico
  - [x] GET `/api/v1/estoque/alertas` - produtos abaixo do minimo
- [x] Integrar saida automatica com vendas (AC: 5, 9)
  - [x] No venda.service.ts confirmarVenda: chamar registrarSaidaVenda (non-blocking)
- [x] Criar pagina de estoque (AC: 3, 4, 6, 7, 8)
  - [x] `src/app/(dashboard)/estoque/page.tsx` - lista saldos com alertas visuais
  - [x] Formulario de entrada manual
  - [x] Formulario de ajuste com motivo obrigatorio
- [x] Escrever testes
  - [x] Testes estoque service (10 tests)
  - [x] Testes estoque schema (12 tests)

## Dev Notes

**Depende de:** Epic 2 (produtos), Epic 4 (vendas)
**Campos Produto:** Adicionar estoqueMinimo e controlaEstoque ao model Produto existente.

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-07 | 1.0 | Criacao inicial da story | Sarah (PO) |

## Dev Agent Record

### Agent Model Used
Claude Opus 4.6 (claude-opus-4-6)

### Debug Log References
- No issues encountered

### Completion Notes List
- MovimentacaoEstoque model with types ENTRADA/SAIDA/AJUSTE, linked to Produto
- Saldo calculated via groupBy aggregation (entradas - saidas + ajustes)
- getSaldosTodos returns all tracked products with saldo, stockMin, abaixoMinimo flag
- Automatic stock deduction on venda confirmation (non-blocking, errors don't prevent sale)
- Estoque page with tabs: Saldos (with low-stock alerts), Entrada, Ajuste
- All 401 tests passing, TypeScript clean

### File List
- `prisma/schema.prisma` (modified - added MovimentacaoEstoque + Produto relation)
- `src/modules/estoque/estoque.schema.ts` (new)
- `src/modules/estoque/estoque.service.ts` (new)
- `src/modules/vendas/venda.service.ts` (modified - added registrarSaidaVenda call)
- `src/app/api/v1/estoque/route.ts` (new - GET saldos)
- `src/app/api/v1/estoque/entrada/route.ts` (new - POST)
- `src/app/api/v1/estoque/ajuste/route.ts` (new - POST)
- `src/app/api/v1/estoque/movimentacoes/route.ts` (new - GET)
- `src/app/api/v1/estoque/alertas/route.ts` (new - GET)
- `src/app/(dashboard)/estoque/page.tsx` (new)
- `tests/unit/modules/estoque/estoque-schema.test.ts` (new - 12 tests)
- `tests/unit/modules/estoque/estoque-service.test.ts` (new - 10 tests)

## QA Results
*A ser preenchido pelo QA agent*
