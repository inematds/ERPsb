# Story 6.3: Estoque Simplificado

## Status: Draft

## Story

**As a** usuario,
**I want** controlar meu estoque de forma simples,
**so that** eu saiba o que tenho disponivel e nao venda o que nao tenho.

## Acceptance Criteria

1. Model MovimentacaoEstoque no Prisma: id, tenantId, productId, type (ENTRADA/SAIDA/AJUSTE), quantity, reason (compra/venda/ajuste_manual), referenceId (saleId opcional), notes, createdAt
2. Saldo de estoque calculado como soma de movimentacoes (entradas - saidas) por produto
3. Tela de estoque: lista de produtos com saldo atual, alerta visual quando abaixo do minimo
4. Formulario de entrada manual: produto, quantidade, fornecedor (opcional), observacao
5. Saida automatica vinculada a vendas (ao confirmar venda, baixa automatica)
6. Ajuste manual de estoque com motivo obrigatorio
7. Historico de movimentacoes por produto com filtros
8. Alerta quando produto atinge estoque minimo (notificacao no dashboard + badge)
9. Produtos com estoque zero nao sao bloqueados na venda (aviso, nao bloqueio)

## Tasks / Subtasks

- [ ] Adicionar models ao Prisma schema (AC: 1)
  - [ ] MovimentacaoEstoque: id, tenantId, productId, type enum (ENTRADA/SAIDA/AJUSTE), quantity Int, reason String, referenceId String?, notes String?, createdAt
  - [ ] Adicionar campos no Produto: estoqueMinimo Int?, controlaEstoque Boolean default false
  - [ ] Relacao MovimentacaoEstoque -> Produto, Tenant
  - [ ] Rodar prisma generate
- [ ] Criar estoque.service.ts (AC: 2, 5, 6, 8)
  - [ ] `getSaldoEstoque(tenantId, productId)`: calcula saldo a partir de movimentacoes
  - [ ] `getSaldosTodos(tenantId)`: saldo de todos os produtos com controle de estoque
  - [ ] `registrarEntrada(tenantId, data)`: cria movimentacao ENTRADA
  - [ ] `registrarSaida(tenantId, data)`: cria movimentacao SAIDA
  - [ ] `registrarAjuste(tenantId, data)`: cria movimentacao AJUSTE com motivo obrigatorio
  - [ ] `registrarSaidaVenda(tenantId, saleId, items)`: baixa automatica por venda
  - [ ] `listarMovimentacoes(tenantId, query)`: historico com filtros
  - [ ] `getAlertasEstoque(tenantId)`: produtos abaixo do minimo
- [ ] Criar estoque.schema.ts
  - [ ] registrarEntradaSchema, registrarAjusteSchema, listMovimentacoesQuerySchema
- [ ] Criar API routes (AC: 3, 4, 6, 7)
  - [ ] GET `/api/v1/estoque` - lista saldos
  - [ ] POST `/api/v1/estoque/entrada` - registrar entrada
  - [ ] POST `/api/v1/estoque/ajuste` - registrar ajuste
  - [ ] GET `/api/v1/estoque/movimentacoes` - historico
  - [ ] GET `/api/v1/estoque/alertas` - produtos abaixo do minimo
- [ ] Integrar saida automatica com vendas (AC: 5, 9)
  - [ ] No venda.service.ts confirmarVenda: chamar registrarSaidaVenda
  - [ ] Aviso (nao bloqueio) quando estoque insuficiente
- [ ] Criar pagina de estoque (AC: 3, 4, 6, 7, 8)
  - [ ] `src/app/(dashboard)/estoque/page.tsx` - lista de saldos com alertas visuais
  - [ ] Formulario de entrada manual
  - [ ] Formulario de ajuste com motivo
  - [ ] Historico de movimentacoes por produto
- [ ] Escrever testes
  - [ ] Testes estoque service (saldo, entrada, saida, ajuste, alertas)
  - [ ] Testes estoque schema
  - [ ] Testes integracao com venda

## Dev Notes

**Depende de:** Epic 2 (produtos), Epic 4 (vendas)
**Campos Produto:** Adicionar estoqueMinimo e controlaEstoque ao model Produto existente.

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-07 | 1.0 | Criacao inicial da story | Sarah (PO) |

## Dev Agent Record

### Agent Model Used
Claude Opus 4.6 (claude-opus-4-6)

### Debug Log References
*To be filled during development*

### Completion Notes List
*To be filled during development*

### File List
*To be filled during development*

## QA Results
*A ser preenchido pelo QA agent*
