# Story 7.5: Historico de Capturas e Reprocessamento

## Status: Draft

## Story

**As a** usuario,
**I want** ver o historico de todas as fotos e anotacoes que enviei e reprocessar as que deram erro,
**so that** eu nao perca nenhuma nota e possa corrigir problemas.

## Acceptance Criteria

1. Pagina `/capturas` acessivel pelo menu do financeiro com lista de todas as capturas
2. Filtros: status (pendentes/aprovadas/rejeitadas/erro), tipo (nota/despesa/venda), periodo
3. Cada card exibe: thumbnail da foto, tipo, valor extraido, data, status badge
4. Capturas com status PENDENTE mostram botao "Revisar" (vai para tela de aprovacao)
5. Capturas com status ERRO mostram botao "Reprocessar" que reenvia para IA
6. Capturas APROVADAS mostram link para a entidade criada (conta a pagar ou venda)
7. Totalizador no topo: X pendentes, Y aprovadas, Z com erro
8. Indicador de uso mensal: "15 de 50 capturas usadas este mes" (conforme plano)
9. Paginacao com 20 itens por pagina
10. Acao em lote: selecionar multiplas capturas pendentes e aprovar/rejeitar

## Tasks / Subtasks

- [ ] Criar pagina de historico (AC: 1, 2, 3, 9)
  - [ ] Criar `src/app/(dashboard)/financeiro/capturas/page.tsx` como Client Component
  - [ ] Header com titulo "Capturas" e totalizadores (AC: 7)
  - [ ] Indicador de uso mensal (AC: 8)
  - [ ] Filtros: tabs de status, select de tipo, date range
  - [ ] Grid de cards com thumbnail, info e acoes
  - [ ] Paginacao
  - [ ] Empty state para cada filtro
- [ ] Criar cards de captura (AC: 3, 4, 5, 6)
  - [ ] Componente `CaptureCard` reutilizavel
  - [ ] Thumbnail da imagem (ou icone de texto para anotacoes)
  - [ ] Tipo badge (Nota, Despesa, Venda)
  - [ ] Valor extraido formatado
  - [ ] Data e hora
  - [ ] Status badge colorido (amarelo=pendente, verde=aprovado, cinza=rejeitado, vermelho=erro)
  - [ ] Botoes de acao conforme status:
    - PENDENTE: "Revisar" → link para `/financeiro/captura/[id]`
    - ERRO: "Reprocessar" → chama POST /api/v1/captures/[id]/reprocess
    - APROVADO: "Ver conta" ou "Ver venda" → link para entidade
- [ ] Criar endpoint de reprocessamento (AC: 5)
  - [ ] Criar `src/app/api/v1/captures/[id]/reprocess/route.ts` com POST
  - [ ] Busca DocumentCapture pelo id
  - [ ] Se tem imageUrl: reenvia para Claude Vision
  - [ ] Se tem rawText: reenvia para processamento de texto
  - [ ] Atualiza extractedData, confidence, processedAt
  - [ ] Reseta status para PENDENTE
- [ ] Criar endpoint de listagem (AC: 2, 7, 8, 9)
  - [ ] Criar `src/app/api/v1/captures/route.ts` com GET
  - [ ] Query params: page, pageSize, status, type, startDate, endDate
  - [ ] Retorna items + totais por status + uso mensal
- [ ] Acoes em lote (AC: 10)
  - [ ] Checkbox em cada card pendente
  - [ ] Barra de acoes fixa no bottom quando tem selecao: "Aprovar X selecionadas" | "Rejeitar"
  - [ ] Criar `src/app/api/v1/captures/batch/route.ts` com POST
  - [ ] Recebe `{ ids: string[], action: "approve" | "reject" }`
  - [ ] Processa cada captura sequencialmente
- [ ] Adicionar link no menu do financeiro (AC: 1)
  - [ ] Modificar `src/app/(dashboard)/financeiro/page.tsx`
  - [ ] Adicionar card "Capturas" com icone Camera e contagem de pendentes

## Dev Notes

**Source Tree relevante:**
```
src/
├── app/(dashboard)/financeiro/capturas/
│   └── page.tsx                       # Historico de capturas
├── app/api/v1/captures/
│   ├── route.ts                       # GET list
│   ├── [id]/
│   │   ├── approve/route.ts           # POST (Story 7.2)
│   │   ├── reject/route.ts            # POST (Story 7.2)
│   │   └── reprocess/route.ts         # POST reprocess
│   └── batch/route.ts                 # POST batch approve/reject
```

**Depende de:** Story 7.1, 7.2 (service de captura), 7.3 (opcional, para capturas de venda)

**Thumbnail de imagem:**
- Gerar thumbnail no upload (200x200) ou usar Supabase Image Transformations
- Se Supabase nao suporta, usar URL com query param `?width=200` (se CDN suporta)
- Fallback: mostrar imagem original com CSS `object-fit: cover` e dimensoes fixas

**Reprocessamento:**
- Util quando a IA falhou (imagem ruim, timeout, erro temporario)
- Cada reprocessamento conta como 1 captura no limite mensal
- Limitar a 3 reprocessamentos por captura (evitar loop infinito)

**Acoes em lote:**
- Aprovar em lote so funciona para capturas com extractedData valido
- Capturas com confidence < 0.5 devem mostrar aviso antes de aprovar em lote
- Processar sequencialmente (nao paralelo) para evitar race conditions no estoque

### Testing

- **Localizacao:** `tests/unit/modules/capture/`
- **Framework:** Vitest
- **Testes necessarios:**
  - Endpoint list: retorna capturas paginadas com filtros
  - Endpoint list: retorna totais por status
  - Endpoint reprocess: reenvia para IA e atualiza dados
  - Endpoint reprocess: respeita limite de 3 tentativas
  - Endpoint batch approve: aprova multiplas capturas
  - Endpoint batch reject: rejeita multiplas capturas

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-09 | 1.0 | Criacao inicial da story | Sarah (PO) |

## Dev Agent Record
*A ser preenchido durante implementacao*

## QA Results
*A ser preenchido pelo QA agent*
