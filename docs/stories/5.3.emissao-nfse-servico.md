# Story 5.3: Emissao de NFSe Nacional (Servico)

## Status: Ready for Review

## Story

**As a** prestador de servicos,
**I want** emitir NFSe Nacional pelo sistema,
**so that** eu cumpra a obrigacao fiscal sem complexidade.

## Acceptance Criteria

1. Integracao com Focus NFe API para emissao de NFSe Nacional
2. Botao "Emitir NFSe" disponivel quando venda contem servicos
3. Sistema determina automaticamente: codigo de servico, ISS, aliquota com base no municipio e regime
4. Campos NFSe Nacional preenchidos automaticamente a partir dos dados da venda e empresa
5. Preview antes de emitir
6. Emissao sync no MVP (BullMQ quando Redis disponivel)
7. XML armazenado, link para download
8. Campos CBS/IBS preparados

## Tasks / Subtasks

- [x] Adicionar NFSe ao Focus NFe client (AC: 1)
  - [x] `createNFSe(ref, nfseData, ambiente)`: POST /v2/nfse?ref={ref}
  - [x] `getNFSeStatus(ref, ambiente)`: GET /v2/nfse/{ref}
  - [x] `cancelNFSe(ref, motivo, ambiente)`: DELETE /v2/nfse/{ref}
  - [x] Mock mode para NFSe
- [x] Adicionar emissao NFSe ao nota fiscal service (AC: 1, 3, 4)
  - [x] `emitirNFSe(tenantId, saleId)`: detecta servicos na venda, monta payload NFSe Nacional, emite
  - [x] `buildNFSePayload(venda, configFiscal, tenant, numero)`: payload especifico NFSe
  - [x] `checkNotaStatus` atualizado para suportar NFSe
  - [x] `cancelarNota` atualizado para suportar NFSe
- [x] Atualizar schemas (AC: 3)
  - [x] Adicionar `emitirNFSeSchema` em nota-fiscal.schema.ts
- [x] Adicionar API route para emitir NFSe (AC: 2)
  - [x] Criar `src/app/api/v1/notas-fiscais/emitir-nfse/route.ts` com POST
- [x] Adicionar botao "Emitir NFSe" na venda (AC: 2)
  - [x] Botao visivel quando venda contem servicos e status === 'CONFIRMADA'
- [x] Escrever testes (AC: all)
  - [x] Testes de client NFSe (mock mode)
  - [x] Testes de service emitirNFSe
  - [x] Testes de schema emitirNFSeSchema

## Dev Notes

**Depende de:** Story 5.2 (Focus NFe client, nota fiscal service base)

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-07 | 1.0 | Criacao inicial da story | Sarah (PO) |

## Dev Agent Record

### Agent Model Used
Claude Opus 4.6 (claude-opus-4-6)

### Debug Log References
- No issues encountered.

### Completion Notes List
- Added createNFSe, getNFSeStatus, cancelNFSe to Focus NFe client with mock mode
- Added emitirNFSe to nota-fiscal.service with NFSe Nacional payload builder
- buildNFSePayload: prestador, tomador, servico fields per NFSe Nacional spec
- Updated checkNotaStatus and cancelarNota to dispatch to correct API (NFe vs NFSe) based on nota.type
- Added emitirNFSeSchema to nota-fiscal.schema.ts
- Added POST /api/v1/notas-fiscais/emitir-nfse API route
- Added "NFSe" button alongside "NFe" on venda detail page (CONFIRMADA status)
- 7 new tests (3 client NFSe + 2 service NFSe + 2 schema NFSe), 328 total passing
- TypeScript clean

### File List
- `src/integrations/fiscal-api/focusnfe.client.ts` (modified - added NFSe methods)
- `src/modules/fiscal/nota-fiscal.service.ts` (modified - added emitirNFSe, buildNFSePayload, updated check/cancel dispatching)
- `src/modules/fiscal/nota-fiscal.schema.ts` (modified - added emitirNFSeSchema)
- `src/app/api/v1/notas-fiscais/emitir-nfse/route.ts` (new - POST emitir NFSe)
- `src/app/(dashboard)/vendas/[id]/page.tsx` (modified - added NFSe button)
- `tests/unit/integrations/fiscal-api/focusnfe-client.test.ts` (modified - added 3 NFSe tests)
- `tests/unit/modules/fiscal/nota-fiscal-service.test.ts` (modified - added 2 NFSe tests)
- `tests/unit/modules/fiscal/nota-fiscal-schema.test.ts` (modified - added 2 NFSe tests)
- `docs/stories/5.3.emissao-nfse-servico.md` (modified)

## QA Results
*A ser preenchido pelo QA agent*
