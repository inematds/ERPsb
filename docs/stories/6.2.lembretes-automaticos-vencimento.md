# Story 6.2: Lembretes Automaticos de Vencimento

## Status: Draft

## Story

**As a** usuario,
**I want** que o sistema envie lembretes automaticos de cobranca,
**so that** meus clientes paguem em dia sem eu precisar cobrar manualmente.

## Acceptance Criteria

1. Configuracao de lembretes por tenant: ativar/desativar, dias antes (default: 3), no dia (default: sim), dias depois (default: 1)
2. Job agendado que verifica diariamente contas a receber proximas do vencimento
3. Envia mensagem WhatsApp automatica conforme configuracao do tenant
4. Nao reenvia se ja foi enviado para aquela conta naquele dia
5. Inclui link de pagamento PIX na mensagem (se cobranca PIX existir)
6. Registro de envio no historico de mensagens
7. Tenant pode desativar lembretes automaticos nas configuracoes

## Tasks / Subtasks

- [ ] Adicionar configuracao de lembretes ao tenant config
  - [ ] Model LembreteConfig ou campos em Tenant: lembreteAtivo, diasAntes, noDia, diasDepois
  - [ ] API route para atualizar configuracao
- [ ] Criar servico de lembretes (AC: 2, 3, 4, 5)
  - [ ] `processLembretes(tenantId)`: verifica contas a receber e envia
  - [ ] Logica de deduplicacao (nao reenviar no mesmo dia)
  - [ ] Montar mensagem com link PIX quando disponivel
- [ ] Criar API route para trigger manual e cron (AC: 2)
  - [ ] POST `/api/v1/whatsapp/processar-lembretes` - trigger manual
  - [ ] Vercel Cron via `vercel.json` ou API route com cron header
- [ ] Criar tela de configuracao de lembretes (AC: 1, 7)
  - [ ] Em configuracoes: toggles e campos de dias
- [ ] Escrever testes
  - [ ] Testes do servico de lembretes
  - [ ] Testes de deduplicacao
  - [ ] Testes de configuracao

## Dev Notes

**Depende de:** Story 6.1 (WhatsApp service)
**MVP simplification:** Cron via API route com Vercel Cron (sem BullMQ). Trigger manual disponivel.

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-07 | 1.0 | Criacao inicial da story | Sarah (PO) |

## Dev Agent Record

### Agent Model Used
Claude Opus 4.6 (claude-opus-4-6)

### Debug Log References
*To be filled during development*

### Completion Notes List
*To be filled during development*

### File List
*To be filled during development*

## QA Results
*A ser preenchido pelo QA agent*
