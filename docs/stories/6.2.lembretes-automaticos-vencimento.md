# Story 6.2: Lembretes Automaticos de Vencimento

## Status: Ready for Review

## Story

**As a** usuario,
**I want** que o sistema envie lembretes automaticos de cobranca,
**so that** meus clientes paguem em dia sem eu precisar cobrar manualmente.

## Acceptance Criteria

1. Configuracao de lembretes por tenant: ativar/desativar, dias antes (default: 3), no dia (default: sim), dias depois (default: 1)
2. Job agendado que verifica diariamente contas a receber proximas do vencimento
3. Envia mensagem WhatsApp automatica conforme configuracao do tenant
4. Nao reenvia se ja foi enviado para aquela conta naquele dia
5. Inclui link de pagamento PIX na mensagem (se cobranca PIX existir)
6. Registro de envio no historico de mensagens
7. Tenant pode desativar lembretes automaticos nas configuracoes

## Tasks / Subtasks

- [x] Adicionar configuracao de lembretes ao tenant config
  - [x] Model LembreteConfig: ativo, diasAntes, noDia, diasDepois
  - [x] API route GET/PUT para configuracao
- [x] Criar servico de lembretes (AC: 2, 3, 4, 5)
  - [x] `processLembretes(tenantId)`: verifica contas a receber e envia
  - [x] Logica de deduplicacao (nao reenviar no mesmo dia)
  - [x] Montar mensagem com link PIX quando disponivel
- [x] Criar API route para trigger manual e cron (AC: 2)
  - [x] POST `/api/v1/whatsapp/processar-lembretes` - trigger manual
- [x] Criar tela de configuracao de lembretes (AC: 1, 7)
  - [x] Em configuracoes/lembretes: toggles e campos de dias
- [x] Escrever testes
  - [x] Testes do servico de lembretes (8 tests)
  - [x] Testes de deduplicacao
  - [x] Testes de configuracao (5 tests)

## Dev Notes

**Depende de:** Story 6.1 (WhatsApp service)
**MVP simplification:** Cron via API route com Vercel Cron (sem BullMQ). Trigger manual disponivel.

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-07 | 1.0 | Criacao inicial da story | Sarah (PO) |

## Dev Agent Record

### Agent Model Used
Claude Opus 4.6 (claude-opus-4-6)

### Debug Log References
- Fixed missing @/components/ui/label - replaced with native HTML label element

### Completion Notes List
- LembreteConfig model added to Prisma (ativo, diasAntes, noDia, diasDepois per tenant)
- Lembrete service with processLembretes that finds pending contas a receber matching date criteria
- Deduplication: checks WhatsAppMessage by clientId + type + createdAt date range
- PIX link included when available from pending PixCharge
- Config page at /configuracoes/lembretes with toggles and number inputs
- Manual trigger via POST /whatsapp/processar-lembretes
- All 379 tests passing, TypeScript clean

### File List
- `prisma/schema.prisma` (modified - added LembreteConfig model + Tenant relation)
- `src/modules/whatsapp/lembrete.schema.ts` (new)
- `src/modules/whatsapp/lembrete.service.ts` (new)
- `src/app/api/v1/whatsapp/lembretes/route.ts` (new - GET/PUT)
- `src/app/api/v1/whatsapp/processar-lembretes/route.ts` (new - POST)
- `src/app/(dashboard)/configuracoes/lembretes/page.tsx` (new)
- `tests/unit/modules/whatsapp/lembrete-schema.test.ts` (new - 5 tests)
- `tests/unit/modules/whatsapp/lembrete-service.test.ts` (new - 8 tests)

## QA Results
*A ser preenchido pelo QA agent*
