# Story 8.4: Insights e Recomendacoes Proativas

## Status: Draft

## Story

**As a** usuario,
**I want** receber insights automaticos sobre meu negocio sem precisar perguntar,
**so that** eu descubra oportunidades e problemas antes que seja tarde.

## Acceptance Criteria

1. Job diario (cron) que analisa dados do tenant e gera insights
2. Insights aparecem como cards no Dashboard (abaixo dos alertas existentes)
3. Insights tambem ficam disponiveis no chat ("quais insights voce tem pra mim?")
4. Tipos de insights:
   - **Tendencia de vendas:** "Suas vendas cairam 20% essa semana. Na semana passada foram R$ 3.200, essa foram R$ 2.560"
   - **Produto em alta/baixa:** "Camiseta P vendeu 40% mais que o normal esse mes"
   - **Cliente em risco:** "Joao costumava comprar toda semana, mas nao compra ha 3 semanas"
   - **Oportunidade de cobranca:** "Voce tem R$ 4.500 em contas a receber vencidas. Top 3: Maria (R$ 1.800), Pedro (R$ 1.500)..."
   - **Margem em risco:** "Kit Presente esta com margem de -3%. Considere ajustar o preco" (requer Epic 9)
   - **Sazonalidade:** "Historicamente, marco e seu melhor mes. Prepare estoque!"
5. Cada insight tem nivel: INFO, ATENCAO, URGENTE
6. Insights podem ser descartados ("ja vi isso")
7. Maximo 5 insights ativos por vez (nao sobrecarregar)
8. Notificacao push quando insight URGENTE e gerado

## Tasks / Subtasks

- [ ] Criar model Insight no Prisma (AC: 1)
  - [ ] Model: id, tenantId, type, level (INFO/ATENCAO/URGENTE), title, description, metadata (Json), actionUrl, dismissed, createdAt
  - [ ] Index: [tenantId, dismissed, createdAt]
- [ ] Criar engine de insights (AC: 1, 4)
  - [ ] Criar `src/modules/chat/insights.engine.ts`
  - [ ] Funcao generateInsights(tenantId): roda todas as analises
  - [ ] Cada analise e uma funcao independente:
    - analyzeSalesTrend(): compara vendas ultima semana vs semana anterior
    - analyzeProductTrend(): identifica produtos com variacao > 30%
    - analyzeClientRisk(): clientes inativos que eram frequentes
    - analyzeReceivables(): total vencido e top devedores
    - analyzeSeasonality(): comparar mes atual com mesmo mes ano passado
  - [ ] Cada funcao retorna 0 ou 1 insight
  - [ ] Limitar a 5 insights ativos (priorizar por nivel)
- [ ] Criar cron job (AC: 1)
  - [ ] Criar `src/app/api/v1/insights/generate/route.ts`
  - [ ] Roda para todos os tenants ativos
  - [ ] Adicionar no `vercel.json` crons (diario as 7h)
- [ ] Exibir no Dashboard (AC: 2)
  - [ ] Criar `src/components/dashboard/insights-cards.tsx`
  - [ ] Cards com icone de nivel (info=azul, atencao=amarelo, urgente=vermelho)
  - [ ] Botao "Entendi" para descartar
  - [ ] Link de acao quando aplicavel
- [ ] Disponibilizar no chat (AC: 3)
  - [ ] Adicionar funcao getInsights() nas chat-functions
  - [ ] IA pode listar insights quando perguntado
- [ ] Notificacao push para urgentes (AC: 8)
  - [ ] Criar Notification interna quando insight URGENTE
  - [ ] Se WhatsApp configurado, enviar resumo matinal

## Dev Notes

**Depende de:** Story 8.1 (infra chat, para exibir no chat), Dashboard existente (para exibir cards)

**CRITICO - Performance do cron:**
- Roda para todos os tenants â†’ pode ser pesado
- Processar em batches de 10 tenants
- Timeout do Vercel cron: 60 segundos
- Se exceder, dividir em chunks (paginar tenants)

**Insights vs Alertas existentes:**
- Alertas (Story 3.4): regras fixas, tempo real (contas vencidas, estoque baixo)
- Insights (esta story): analise de tendencias, comparativos, recomendacoes
- Exibir em secoes separadas no Dashboard

### Testing

- **Testes necessarios:**
  - analyzeSalesTrend: detecta queda > 15%
  - analyzeProductTrend: identifica variacao > 30%
  - analyzeClientRisk: identifica clientes inativos que eram frequentes
  - generateInsights: limita a 5 insights
  - generateInsights: prioriza por nivel

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-09 | 1.0 | Criacao inicial da story | Sarah (PO) |

## Dev Agent Record
*A ser preenchido durante implementacao*

## QA Results
*A ser preenchido pelo QA agent*
