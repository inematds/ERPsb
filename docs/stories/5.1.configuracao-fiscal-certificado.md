# Story 5.1: Configuracao Fiscal e Certificado Digital

## Status: Ready for Review

## Story

**As a** usuario,
**I want** configurar meu certificado digital e dados fiscais,
**so that** eu possa emitir notas fiscais pelo sistema.

## Acceptance Criteria

1. Model ConfigFiscal no Prisma: id, tenantId, regimeTributario (MEI/SimplesNacional/LucroPresumido/LucroReal), inscricaoEstadual, inscricaoMunicipal, certificateData (base64 - encrypted), certificatePassword (criptografado), certificateExpiry, ambiente (homologacao/producao), serieNFe, serieNFSe, serieNFCe, ultimoNumeroNFe, ultimoNumeroNFSe, ultimoNumeroNFCe
2. Tela de configuracao fiscal com:
   - Selecao de regime tributario (com explicacao simples de cada)
   - Upload de certificado digital A1 (.pfx) com armazenamento seguro
   - Campos de inscricao estadual e municipal
   - Toggle ambiente: homologacao (testes) / producao
3. Validacao do certificado: verifica se e A1, se nao esta expirado, exibe data de vencimento
4. Alerta quando certificado esta a 30 dias de expirar
5. Sistema determina automaticamente configuracoes fiscais com base no regime tributario

## Tasks / Subtasks

- [x] Adicionar model ConfigFiscal ao Prisma schema (AC: 1)
  - [x] Model `ConfigFiscal`: id, tenantId (unique FK), regimeTributario (String?), inscricaoEstadual (String?), inscricaoMunicipal (String?), certificateData (String? - encrypted base64 of .pfx), certificatePassword (String? - AES-256-GCM encrypted), certificateExpiry (DateTime?), ambiente (String default "homologacao"), serieNFe (Int default 1), serieNFSe (Int default 1), serieNFCe (Int default 1), ultimoNumeroNFe (Int default 0), ultimoNumeroNFSe (Int default 0), ultimoNumeroNFCe (Int default 0), createdAt, updatedAt
  - [x] Adicionar `configFiscal ConfigFiscal?` no model Tenant
  - [x] Adicionar `notasFiscais NotaFiscal[]` no model Tenant (para Story 5.2)
  - [x] Adicionar `notaFiscalId String?` e `notaFiscal NotaFiscal?` no model Venda (para Story 5.2)
  - [x] Model `NotaFiscal`: id, tenantId (FK), type (String: "NFE"/"NFSE"/"NFCE"), saleId (String? FK Venda), numero (Int?), serie (Int?), chaveAcesso (String?), xmlContent (String? - XML text), pdfUrl (String?), status (String: "PROCESSANDO"/"AUTORIZADA"/"REJEITADA"/"CANCELADA"), focusNfeId (String?), errorMessage (String?), emitidaEm (DateTime?), canceladaEm (DateTime?), motivoCancelamento (String?), dadosNota (Json - snapshot dos dados da nota), createdAt
  - [x] Indices: ConfigFiscal `@@index([tenantId])` com unique, NotaFiscal `@@index([tenantId, type, status])`, `@@index([saleId])`
  - [x] Executar `npx prisma generate`
- [x] Adicionar env vars para Focus NFe (AC: 1)
  - [x] `FOCUS_NFE_TOKEN` (optional) em `src/lib/env.ts`
  - [x] `FOCUS_NFE_AMBIENTE` (optional, default homologacao) em `src/lib/env.ts`
- [x] Criar crypto helpers para certificado (AC: 1, 3)
  - [x] Criar `src/lib/crypto.ts`
  - [x] `encryptString(plaintext)`: AES-256-GCM encrypt using NEXTAUTH_SECRET
  - [x] `decryptString(ciphertext)`: AES-256-GCM decrypt
  - [x] `parseCertificate(pfxBase64, password)`: valida certificado A1 usando node-forge, extrai expiry date, retorna { valid, expiry, subject, issuer }
- [x] Criar fiscal helpers (AC: 5)
  - [x] Criar `src/modules/fiscal/fiscal.helpers.ts`
  - [x] `getRegimeDefaults(regime)`: retorna configuracoes default por regime (CST, CFOP, aliquotas base)
  - [x] `REGIMES_INFO`: mapa com nome, descricao simples de cada regime
  - [x] `CFOP_TABLE`: tabela basica de CFOPs mais usados (5102 venda mercadoria, 5933 servico, etc.)
  - [x] `CST_TABLE`: tabela de CSTs por regime (Simples usa CSOSN)
- [x] Criar Zod schemas de config fiscal (AC: 1, 2)
  - [x] Criar `src/modules/fiscal/config-fiscal.schema.ts`
  - [x] `updateConfigFiscalSchema`: regimeTributario (enum), inscricaoEstadual, inscricaoMunicipal, ambiente (enum), series
  - [x] `uploadCertificateSchema`: certificateData (base64 string), certificatePassword (string)
- [x] Criar config fiscal service (AC: 1, 3, 4, 5)
  - [x] Criar `src/modules/fiscal/config-fiscal.service.ts`
  - [x] `getConfigFiscal(tenantId)`: busca config, retorna null se nao existe
  - [x] `upsertConfigFiscal(tenantId, data)`: cria ou atualiza config
  - [x] `uploadCertificate(tenantId, base64Data, password)`: valida cert, encrypta, salva
  - [x] `removeCertificate(tenantId)`: remove certificado
  - [x] `checkCertificateExpiry(tenantId)`: verifica se esta a 30 dias de expirar
  - [x] `incrementNumero(tenantId, tipo)`: incrementa ultimoNumero e retorna proximo
- [x] Criar API routes de config fiscal (AC: 2)
  - [x] Criar `src/app/api/v1/config-fiscal/route.ts` com GET e PUT
  - [x] Criar `src/app/api/v1/config-fiscal/certificado/route.ts` com POST (upload) e DELETE (remove)
  - [x] Todos com withTenantApi
- [x] Criar pagina de configuracao fiscal (AC: 2, 3, 4)
  - [x] Criar `src/app/(dashboard)/fiscal/config/page.tsx`
  - [x] Form com selecao de regime tributario (cards com descricao simples)
  - [x] Campos inscricao estadual e municipal
  - [x] Toggle ambiente homologacao/producao
  - [x] Secao upload certificado com drag-and-drop ou file input
  - [x] Exibir data de vencimento do certificado apos upload
  - [x] Alerta visual quando certificado a 30 dias de expirar ou expirado
- [x] Escrever testes (AC: all)
  - [x] `tests/unit/modules/fiscal/config-fiscal-schema.test.ts`: schema validation tests
  - [x] `tests/unit/modules/fiscal/config-fiscal-service.test.ts`: service tests
  - [x] `tests/unit/modules/fiscal/fiscal-helpers.test.ts`: helper function tests
  - [x] `tests/unit/lib/crypto.test.ts`: encrypt/decrypt/parseCertificate tests

## Dev Notes

**Depende de:** Epic 4 completo

**Source Tree relevante:**
```
src/
├── lib/
│   └── crypto.ts                     # AES-256-GCM + certificate parsing
├── modules/fiscal/
│   ├── config-fiscal.service.ts     # Config fiscal CRUD
│   ├── config-fiscal.schema.ts      # Zod schemas
│   └── fiscal.helpers.ts            # CFOP, CST, regime defaults
├── app/api/v1/
│   └── config-fiscal/
│       ├── route.ts                 # GET/PUT config
│       └── certificado/route.ts     # POST upload / DELETE remove
└── app/(dashboard)/fiscal/
    └── config/page.tsx              # Config page
```

**CRITICO - Armazenamento de certificado:**
- MVP armazena certificado como base64 encriptado no banco (sem Supabase Storage)
- Password encriptado com AES-256-GCM usando NEXTAUTH_SECRET como chave base
- Quando Supabase Storage for configurado, migrar para armazenamento externo

**CRITICO - Validacao de certificado:**
- Usar `node-forge` para parsear .pfx (PKCS#12)
- Verificar: formato A1, nao expirado, extrair data expiry
- Se node-forge nao estiver instalado, aceitar sem validacao (fallback)

**CRITICO - Notasfiscais model adiantado:**
- O model NotaFiscal eh criado nesta story junto com ConfigFiscal
- Isso evita migration separada na Story 5.2
- O model Venda ganha campo notaFiscalId para vinculacao

**Regime tributario defaults:**
- MEI: Simples Nacional, CSOSN 102 (sem imposto pois isento), serie 1
- Simples Nacional: CSOSN 101-900, aliquota por faixa de faturamento
- Lucro Presumido: CST 00/10/20/60, CFOP 5102/6102
- Lucro Real: CST completo, obrigacoes acessorias

**Ambiente:**
- homologacao: testes na Sefaz (sem validade fiscal)
- producao: notas com validade fiscal real

### Testing

- **Localizacao:** `tests/unit/modules/fiscal/` e `tests/unit/lib/`
- **Framework:** Vitest
- **Testes necessarios:**
  - Config schema: updateConfigFiscalSchema valida regime, rejeita invalido
  - Config schema: uploadCertificateSchema valida base64 e password
  - Config service: getConfigFiscal retorna null quando nao existe
  - Config service: upsertConfigFiscal cria nova config
  - Config service: upsertConfigFiscal atualiza config existente
  - Config service: uploadCertificate encrypta e salva
  - Config service: checkCertificateExpiry detecta certificado proximo do vencimento
  - Config service: incrementNumero incrementa e retorna proximo
  - Fiscal helpers: getRegimeDefaults retorna defaults corretos por regime
  - Fiscal helpers: CFOP_TABLE contem CFOPs essenciais
  - Crypto: encryptString/decryptString round-trip
  - Crypto: decryptString com chave errada falha
- **Mocks:** Mock do `prisma`, mock do `node-forge` no parseCertificate

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-07 | 1.0 | Criacao inicial da story | Sarah (PO) |
| 2026-02-07 | 1.1 | Detalhamento completo das tasks | James (Dev) |

## Dev Agent Record

### Agent Model Used
Claude Opus 4.6 (claude-opus-4-6)

### Debug Log References
- Fix: `decryptString` failed on empty string because encrypted portion was empty string (falsy). Changed check from `!encrypted` to `encrypted === undefined`.

### Completion Notes List
- ConfigFiscal Prisma model: tenantId (unique), regimeTributario, inscricaoEstadual/Municipal, certificateData/Password (encrypted), certificateExpiry, ambiente (homologacao/producao), series and ultimo numeros for NFe/NFSe/NFCe
- NotaFiscal Prisma model: tenantId FK, type (NFE/NFSE/NFCE), saleId FK Venda, numero, serie, chaveAcesso, xmlContent, pdfUrl, status (PROCESSANDO/AUTORIZADA/REJEITADA/CANCELADA), focusNfeId, dadosNota (Json snapshot)
- Added configFiscal and notasFiscais relations to Tenant, notasFiscais to Venda
- crypto.ts: AES-256-GCM encrypt/decrypt using NEXTAUTH_SECRET, parseCertificate with node-forge for PKCS#12 validation
- fiscal.helpers.ts: REGIMES_INFO, getRegimeDefaults (CST/CSOSN, CFOP per regime), CFOP_TABLE, CST_ICMS_TABLE, CSOSN_TABLE
- config-fiscal.schema.ts: updateConfigFiscalSchema (regime, inscricoes, ambiente, series), uploadCertificateSchema
- config-fiscal.service.ts: getConfigFiscal (strips sensitive data), upsertConfigFiscal, uploadCertificate (validates + encrypts), removeCertificate, checkCertificateExpiry (30-day warning), incrementNumero, getDecryptedCertificate
- API routes: GET/PUT /api/v1/config-fiscal, POST/DELETE /api/v1/config-fiscal/certificado
- Config page: regime selection cards, inscricoes fields, ambiente toggle (homologacao/producao), certificate upload (.pfx) with expiry display and alerts, series configuration
- FOCUS_NFE_TOKEN env var added (optional)
- node-forge dependency added for certificate parsing
- 38 new tests (12 schema + 10 service + 10 helpers + 6 crypto), 290 total passing
- TypeScript clean

### File List
- `prisma/schema.prisma` (modified - added ConfigFiscal, NotaFiscal models, relations on Tenant and Venda)
- `src/lib/env.ts` (modified - added FOCUS_NFE_TOKEN)
- `src/lib/crypto.ts` (new - AES-256-GCM encrypt/decrypt + certificate parsing)
- `src/modules/fiscal/fiscal.helpers.ts` (new - regime defaults, CFOP/CST/CSOSN tables)
- `src/modules/fiscal/config-fiscal.schema.ts` (new - Zod schemas)
- `src/modules/fiscal/config-fiscal.service.ts` (new - config fiscal CRUD + certificate management)
- `src/app/api/v1/config-fiscal/route.ts` (new - GET/PUT config)
- `src/app/api/v1/config-fiscal/certificado/route.ts` (new - POST upload / DELETE remove certificate)
- `src/app/(dashboard)/fiscal/config/page.tsx` (new - config page)
- `tests/unit/lib/crypto.test.ts` (new - 6 tests)
- `tests/unit/modules/fiscal/config-fiscal-schema.test.ts` (new - 12 tests)
- `tests/unit/modules/fiscal/config-fiscal-service.test.ts` (new - 10 tests)
- `tests/unit/modules/fiscal/fiscal-helpers.test.ts` (new - 10 tests)
- `docs/stories/5.1.configuracao-fiscal-certificado.md` (new)
- `docs/stories/5.2.emissao-nfe-produto.md` (new - draft)
- `docs/stories/5.3.emissao-nfse-servico.md` (new - draft)
- `docs/stories/5.4.emissao-nfce-fluxo-fiscal.md` (new - draft)

## QA Results
*A ser preenchido pelo QA agent*
