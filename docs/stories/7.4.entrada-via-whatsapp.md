# Story 7.4: Entrada de Dados via WhatsApp

## Status: Draft

## Story

**As a** usuario,
**I want** enviar uma foto de nota ou uma mensagem de texto pelo WhatsApp e ter os dados registrados no sistema,
**so that** eu use o canal que ja estou acostumado sem precisar abrir o app.

## Acceptance Criteria

1. Webhook do WhatsApp recebe mensagens de midia (foto) e texto dos usuarios cadastrados
2. Sistema identifica o tenant pelo numero de telefone do remetente
3. Para foto recebida: baixa a imagem, processa com IA (mesmo fluxo da Story 7.2)
4. Para texto recebido: interpreta como anotacao (mesmo fluxo da Story 7.3)
5. Apos processar, envia mensagem de volta pelo WhatsApp com resumo dos dados extraidos
6. Mensagem de confirmacao com opcoes: "Aprovar" (responder 1) ou "Rejeitar" (responder 2) ou "Editar no app" (link)
7. Se usuario responde "1" (aprovar): cria a entidade automaticamente, envia confirmacao
8. Se usuario responde "2" (rejeitar): marca como rejeitado, envia confirmacao
9. Se usuario responde com link ou qualquer outra coisa: envia link para editar no app
10. Mensagem de boas-vindas quando usuario envia primeira mensagem ("Oi! Mande uma foto de nota ou descreva sua venda")
11. Sistema distingue automaticamente entre nota/despesa e venda pelo conteudo da IA
12. Timeout de 30 minutos para confirmacao (apos isso, captura fica pendente no app)

## Tasks / Subtasks

- [ ] Estender webhook WhatsApp para receber midia (AC: 1)
  - [ ] Modificar `src/app/api/webhooks/whatsapp/route.ts`
  - [ ] Detectar tipo de mensagem: texto, imagem, documento
  - [ ] Para imagem: baixar midia via WhatsApp Business API (GET media URL)
  - [ ] Salvar imagem no Supabase Storage
- [ ] Identificar tenant pelo telefone (AC: 2)
  - [ ] Criar funcao `findTenantByPhone(phone)` no capture.service
  - [ ] Buscar User pelo telefone do remetente
  - [ ] Resolver tenantId via UserTenant
  - [ ] Se nao encontrar, ignorar mensagem (ou enviar "Numero nao cadastrado")
- [ ] Processar mensagem recebida (AC: 3, 4, 11)
  - [ ] Criar `src/modules/capture/whatsapp-capture.service.ts`
  - [ ] Funcao `processIncomingMessage(phone, type, content)`:
    - Identifica tenant
    - Se imagem: upload + processCapture (tipo auto-detectado pela IA)
    - Se texto: processCapture com rawText
    - IA determina tipo (DESPESA, NOTA_FORNECEDOR ou VENDA) automaticamente
- [ ] Enviar resumo para confirmacao (AC: 5, 6)
  - [ ] Apos processamento, formatar mensagem com resumo:
    ```
    Entendi! Aqui esta o que encontrei:

    Nota de Fornecedor - Distribuidora ABC
    - 10x Camiseta P branca: R$ 150,00
    - 5x Bermuda GG: R$ 125,00
    Total: R$ 275,00

    Responda:
    1 - Aprovar e registrar
    2 - Rejeitar
    Ou acesse: [link para /financeiro/captura/{id}]
    ```
  - [ ] Enviar via whatsapp.client.sendText()
  - [ ] Salvar estado da conversa (captureId + aguardando resposta)
- [ ] Processar resposta do usuario (AC: 7, 8, 9)
  - [ ] No webhook, detectar resposta a uma captura pendente
  - [ ] Manter mapa de conversas ativas: `{ phone -> captureId, expiresAt }`
  - [ ] "1" ou "sim" ou "aprovar" → approveCapture()
  - [ ] "2" ou "nao" ou "rejeitar" → rejectCapture()
  - [ ] Qualquer outra coisa → enviar link para editar no app
  - [ ] Enviar confirmacao do resultado
- [ ] Mensagem de boas-vindas (AC: 10)
  - [ ] Se nao ha captura pendente e mensagem nao e resposta:
    ```
    Ola! Sou o assistente do ERPsb.

    Mande uma foto de nota/cupom para registrar uma despesa,
    ou descreva uma venda em texto.

    Exemplos:
    - Foto de nota fiscal
    - "3 camisetas P pro Joao, pago no PIX"
    ```
- [ ] Timeout de confirmacao (AC: 12)
  - [ ] Conversas ativas expiram em 30 minutos
  - [ ] Apos timeout, captura fica PENDENTE no app (acessivel via /financeiro/captura)
  - [ ] Nao enviar mensagem de timeout (evitar spam)
- [ ] Adicionar campo phone no User (AC: 2)
  - [ ] Se User nao tem campo phone, adicionar ao schema
  - [ ] Ou usar campo existente para matching

## Dev Notes

**Source Tree relevante:**
```
src/
├── app/api/webhooks/whatsapp/route.ts  # Webhook (modificar)
├── modules/capture/
│   └── whatsapp-capture.service.ts     # Logica de captura via WhatsApp
├── integrations/whatsapp/
│   └── whatsapp.client.ts              # Adapter (ja existe)
```

**Depende de:** Story 7.1 (infra IA), Story 7.2 (processamento de foto), Story 7.3 (processamento de texto), Story 6.1 (WhatsApp adapter)

**CRITICO - Estado da conversa:**
- Usar cache em memoria (ou Redis se escalar) para manter estado
- Formato: `Map<phone, { captureId, type, expiresAt }>`
- Em ambiente serverless (Vercel), usar KV store ou campo no DocumentCapture
- Alternativa simples: campo `whatsappPhone` + `whatsappPendingAt` no DocumentCapture

**CRITICO - Seguranca:**
- Validar que o telefone pertence a um usuario cadastrado
- Nao processar mensagens de numeros desconhecidos
- Rate limit: max 10 mensagens/hora por numero
- Nao expor dados sensiveis na mensagem de resumo

**CRITICO - WhatsApp Business API:**
- Receber midia requer download via API (GET /media/{mediaId})
- Formato da midia: base64 ou URL temporaria (depende do provider)
- Imagens recebidas geralmente em JPEG, resolucao variavel
- Mensagens interativas (botoes) podem ser usadas no lugar de "responda 1/2"
  - Depende se o provider suporta (Evolution API, Meta Cloud API, etc.)

**Fluxo completo:**
```
Usuario envia foto → Webhook recebe → Identifica tenant →
Baixa imagem → Upload Storage → Processa com IA →
Envia resumo WhatsApp → Aguarda resposta →
"1" → Aprova → Envia confirmacao
"2" → Rejeita → Envia confirmacao
Timeout → Fica pendente no app
```

### Testing

- **Localizacao:** `tests/unit/modules/capture/`
- **Framework:** Vitest
- **Testes necessarios:**
  - findTenantByPhone: encontra tenant por numero
  - findTenantByPhone: retorna null para numero desconhecido
  - processIncomingMessage: foto → processCapture tipo auto
  - processIncomingMessage: texto → processCapture tipo auto
  - Resposta "1" → approveCapture
  - Resposta "2" → rejectCapture
  - Timeout: captura nao confirmada permanece PENDENTE

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-09 | 1.0 | Criacao inicial da story | Sarah (PO) |

## Dev Agent Record
*A ser preenchido durante implementacao*

## QA Results
*A ser preenchido pelo QA agent*
