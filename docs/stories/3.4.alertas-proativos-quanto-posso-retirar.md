# Story 3.4: Alertas Proativos e "Quanto Posso Retirar?"

## Status: Draft

## Story

**As a** usuario,
**I want** receber alertas quando meu caixa estiver em risco e saber quanto posso retirar com seguranca,
**so that** eu tome melhores decisoes financeiras.

## Acceptance Criteria

1. Calculos diarios de alerta: contas a pagar nos proximos 7 dias vs saldo atual, despesas previstas 30 dias > receitas previstas, contas vencidas nao pagas
2. Cards de alerta exibidos no topo do dashboard com icones e cores (vermelho para critico, amarelo para atencao)
3. "Quanto posso retirar?": calculo = Saldo Atual - (contas a pagar 30 dias) - (10% reserva de seguranca da receita media mensal)
4. Exibicao: "Voce pode retirar ate R$ X. Depois disso, seu caixa fica apertado."
5. Resumo financeiro mensal em linguagem humana: "Esse mes voce recebeu R$ X e gastou R$ Y"
6. Alertas nao intrusivos mas visiveis

## Tasks / Subtasks

- [ ] Criar service de alertas (AC: 1, 3)
  - [ ] Criar `src/modules/financeiro/alerta.service.ts`
  - [ ] Funcao `getAlertas()`: retorna array de alertas:
    - Alerta "contas_vencidas": contas com status PENDENTE e dueDate < hoje (conta quantas e valor total)
    - Alerta "contas_proximos_7_dias": soma de contas a pagar pendentes com dueDate nos proximos 7 dias vs saldo
    - Alerta "caixa_apertado_30_dias": se despesas previstas 30 dias > receitas previstas 30 dias
  - [ ] Funcao `calcularQuantoPossoRetirar()`: retorna valor em centavos
    - saldoAtual (do dashboard service)
    - contasPagar30dias: soma de contas a pagar pendentes com dueDate nos proximos 30 dias
    - receitaMediaMensal: media dos ultimos 3 meses de receitas recebidas
    - reservaSeguranca = receitaMediaMensal * 0.10
    - retiravel = saldoAtual - contasPagar30dias - reservaSeguranca
    - Se retiravel < 0, retorna 0
  - [ ] Funcao `getResumoMensal()`: retorna receitas e despesas do mes corrente em centavos
- [ ] Criar Zod schemas (AC: 1)
  - [ ] Criar tipos TypeScript para Alert (`AlertType`, `Alert`) no alerta.service.ts ou schema separado
  - [ ] Tipo Alert: { type: string, severity: 'critical' | 'warning' | 'info', title: string, message: string, amount?: number }
- [ ] Criar API routes de alertas (AC: 1, 3, 5)
  - [ ] Criar `src/app/api/v1/alertas/route.ts` com GET
  - [ ] Retorna: { alertas: Alert[], quantoPossoRetirar: number, resumoMensal: { receitas: number, despesas: number } }
  - [ ] Usa `withTenantApi`
- [ ] Criar componente de cards de alerta (AC: 2, 6)
  - [ ] Criar `src/components/dashboard/alert-cards.tsx`
  - [ ] Renderiza lista de alertas como cards coloridos
  - [ ] Icones: AlertTriangle para critico (vermelho), AlertCircle para atencao (amarelo), Info para info (azul)
  - [ ] Cada card mostra: titulo, mensagem, valor (se aplicavel) formatado em R$
  - [ ] Cards podem ser dispensados (estado local, volta ao recarregar)
- [ ] Criar componente "Quanto posso retirar?" (AC: 3, 4)
  - [ ] Criar `src/components/dashboard/withdrawal-card.tsx`
  - [ ] Card com icone de carteira/dinheiro
  - [ ] Texto principal: "Voce pode retirar ate R$ X" (formatado)
  - [ ] Subtexto: "Depois disso, seu caixa fica apertado para os proximos 30 dias."
  - [ ] Se valor = 0: "No momento, nao recomendamos retirar. Seu caixa esta comprometido."
  - [ ] Cor do card: verde se > 0, amarelo se > 0 mas < 10% do saldo, vermelho se = 0
- [ ] Criar componente de resumo mensal (AC: 5)
  - [ ] Criar `src/components/dashboard/monthly-summary.tsx`
  - [ ] Texto: "Esse mes voce recebeu R$ X e gastou R$ Y"
  - [ ] Se receitas > despesas: "Otimo! Voce esta no positivo." (verde)
  - [ ] Se despesas > receitas: "Atencao: suas despesas estao maiores que receitas." (amarelo)
  - [ ] Exibir diferenca: "Resultado: +R$ Z" ou "Resultado: -R$ Z"
- [ ] Integrar alertas no dashboard (AC: 2, 4, 5, 6)
  - [ ] Modificar `src/app/(dashboard)/page.tsx`
  - [ ] Adicionar chamada ao endpoint /api/v1/alertas
  - [ ] Renderizar AlertCards no topo do dashboard (antes do semaforo)
  - [ ] Renderizar WithdrawalCard e MonthlySummary abaixo do semaforo
  - [ ] Loading states para cada secao

## Dev Notes

**Source Tree relevante:**
```
src/
├── app/(dashboard)/page.tsx                     # Dashboard (modificar - integrar alertas)
├── app/api/v1/alertas/route.ts                  # GET alertas + retirada + resumo
├── modules/financeiro/
│   └── alerta.service.ts                        # Alert logic + withdrawal calc
└── components/dashboard/
    ├── alert-cards.tsx                           # Cards de alerta coloridos
    ├── withdrawal-card.tsx                       # "Quanto posso retirar?"
    └── monthly-summary.tsx                       # Resumo mensal humanizado
```

**Depende de:** Story 3.1 (ContaPagar), Story 3.2 (ContaReceber), Story 3.3 (Dashboard + saldo + semaforo)

**Formula "Quanto posso retirar?":**
```
retiravel = saldoAtual - contasPagar30dias - (receitaMediaMensal * 0.10)
Se retiravel < 0, retornar 0
```
- saldoAtual: reutilizar calculo do dashboard.service.ts
- contasPagar30dias: SUM(amount) de ContaPagar WHERE status=PENDENTE AND dueDate BETWEEN hoje AND hoje+30dias
- receitaMediaMensal: media dos SUM(amount) de ContaReceber WHERE status=RECEBIDO, agrupado por mes, ultimos 3 meses
- reservaSeguranca: 10% da receita media mensal

**Tipos de alerta:**
1. `contas_vencidas` (severity: critical): "Voce tem X contas vencidas totalizando R$ Y"
2. `contas_proximos_7_dias` (severity: warning): "R$ X em contas vencem nos proximos 7 dias" (so exibe se valor > 50% do saldo)
3. `caixa_apertado_30_dias` (severity: warning): "Suas despesas previstas superam suas receitas nos proximos 30 dias"

**Linguagem humana - requisito do PRD:**
- Usar frases simples, diretas
- Evitar jargao financeiro/contabil
- Foco em acao: o que o usuario deve fazer

**Componentes shadcn/ui:** Card, Badge (existentes). Lucide icons: AlertTriangle, AlertCircle, Info, Wallet, TrendingUp, TrendingDown.

### Testing

- **Localizacao:** `tests/unit/modules/financeiro/`
- **Framework:** Vitest
- **Testes necessarios:**
  - `calcularQuantoPossoRetirar` retorna valor correto
  - `calcularQuantoPossoRetirar` retorna 0 quando saldo insuficiente
  - `calcularQuantoPossoRetirar` considera reserva de 10%
  - `getAlertas` retorna alerta de contas vencidas quando existem
  - `getAlertas` retorna alerta de 7 dias quando contas > 50% do saldo
  - `getAlertas` nao retorna alerta se nao houver situacao de risco
  - `getResumoMensal` retorna receitas e despesas do mes corrente
- **Mocks:** Mock do `prisma` para testes de service

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-07 | 1.0 | Criacao inicial da story | Sarah (PO) |

## Dev Agent Record

### Agent Model Used
*A ser preenchido pelo dev agent*

### Debug Log References
*A ser preenchido pelo dev agent*

### Completion Notes List
*A ser preenchido pelo dev agent*

### File List
*A ser preenchido pelo dev agent*

## QA Results
*A ser preenchido pelo QA agent*
