# Story 10.4: Integracao Mercado Livre

## Status: Draft

## Story

**As a** usuario que vende no Mercado Livre,
**I want** sincronizar meus produtos e receber pedidos automaticamente no ERPsb,
**so that** eu nao precise registrar tudo duas vezes e meu estoque fique sempre correto.

## Acceptance Criteria

1. Autenticacao OAuth 2.0 com Mercado Livre (conectar conta)
2. Importar produtos existentes do ML para o ERPsb (match por SKU ou nome)
3. Publicar produtos do ERPsb no ML (criar anuncio com fotos, titulo, preco, estoque)
4. Sync bidirecional de estoque: venda no ML → baixa no ERPsb, venda no ERPsb → baixa no ML
5. Sync de precos: alterar preco no ERPsb atualiza no ML (opcao por produto)
6. Pedidos do ML recebidos automaticamente por webhook:
   - Cria Venda no ERPsb
   - Baixa estoque
   - Registra taxa/comissao ML como ContaPagar automaticamente
   - Cria ContaReceber (ja pago pelo ML)
7. Dashboard unificado: vendas presenciais + ML no mesmo grafico
8. Tela de "Integracao ML" com status da conexao, produtos sincronizados, pedidos recentes
9. Logs de sincronizacao: historico de syncs com sucesso/erro

## Tasks / Subtasks

- [ ] Criar adapter Mercado Livre (AC: 1)
  - [ ] Criar `src/integrations/marketplaces/mercadolivre.client.ts`
  - [ ] OAuth 2.0: getAuthUrl(), exchangeCode(code), refreshToken()
  - [ ] Endpoints: getProducts(), createProduct(), updateProduct(), updateStock()
  - [ ] Endpoints: getOrders(), getOrder(id)
  - [ ] Endpoints: getCategories(), getShippingMethods()
  - [ ] Rate limiting: respeitar 10 req/s do ML
- [ ] Criar model de integracao (AC: 1, 9)
  - [ ] MarketplaceConnection: id, tenantId, platform (MERCADO_LIVRE), accessToken, refreshToken, userId (ML), connectedAt, status
  - [ ] MarketplaceSync: id, connectionId, type (PRODUCT/ORDER/STOCK), direction (IMPORT/EXPORT), status, details, createdAt
  - [ ] Adicionar campo mlListingId no Produto (para vincular)
- [ ] Fluxo de conexao OAuth (AC: 1)
  - [ ] `src/app/(dashboard)/configuracoes/integracoes/page.tsx` - lista de integracoes
  - [ ] Botao "Conectar Mercado Livre" → redirect para ML OAuth
  - [ ] Callback `src/app/api/v1/integracoes/mercadolivre/callback/route.ts`
  - [ ] Salvar tokens, testar conexao
- [ ] Importar produtos do ML (AC: 2)
  - [ ] `src/modules/marketplace/ml-sync.service.ts`
  - [ ] Funcao importProducts(connectionId): busca produtos do ML, cria no ERPsb
  - [ ] Match por SKU: se produto ja existe, vincula (nao duplica)
  - [ ] Tela: lista de produtos do ML com checkbox para importar
- [ ] Publicar produtos no ML (AC: 3, 5)
  - [ ] Funcao publishProduct(productId): cria anuncio no ML
  - [ ] Enviar: titulo, descricao, preco, fotos, estoque, categoria
  - [ ] Funcao updateMLPrice(productId): atualiza preco no ML
  - [ ] Toggle por produto: "Sincronizar preco automaticamente"
- [ ] Sync de estoque (AC: 4)
  - [ ] Ao confirmar venda no ERPsb → atualizar estoque no ML (PUT /items/{id}/stock)
  - [ ] Ao receber pedido do ML → baixar estoque no ERPsb
  - [ ] Sync periodico: cron a cada 30 min compara saldos
- [ ] Webhook de pedidos ML (AC: 6)
  - [ ] `src/app/api/webhooks/mercadolivre/route.ts`
  - [ ] ML envia notificacao de novo pedido
  - [ ] Buscar detalhes do pedido via API
  - [ ] Criar Venda com items, cliente (se identificavel)
  - [ ] Calcular taxa ML (11-16% dependendo da categoria) → criar ContaPagar
  - [ ] Criar ContaReceber RECEBIDO (ML ja garantiu o pagamento)
  - [ ] Baixar estoque
- [ ] Dashboard unificado (AC: 7)
  - [ ] Adicionar campo `source` no model Venda (PRESENCIAL/MERCADO_LIVRE/CATALOGO_ONLINE)
  - [ ] Dashboard: filtro por canal de venda
  - [ ] Grafico empilhado: presencial vs online vs ML
- [ ] Tela de integracao (AC: 8, 9)
  - [ ] `src/app/(dashboard)/configuracoes/integracoes/mercadolivre/page.tsx`
  - [ ] Status da conexao (conectado/desconectado)
  - [ ] Produtos sincronizados (X de Y)
  - [ ] Ultimos pedidos recebidos
  - [ ] Logs de sync (sucesso/erro)
  - [ ] Botao "Reconectar" / "Desconectar"
  - [ ] Botao "Sincronizar agora"

## Dev Notes

**Source Tree relevante:**
```
src/
├── integrations/marketplaces/
│   └── mercadolivre.client.ts         # Adapter ML API
├── modules/marketplace/
│   ├── ml-sync.service.ts             # Sync logic
│   └── marketplace.schema.ts          # Zod schemas
├── app/(dashboard)/configuracoes/integracoes/
│   ├── page.tsx                       # Hub de integracoes
│   └── mercadolivre/page.tsx          # Config ML
├── app/api/v1/integracoes/mercadolivre/
│   ├── callback/route.ts             # OAuth callback
│   ├── products/route.ts             # Sync produtos
│   └── sync/route.ts                 # Sync manual
├── app/api/webhooks/mercadolivre/
│   └── route.ts                       # Webhook pedidos
```

**CRITICO - Mercado Livre API:**
- Documentacao: https://developers.mercadolivre.com.br
- OAuth 2.0 com refresh token (expira em 6h, refresh em 6 meses)
- Rate limit: 10 requests/segundo por app
- Sandbox disponivel para testes
- Webhook: POST com notificacao, buscar detalhes com GET separado
- Categorias: arvore hierarquica, obrigatoria para publicar

**CRITICO - Taxa do ML:**
- Varia por categoria (11% a 16%)
- Inclui: comissao + custo do Mercado Pago
- Frete pode ser por conta do vendedor ou comprador
- Para MVP: input manual da taxa (percentual) ou buscar via API

**CRITICO - Conflitos de estoque:**
- Venda simultanea no ML e presencial pode causar estoque negativo
- Solucao: sync em tempo real (webhook) + validacao antes de confirmar
- Se conflito: priorizar ML (ja vendeu) e alertar dono

**Evolucao para 10.5 (Shopee/iFood):**
- Abstrair interface: `MarketplaceAdapter` com metodos padrao
- Cada marketplace implementa o adapter
- Service de sync e generico, adapter e especifico

### Testing

- **Testes necessarios:**
  - OAuth: exchangeCode salva tokens
  - importProducts: cria produtos no ERPsb, match por SKU
  - publishProduct: chama API ML com dados corretos
  - Webhook: cria Venda + ContaPagar (taxa) + ContaReceber
  - Sync estoque: atualiza ML ao confirmar venda local
  - Sync estoque: atualiza local ao receber pedido ML

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-09 | 1.0 | Criacao inicial da story | Sarah (PO) |

## Dev Agent Record
*A ser preenchido durante implementacao*

## QA Results
*A ser preenchido pelo QA agent*
