# Story 4.1: Venda Rapida (1 Toque)

## Status: Ready for Review

## Story

**As a** usuario,
**I want** registrar uma venda em menos de 30 segundos,
**so that** eu nao perca tempo entre atender clientes.

## Acceptance Criteria

1. Model Venda no Prisma: id, tenantId, clientId (opcional), items (Json array), subtotal (centavos), discount (centavos), total (centavos), paymentMethodId (FK), status (RASCUNHO/CONFIRMADA/CANCELADA), notes, createdAt, updatedAt
2. Tela de nova venda otimizada: busca rapida de produto, adicionar quantidade, cliente opcional, forma de pagamento, botao "Confirmar Venda"
3. Ao confirmar venda: cria automaticamente conta a receber no financeiro
4. Se produto tem estoque controlado: baixa automatica (placeholder - estoque sera Epic 6)
5. Tela de confirmacao com resumo e opcoes: "Nova Venda"
6. Historico de vendas com filtros (periodo, cliente, status)
7. Meta de UX: venda completa em 30 segundos ou menos (3-4 toques)

## Tasks / Subtasks

- [x] Adicionar model Venda ao Prisma schema (AC: 1)
  - [x] Adicionar model `Venda` em `prisma/schema.prisma` com campos: id (cuid), tenantId (String, FK Tenant), clientId (String?, FK Cliente), items (Json), subtotal (Int), discount (Int, default 0), total (Int), paymentMethodId (String, FK FormaPagamento), status (String, default "RASCUNHO"), notes (String?), createdAt, updatedAt
  - [x] Adicionar relation para Cliente, Tenant, FormaPagamento
  - [x] Adicionar `vendas Venda[]` no model Tenant, Cliente, FormaPagamento
  - [x] Adicionar `saleId String?` e relation na ContaReceber
  - [x] Criar indices: `@@index([tenantId, status])`, `@@index([tenantId, createdAt])`
  - [x] `@@map("vendas")`
  - [x] Executar `npx prisma generate`
- [x] Criar Zod schemas de validacao (AC: 1, 2)
  - [x] Criar `src/modules/vendas/venda.schema.ts`
  - [x] `vendaItemSchema`: productId (string), name (string), quantity (int positivo), unitPrice (int, centavos), total (int, centavos)
  - [x] `createVendaSchema`: clientId (opcional), items (array min 1 de vendaItemSchema), discount (int >= 0, default 0), paymentMethodId (string), notes (opcional)
  - [x] `listVendasQuerySchema`: search, page, pageSize, status, clientId, startDate, endDate
- [x] Criar service de vendas (AC: 1, 3, 5, 6)
  - [x] Criar `src/modules/vendas/venda.service.ts`
  - [x] Funcao `createVenda(data)`: calcula subtotal/total a partir de items, cria com status RASCUNHO
  - [x] Funcao `confirmVenda(id)`: seta status=CONFIRMADA, cria ContaReceber vinculada (description="Venda #N", amount=total, dueDate=hoje, status=RECEBIDO se pagamento a vista, PENDENTE se a prazo)
  - [x] Funcao `listVendas(query)`: lista com filtros por status, cliente, periodo, busca, paginacao
  - [x] Funcao `getVenda(id)`: busca por id com include client, paymentMethod
  - [x] Funcao `cancelVenda(id)`: seta status=CANCELADA, se tinha ContaReceber vinculada cancela tambem
- [x] Criar API routes REST (AC: 1, 6)
  - [x] Criar `src/app/api/v1/vendas/route.ts` com GET (listar) e POST (criar)
  - [x] Criar `src/app/api/v1/vendas/[id]/route.ts` com GET
  - [x] Criar `src/app/api/v1/vendas/[id]/confirmar/route.ts` com POST (confirmar venda)
  - [x] Criar `src/app/api/v1/vendas/[id]/cancelar/route.ts` com POST (cancelar venda)
  - [x] Todos endpoints usam `withTenantApi`
- [x] Criar pagina de nova venda (AC: 2, 7)
  - [x] Criar `src/app/(dashboard)/vendas/nova/page.tsx` como Client Component
  - [x] Busca rapida de produto por nome/barcode com autocomplete
  - [x] Lista de itens adicionados com quantidade editavel (+/-)
  - [x] Subtotal e total calculados automaticamente
  - [x] Campo de desconto (opcional, input monetario R$)
  - [x] Cliente opcional (busca por nome/telefone)
  - [x] Forma de pagamento (selecao rapida com icones)
  - [x] Botao "Confirmar Venda" grande e visivel
  - [x] Ao confirmar, redireciona para tela de confirmacao
- [x] Criar pagina de confirmacao de venda (AC: 5)
  - [x] Criar `src/app/(dashboard)/vendas/[id]/page.tsx` como Client Component
  - [x] Exibir resumo: itens, valores, cliente, forma pagamento
  - [x] Botao "Nova Venda" para iniciar outra
  - [x] Botao "Cancelar Venda" com confirmacao (apenas se CONFIRMADA)
- [x] Criar pagina de historico de vendas (AC: 6)
  - [x] Criar `src/app/(dashboard)/vendas/page.tsx` como Client Component
  - [x] Filtros: status (Todas/Confirmadas/Canceladas), periodo, busca por cliente
  - [x] Lista em cards com: #numero, data, cliente, total, status badge
  - [x] Paginacao
  - [x] Link para detalhe de cada venda
  - [x] Empty state e loading skeleton

## Dev Notes

**Source Tree relevante:**
```
src/
├── app/(dashboard)/vendas/
│   ├── page.tsx                # Historico de vendas
│   ├── nova/page.tsx           # Nova venda (quick sale)
│   └── [id]/page.tsx           # Detalhe/confirmacao da venda
├── app/api/v1/vendas/
│   ├── route.ts                # GET + POST
│   ├── [id]/route.ts           # GET
│   ├── [id]/confirmar/route.ts # POST confirm
│   └── [id]/cancelar/route.ts  # POST cancel
└── modules/vendas/
    ├── venda.service.ts        # Business logic
    └── venda.schema.ts         # Zod schemas
```

**Depende de:** Story 2.3 (Produtos - busca no form), Story 2.4 (FormasPagamento - selecao), Story 3.2 (ContaReceber - geracao automatica)

**CRITICO - Items como JSON:**
- items armazenado como Json no Prisma (desnormalizado para performance e simplicidade MVP)
- Cada item: { productId, name, quantity, unitPrice, total } com valores em centavos
- O name e unitPrice sao "fotografados" no momento da venda (snapshot)

**Logica de confirmar venda:**
1. Atualiza status para CONFIRMADA
2. Cria ContaReceber com:
   - description: "Venda #{sequencial}"
   - amount: total da venda
   - dueDate: hoje
   - status: RECEBIDO (pagamento a vista) ou PENDENTE (a prazo)
   - clientId: da venda
   - saleId: id da venda
3. Para MVP, todas as vendas sao consideradas "a vista" (status RECEBIDO)

**Numeracao de vendas:**
- Usar contagem sequencial por tenant (count + 1) no momento da confirmacao
- Armazenar no campo `number` do model

**Forma de pagamento - selecao rapida:**
- Buscar formas ativas do tenant
- Exibir como botoes/chips com icones
- Pre-selecionar a forma com isDefault=true

### Testing

- **Localizacao:** `tests/unit/modules/vendas/`
- **Framework:** Vitest
- **Testes necessarios:**
  - `createVendaSchema` valida items obrigatorio (min 1)
  - `createVendaSchema` rejeita item com quantity <= 0
  - `createVendaSchema` rejeita discount negativo
  - Service `createVenda` calcula subtotal e total corretamente
  - Service `createVenda` aplica desconto
  - Service `confirmVenda` cria ContaReceber vinculada
  - Service `confirmVenda` seta status CONFIRMADA
  - Service `cancelVenda` cancela ContaReceber vinculada
  - Service `listVendas` filtra por status e periodo
- **Mocks:** Mock do `prisma` para testes de service

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-07 | 1.0 | Criacao inicial da story | Sarah (PO) |
| 2026-02-07 | 1.1 | Implementacao completa - todas tasks concluidas | James (Dev) |

## Dev Agent Record

### Agent Model Used
Claude Opus 4.6 (claude-opus-4-6)

### Debug Log References
- EmptyState icon prop: expects LucideIcon component, not JSX element. Fixed by passing `ShoppingCart` instead of `<ShoppingCart />`.

### Completion Notes List
- Venda Prisma model with Json items (desnormalized snapshot), status RASCUNHO/CONFIRMADA/CANCELADA, number sequential per tenant
- ContaReceber extended with optional saleId FK to link sales to receivables
- Relations added to Tenant, Cliente, FormaPagamento for vendas
- Zod schemas: vendaItemSchema (product snapshot), createVendaSchema (min 1 item, discount >= 0), listVendasQuerySchema
- Service: createVenda (auto-calculates subtotal/total), confirmVenda (assigns number, creates ContaReceber RECEBIDO), cancelVenda (cascades to ContaReceber), listVendas, getVenda
- Nova venda page: product autocomplete, quantity +/-, client optional, payment method chips (pre-selects default), discount, total summary, one-tap confirm
- Sale detail page: confirmation/cancellation banners, items list, totals, cancel action
- Sales history: status tabs, client search, pagination, empty state
- API routes: GET/POST /vendas, GET /vendas/[id], POST /vendas/[id]/confirmar, POST /vendas/[id]/cancelar
- 16 new tests (8 schema + 8 service), 201 total passing
- TypeScript clean

### File List
- `prisma/schema.prisma` (modified - added Venda model, saleId on ContaReceber, vendas[] on Tenant/Cliente/FormaPagamento)
- `src/modules/vendas/venda.schema.ts` (new - Zod schemas for venda items, create, list)
- `src/modules/vendas/venda.service.ts` (new - CRUD + confirm with ContaReceber + cancel cascade)
- `src/app/api/v1/vendas/route.ts` (new - GET list + POST create)
- `src/app/api/v1/vendas/[id]/route.ts` (new - GET detail)
- `src/app/api/v1/vendas/[id]/confirmar/route.ts` (new - POST confirm)
- `src/app/api/v1/vendas/[id]/cancelar/route.ts` (new - POST cancel)
- `src/app/(dashboard)/vendas/page.tsx` (new - sales history with filters)
- `src/app/(dashboard)/vendas/nova/page.tsx` (new - quick sale form)
- `src/app/(dashboard)/vendas/[id]/page.tsx` (new - sale detail/confirmation)
- `tests/unit/modules/vendas/venda-schema.test.ts` (new - 8 tests)
- `tests/unit/modules/vendas/venda-service.test.ts` (new - 8 tests)

## QA Results
*A ser preenchido pelo QA agent*
