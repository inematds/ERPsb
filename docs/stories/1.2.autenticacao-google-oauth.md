# Story 1.2: Autenticacao Google OAuth e Sessao

## Status: Draft

## Story

**As a** usuario,
**I want** fazer login com minha conta Google,
**so that** eu possa acessar o sistema sem precisar criar uma senha nova.

## Acceptance Criteria

1. NextAuth.js v5 configurado com Google OAuth provider
2. Tela de login responsiva (mobile-first) com botao "Entrar com Google" como CTA principal
3. Opcao secundaria de cadastro/login via email + senha
4. Sessao JWT com expiracao de 24h e refresh token de 30 dias
5. Middleware de autenticacao protegendo todas as rotas exceto login e landing
6. Model User no Prisma com campos: id, email, name, image, provider, createdAt, updatedAt
7. Redirect apos login para onboarding (se primeiro acesso) ou dashboard (se ja tem empresa)
8. Logout funcional com limpeza de sessao

## Tasks / Subtasks

- [ ] Instalar e configurar NextAuth.js v5 (AC: 1)
  - [ ] `pnpm add next-auth@beta @auth/prisma-adapter`
  - [ ] Criar `src/core/auth/auth.config.ts` com Google provider
  - [ ] Criar `src/app/api/auth/[...nextauth]/route.ts`
  - [ ] Configurar Prisma adapter para persistir sessoes
  - [ ] Configurar JWT strategy com expiracao 24h
- [ ] Criar tela de login (AC: 2, 3)
  - [ ] `src/app/(auth)/login/page.tsx`
  - [ ] Botao "Entrar com Google" grande e centralizado (CTA principal)
  - [ ] Formulario email/senha como opcao secundaria (collapsivel)
  - [ ] Layout mobile-first: centrado verticalmente, max-width 400px
  - [ ] Logo ERPsb + tagline no topo
- [ ] Implementar middleware de autenticacao (AC: 5)
  - [ ] `src/middleware.ts` - proteger rotas `/(dashboard)/*`
  - [ ] Permitir acesso sem auth: `/login`, `/api/auth/*`, `/api/health`, `/api/webhooks/*`
  - [ ] Redirect para /login se nao autenticado
- [ ] Implementar logica de redirect pos-login (AC: 7)
  - [ ] Verificar se user tem UserTenant (empresa)
  - [ ] Se nao tem: redirect para `/onboarding`
  - [ ] Se tem: redirect para `/` (dashboard)
- [ ] Implementar logout (AC: 8)
  - [ ] Botao de logout no menu de configuracoes
  - [ ] Chamar `signOut()` do NextAuth
  - [ ] Redirect para `/login`
- [ ] Criar helper `getCurrentUser()` (AC: 6)
  - [ ] `src/core/auth/auth.ts` - funcao server-side
  - [ ] Retorna user da sessao ou null
  - [ ] Inclui userId e tenantId ativo

## Dev Notes

**Source Tree relevante:**
```
src/
├── app/
│   ├── (auth)/login/page.tsx       # Tela de login
│   ├── api/auth/[...nextauth]/route.ts  # NextAuth handler
│   └── middleware.ts               # Edge middleware (raiz do src/app nao, raiz do projeto)
├── core/auth/
│   ├── auth.config.ts              # NextAuth config + providers
│   └── auth.ts                     # getCurrentUser() helper
```

**Depende de:** Story 1.1 (projeto base + Prisma User/Tenant models)

**NextAuth.js v5 config essencial:**
- Provider: Google OAuth (GOOGLE_CLIENT_ID, GOOGLE_CLIENT_SECRET)
- Adapter: Prisma Adapter (persiste Account, Session, etc)
- Strategy: JWT (nao database sessions - melhor para serverless)
- Callbacks: `jwt` (adicionar userId), `session` (expor userId e tenantId ativo)

**Env vars necessarias:**
- `NEXTAUTH_URL` = http://localhost:3000
- `NEXTAUTH_SECRET` = (gerar com openssl rand -base64 32)
- `GOOGLE_CLIENT_ID` = (Google Cloud Console)
- `GOOGLE_CLIENT_SECRET` = (Google Cloud Console)

**Coding Standards:**
- Tela de login como Server Component com formularios client-only
- `'use client'` apenas nos botoes de login (onClick handlers)
- Middleware roda no Edge Runtime - nao usar Node.js APIs
- Validar email com Zod no formulario de email/senha

### Testing

- **Localizacao:** `tests/unit/core/auth/` e `tests/integration/api/auth/`
- **Framework:** Vitest
- **Testes necessarios:**
  - `getCurrentUser()` retorna null sem sessao
  - `getCurrentUser()` retorna user com sessao valida
  - Middleware redireciona para /login sem auth
  - Middleware permite acesso a /api/health sem auth
- **E2E (futuro):** Login completo via Playwright

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-07 | 1.0 | Criacao inicial da story | Sarah (PO) |

## Dev Agent Record

### Agent Model Used
*A ser preenchido pelo dev agent*

### Debug Log References
*A ser preenchido pelo dev agent*

### Completion Notes List
*A ser preenchido pelo dev agent*

### File List
*A ser preenchido pelo dev agent*

## QA Results
*A ser preenchido pelo QA agent*
