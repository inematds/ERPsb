# Story 2.3: Cadastro de Produtos e Servicos Progressivo

## Status: Ready for Review

## Story

**As a** usuario,
**I want** cadastrar meus produtos e servicos com apenas nome e preco,
**so that** eu possa comecar a vender imediatamente.

## Acceptance Criteria

1. Model Produto no Prisma: id, tenantId, type (produto/servico), name (obrigatorio), sellPrice (obrigatorio, em centavos), costPrice (centavos, opcional), unit (un/kg/hr/srv), barcode, ncm, description, stockMin, trackStock (boolean), active (boolean), createdAt, updatedAt
2. Formulario com campos minimos: nome, tipo (produto/servico), preco de venda
3. Expansao progressiva: preco de custo, unidade de medida, codigo de barras, NCM, descricao, estoque minimo
4. Toggle "Controlar estoque" (default: true para produtos, false para servicos)
5. Lista com busca por nome/codigo de barras
6. Tela de detalhe com informacoes e futuro historico de vendas (placeholder)
7. Validacao: preco deve ser positivo, NCM formato valido quando preenchido
8. RLS aplicado

## Tasks / Subtasks

- [x]Adicionar model Produto ao Prisma schema (AC: 1, 8)
  - [x]Adicionar model `Produto` em `prisma/schema.prisma` com campos: id (cuid), tenantId (String, FK para Tenant), type (String, default "PRODUTO"), name (String), sellPrice (Int, em centavos), costPrice (Int?, em centavos), unit (String, default "un"), barcode (String?), ncm (String?), description (String?), stockMin (Int?, default 0), trackStock (Boolean, default true), active (Boolean, default true), createdAt, updatedAt
  - [x]Adicionar relation `produtos Produto[]` no model Tenant
  - [x]Criar indices: `@@index([tenantId, name])`, `@@index([tenantId, barcode])`
  - [x]`@@map("produtos")`
  - [x]Executar `npx prisma generate`
- [x]Criar service de produtos (AC: 1, 5, 8)
  - [x]Criar `src/modules/cadastros/produto.service.ts`
  - [x]Funcao `createProduto(data)`: cria produto usando `prisma`, define trackStock com base no type (PRODUTO=true, SERVICO=false) se nao especificado
  - [x]Funcao `listProdutos({ search?, page?, pageSize?, type?, active? })`: lista com busca por name/barcode, filtro por type (PRODUTO/SERVICO) e active, paginacao
  - [x]Funcao `getProduto(id)`: busca por id
  - [x]Funcao `updateProduto(id, data)`: atualiza campos
  - [x]Funcao `deleteProduto(id)`: deleta ou desativa produto (set active=false)
- [x]Criar Zod schemas de validacao (AC: 7)
  - [x]Criar `src/modules/cadastros/produto.schema.ts`
  - [x]`createProdutoSchema`: name (min 2), type (enum: PRODUTO, SERVICO), sellPrice (int positivo, obrigatorio), costPrice (int positivo, opcional), unit (enum: un/kg/hr/srv, default "un"), barcode (string opcional), ncm (regex /^\d{8}$/ opcional), description (opcional), stockMin (int >= 0, opcional), trackStock (boolean, opcional)
  - [x]`updateProdutoSchema`: todos campos optional
  - [x]`listProdutoQuerySchema`: search, page, pageSize, type (PRODUTO/SERVICO, opcional), active (boolean, opcional)
- [x]Criar helpers de formatacao monetaria (AC: 1, 7)
  - [x]Adicionar em `src/lib/formatters.ts`:
    - `formatCurrency(centavos: number): string` -> `Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' })`
    - `parseCurrency(display: string): number` -> converte "R$ 10,50" para 1050 centavos
  - [x]Usar em todos os campos de preco
- [x]Criar API routes REST (AC: 1, 5, 8)
  - [x]Criar `src/app/api/v1/produtos/route.ts` com GET (listar) e POST (criar)
  - [x]Criar `src/app/api/v1/produtos/[id]/route.ts` com GET, PATCH, DELETE
  - [x]Todos endpoints usam `withTenantApi`
  - [x]Precos recebidos/retornados em centavos (int)
- [x]Criar pagina de lista de produtos/servicos (AC: 2, 5)
  - [x]Criar `src/app/(dashboard)/cadastros/produtos/page.tsx` como Client Component
  - [x]Header com titulo "Produtos e Servicos" e botao "+ Novo"
  - [x]Tabs/Filtro: "Todos", "Produtos", "Servicos"
  - [x]Campo de busca com debounce para nome/codigo de barras
  - [x]Lista em cards com nome, preco formatado (R$), tipo badge, status ativo/inativo
  - [x]Paginacao com contagem total
  - [x]Empty state com CTA "Cadastre seu primeiro produto"
  - [x]Loading skeleton
- [x]Criar formulario progressivo de novo produto (AC: 2, 3, 4, 7)
  - [x]Criar `src/app/(dashboard)/cadastros/produtos/novo/page.tsx` como Client Component
  - [x]Campos iniciais: nome, tipo (radio: Produto/Servico), preco de venda (input monetario em R$)
  - [x]Input de preco: mascara monetaria (R$ X,XX), converte para centavos ao salvar
  - [x]Botao "Mais detalhes" expande: preco de custo, unidade de medida (select), codigo de barras, NCM, descricao (textarea), estoque minimo
  - [x]Toggle "Controlar estoque" com default baseado no tipo
  - [x]Ao trocar tipo para SERVICO: unit="srv", trackStock=false
  - [x]Botoes "Salvar" e "Cancelar"
  - [x]Redirect para lista apos salvar com toast
- [x]Criar tela de detalhe do produto (AC: 6)
  - [x]Criar `src/app/(dashboard)/cadastros/produtos/[id]/page.tsx` como Client Component
  - [x]Exibir todos os campos com precos formatados
  - [x]Edicao inline dos campos
  - [x]Toggle ativo/inativo
  - [x]Secao placeholder "Historico de Vendas"
  - [x]Botao "Excluir produto" com dialog de confirmacao

## Dev Notes

**Source Tree relevante:**
```
src/
├── app/(dashboard)/cadastros/produtos/
│   ├── page.tsx                # Lista de produtos/servicos
│   ├── novo/page.tsx           # Formulario novo produto
│   └── [id]/page.tsx           # Detalhe do produto
├── app/api/v1/produtos/
│   ├── route.ts                # GET + POST
│   └── [id]/route.ts           # GET + PATCH + DELETE
├── modules/cadastros/
│   ├── produto.service.ts      # Business logic
│   └── produto.schema.ts       # Zod schemas
└── lib/
    └── formatters.ts           # formatCurrency, parseCurrency (novo)
```

**Depende de:** Story 2.1 (padrao de CRUD, validators), Story 1.5 (layout, EmptyState)

**CRITICO - Valores monetarios em centavos:**
- `sellPrice` e `costPrice` sao armazenados como `Int` (centavos)
- R$ 10,50 = 1050 centavos no banco
- Formatacao para exibicao: `Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(centavos / 100)`
- Input do usuario: mascara R$ X,XX, conversao para centavos antes de salvar
- NUNCA usar float/decimal para dinheiro

**Logica de tipo:**
- PRODUTO: unit default "un", trackStock default true
- SERVICO: unit default "srv", trackStock default false

**NCM (Nomenclatura Comum do Mercosul):** Codigo de 8 digitos para classificacao fiscal. Validar formato `/^\d{8}$/` quando preenchido.

**Componentes shadcn/ui:** Button, Input, Card, Dialog, Skeleton, Sonner (existentes). Pode precisar de Switch (toggle trackStock) e Textarea.

**Coding Standards:**
- Services: `produto.service.ts`
- API routes: `/api/v1/produtos`
- Schemas: `createProdutoSchema`
- Precos sempre em centavos no service/API, formatados apenas na UI

### Testing

- **Localizacao:** `tests/unit/modules/cadastros/` e `tests/unit/lib/`
- **Framework:** Vitest
- **Testes necessarios:**
  - `formatCurrency(1050)` retorna "R$ 10,50"
  - `parseCurrency("R$ 10,50")` retorna 1050
  - `createProdutoSchema` valida precos positivos, rejeita negativos
  - `createProdutoSchema` valida NCM formato 8 digitos
  - Service `createProduto` define trackStock correto por tipo
  - Service `listProdutos` filtra por type e active
  - Service `updateProduto` atualiza campos
- **Mocks:** Mock do `prisma` para testes de service

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-07 | 1.0 | Criacao inicial da story | Sarah (PO) |
| 2026-02-07 | 1.1 | Implementacao completa | James (Dev) |

## Dev Agent Record

### Agent Model Used
Claude Opus 4.6 (via Claude Code)

### Debug Log References
- Type error: Zod `.default('un')` on unit creates required field in TypeScript output type. Tests needed to pass unit explicitly.

### Completion Notes List
- Prisma model Produto with type (PRODUTO/SERVICO), sellPrice/costPrice in centavos (Int), unit, barcode, ncm, trackStock, active
- Currency formatters: formatCurrency(centavos) and parseCurrency(display) in src/lib/formatters.ts
- Service with type-aware defaults: PRODUTO -> trackStock=true, unit="un"; SERVICO -> trackStock=false, unit="srv"
- Soft delete: deleteProduto sets active=false instead of hard delete
- List with type filter (PRODUTO/SERVICO tabs), active filter, search by name/barcode
- Progressive form: name, type radio, sellPrice with R$ input; expands to costPrice, unit select, barcode, NCM (8-digit validation), description, stockMin, trackStock toggle
- Detail page with formatted prices, activate/deactivate toggle, inline editing
- 24 new tests (7 formatters + 10 schema + 7 service), 107 total passing
- No new dependencies

### File List
- `prisma/schema.prisma` (modified - added Produto model + Tenant relation)
- `src/lib/formatters.ts` (new - formatCurrency, parseCurrency)
- `src/modules/cadastros/produto.service.ts` (new - CRUD service with type defaults)
- `src/modules/cadastros/produto.schema.ts` (new - Zod schemas with NCM validation)
- `src/app/api/v1/produtos/route.ts` (new - GET + POST)
- `src/app/api/v1/produtos/[id]/route.ts` (new - GET + PATCH + DELETE)
- `src/app/(dashboard)/cadastros/produtos/page.tsx` (new - list with type filter)
- `src/app/(dashboard)/cadastros/produtos/novo/page.tsx` (new - progressive form with currency input)
- `src/app/(dashboard)/cadastros/produtos/[id]/page.tsx` (new - detail with price formatting)
- `tests/unit/lib/formatters.test.ts` (new - 7 tests)
- `tests/unit/modules/cadastros/produto-schema.test.ts` (new - 10 tests)
- `tests/unit/modules/cadastros/produto-service.test.ts` (new - 7 tests)

## QA Results
*A ser preenchido pelo QA agent*
