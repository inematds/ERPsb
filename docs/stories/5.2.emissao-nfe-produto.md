# Story 5.2: Emissao de NFe (Produto)

## Status: Draft

## Story

**As a** usuario,
**I want** emitir NFe de produto a partir de uma venda,
**so that** eu entregue o documento fiscal ao cliente sem precisar entender de tributacao.

## Acceptance Criteria

1. Integracao com Focus NFe API para emissao de NFe
2. Botao "Emitir NFe" disponivel na tela de detalhes da venda (pos-confirmacao)
3. Sistema preenche automaticamente: CFOP, CST, NCM (do cadastro do produto), aliquotas com base no regime tributario
4. Preview da nota antes de emitir com campos editaveis para correcoes
5. Emissao sync no MVP (BullMQ quando Redis disponivel)
6. Status atualizado: processando -> autorizada/rejeitada
7. XML armazenado no banco (String), link para download
8. Vinculacao automatica: ao autorizar NFe, atualiza venda com numero da nota
9. Campos CBS/IBS presentes no schema (preenchimento conforme regulamentacao vigente)

## Tasks / Subtasks

*A ser detalhado pelo Dev agent*

## Dev Notes

**Depende de:** Story 5.1 (ConfigFiscal + NotaFiscal models, fiscal helpers)

**Focus NFe API:**
- Base URL: `https://api.focusnfe.com.br/v2/` (producao) ou `https://homologacao.focusnfe.com.br/v2/` (homolog)
- Auth: Basic auth com token
- POST /nfe: cria NFe
- GET /nfe/{ref}: consulta status
- DELETE /nfe/{ref}: cancela

**MVP sem BullMQ:**
- Emissao sync na API route (como PIX)
- Retry manual pelo usuario
- Mock data quando FOCUS_NFE_TOKEN nao configurado

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-07 | 1.0 | Criacao inicial da story | Sarah (PO) |

## Dev Agent Record

### Agent Model Used
*To be filled*

### Debug Log References
*To be filled during development*

### Completion Notes List
*To be filled during development*

### File List
*To be filled during development*

## QA Results
*A ser preenchido pelo QA agent*
