# Story 9.2: Analise de Margem por Produto

## Status: Draft

## Story

**As a** usuario,
**I want** ver a margem real de todos os meus produtos em um dashboard,
**so that** eu identifique rapidamente quais produtos dao lucro e quais dao prejuizo.

## Acceptance Criteria

1. Dashboard de margens em `/precificacao/margens` com visao geral de todos os produtos
2. Indicadores no topo:
   - Margem media ponderada (por volume de vendas)
   - Quantidade de produtos com margem negativa
   - Quantidade de produtos com margem < 10% (alerta)
   - Produto mais rentavel e menos rentavel
3. Tabela/lista de produtos ordenavel por margem:
   - Nome, preco de venda, custo total, margem real, lucro por unidade
   - Semaforo: verde (>25%), amarelo (10-25%), vermelho (<10%), preto (negativa)
   - Quantidade vendida no mes (volume)
4. Filtro por categoria e por faixa de margem
5. Grafico de distribuicao de margens (histograma ou scatter plot)
6. Ao clicar no produto, abre a calculadora (Story 9.1) com dados pre-carregados
7. Alertas: card de destaque para produtos com margem negativa ("Voce esta perdendo R$ X/unidade neste produto")
8. Calcular margem apenas para produtos com costPrice preenchido; para os demais, mostrar "Custo nao informado" com link para preencher
9. Export: botao para exportar tabela como CSV

## Tasks / Subtasks

- [ ] Criar endpoint de analise de margens (AC: 1, 2, 3)
  - [ ] Criar `src/app/api/v1/precificacao/margens/route.ts` com GET
  - [ ] Para cada produto com costPrice:
    - Calcular margem real usando pricing.engine
    - Buscar quantidade vendida no periodo
    - Calcular lucro total = lucro/unidade * qtd vendida
  - [ ] Retornar: produtos com margens + indicadores agregados
  - [ ] Query params: periodo (default mes atual), categoria
- [ ] Criar dashboard de margens (AC: 1-8)
  - [ ] Criar `src/app/(dashboard)/precificacao/margens/page.tsx` como Client Component
  - [ ] Cards de indicadores no topo (AC: 2)
  - [ ] Tabela ordenavel com semaforo (AC: 3)
  - [ ] Filtros por categoria e faixa de margem (AC: 4)
  - [ ] Grafico de distribuicao (usar Recharts, ja existente no projeto) (AC: 5)
  - [ ] Link para calculadora por produto (AC: 6)
  - [ ] Card de alerta para margens negativas (AC: 7)
  - [ ] Indicador "Custo nao informado" com CTA (AC: 8)
- [ ] Export CSV (AC: 9)
  - [ ] Botao que gera CSV client-side com dados da tabela
  - [ ] Colunas: Produto, Preco Venda, Custo, Margem %, Lucro/Un, Qtd Vendida, Lucro Total
- [ ] Adicionar link na pagina de precificacao (AC: 1)
  - [ ] Card "Analise de margens" na pagina principal de precificacao

## Dev Notes

**Depende de:** Story 9.1 (pricing.engine, custos fixos, campos de custo no Produto)

**Margem media ponderada:**
```
margemMedia = Σ(margemProduto * qtdVendida) / Σ(qtdVendida)
```
Isso evita que um produto com 1 venda e 90% de margem distorca a media.

**Performance:**
- Calcular margens de 100+ produtos pode ser pesado
- Usar cache de 5 minutos (revalidate on demand ao alterar precos)
- Aggregate vendas por produto com GROUP BY, nao desserializar Json item a item

**Grafico sugerido:**
- Scatter plot: eixo X = volume vendido, eixo Y = margem %
- Cada ponto = produto, tamanho = lucro total
- Quadrantes: "Estrela" (alta margem + alto volume), "Oportunidade" (alta margem + baixo volume), "Volume" (baixa margem + alto volume), "Problema" (baixa margem + baixo volume)

### Testing

- **Testes necessarios:**
  - Endpoint margens: calcula margem real por produto
  - Endpoint margens: margem media ponderada
  - Endpoint margens: identifica margens negativas
  - Endpoint margens: exclui produtos sem costPrice
  - Export CSV: formato correto

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-09 | 1.0 | Criacao inicial da story | Sarah (PO) |

## Dev Agent Record
*A ser preenchido durante implementacao*

## QA Results
*A ser preenchido pelo QA agent*
