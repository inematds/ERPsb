# Epic 8: CFO Virtual - IA Conversacional (v2.0)

## Visao Geral

Um assistente de IA integrado ao ERPsb que responde perguntas sobre o negocio em linguagem natural. O dono pergunta "quanto vendi essa semana?" e recebe resposta instantanea baseada nos dados reais do sistema.

## Problema

O MEI tem dados no sistema mas **nao sabe interpretá-los**. Relatorios sao complexos, dashboards exigem navegacao. A pergunta mais frequente - "estou lucrando?" - nao tem resposta facil. O dono quer conversar com o sistema como conversa com o contador.

## Solucao

Chat integrado ao dashboard que traduz perguntas em consultas ao banco de dados e responde em linguagem simples:

```
Usuario: "Como estou esse mes?"
CFO:     "Ate agora voce vendeu R$ 12.400 (23 vendas).
          Suas despesas foram R$ 7.200.
          Lucro estimado: R$ 5.200 (margem de 42%).
          Comparando com janeiro: vendas subiram 18%, despesas subiram 5%.
          Voce esta no caminho certo!"
```

## Stories

| Story | Titulo | Descricao | Prioridade |
|-------|--------|-----------|------------|
| 8.1 | Infra de chat e consultas | Componente de chat, API de consultas, interpretacao de perguntas com IA | Must |
| 8.2 | Consultas financeiras | Vendas, saldo, despesas, lucro, comparativos de periodo | Must |
| 8.3 | Analise de clientes e produtos | Ranking clientes, produtos mais vendidos, inadimplentes, sazonalidade | Should |
| 8.4 | Insights e recomendacoes proativas | IA identifica padroes e sugere acoes (ex: "produto X caiu 30% esse mes") | Could |

## Arquitetura tecnica

```
Pergunta do usuario (texto livre)
    │
    ▼
Claude API (interpreta intencao + gera query)
    │
    ▼
Function calling → Consulta banco de dados (queries pre-definidas)
    │
    ▼
Claude API (formata resposta em linguagem natural)
    │
    ▼
Resposta ao usuario
```

### Abordagem: Function Calling (nao SQL direto)

A IA NAO gera SQL diretamente (risco de seguranca + complexidade). Em vez disso:

1. IA recebe a pergunta e seleciona entre funcoes pre-definidas
2. Funcoes executam queries seguras e retornam dados
3. IA formata a resposta em linguagem natural

### Funcoes disponiveis para a IA

```typescript
// Financeiro
getSaldoAtual()                         // Saldo atual
getResumoPerido(inicio, fim)            // Receitas, despesas, lucro
getContasPendentes(tipo)                // A pagar ou receber
getFluxoCaixa(dias)                     // Historico de entradas/saidas

// Vendas
getVendasPeriodo(inicio, fim)           // Total vendido, qtd vendas
getVendasPorProduto(inicio, fim, top)   // Ranking de produtos
getVendasPorCliente(inicio, fim, top)   // Ranking de clientes
getTicketMedio(inicio, fim)             // Valor medio por venda

// Comparativos
compararPeriodos(periodo1, periodo2)    // Mes a mes, semana a semana
getTendencia(metrica, meses)            // Tendencia de crescimento

// Estoque
getEstoqueBaixo()                       // Produtos abaixo do minimo
getEstoqueValor()                       // Valor total em estoque

// Clientes
getInadimplentes()                      // Clientes com contas vencidas
getClientesFrequentes(top)              // Mais compram
getClientesInativos(dias)               // Nao compram ha X dias
```

## Modelo de dados (novo)

```prisma
model ChatMessage {
  id         String   @id @default(cuid())
  tenantId   String
  tenant     Tenant   @relation(fields: [tenantId], references: [id])
  userId     String
  role       String   // USER, ASSISTANT
  content    String
  metadata   Json?    // Funcoes chamadas, tempo de resposta, tokens usados
  createdAt  DateTime @default(now())

  @@index([tenantId, createdAt])
  @@map("chat_messages")
}
```

## Exemplos de perguntas e respostas

| Pergunta | Funcoes chamadas | Resposta |
|----------|-----------------|----------|
| "Quanto vendi hoje?" | getVendasPeriodo(hoje, hoje) | "Hoje voce fez 5 vendas, total R$ 890,00" |
| "Quem me deve mais?" | getInadimplentes() | "Maria Silva: R$ 1.800 (3 contas, a mais antiga venceu ha 15 dias)" |
| "Meu melhor produto?" | getVendasPorProduto(mes, top=5) | "Camiseta P: 45 unidades (R$ 2.250). Seguido por..." |
| "Estou melhor que o mes passado?" | compararPeriodos(mesAtual, mesAnterior) | "Receita +18%, despesas +5%, lucro +31%. Parabens!" |
| "Posso retirar dinheiro?" | getSaldoAtual(), getContasPendentes("pagar") | "Saldo: R$ 8.500. Contas a pagar: R$ 3.200. Seguro retirar: R$ 5.300" |
| "Tem produto acabando?" | getEstoqueBaixo() | "3 produtos abaixo do minimo: Camiseta M (2 un), Bermuda G (1 un)..." |

## Limites por plano

| Plano | Perguntas/mes | Modelo |
|-------|--------------|--------|
| Gratis | 10 | Claude Haiku |
| Starter | 50 | Claude Haiku |
| Growth | 200 | Claude Sonnet |
| Pro | Ilimitado | Claude Sonnet |

## Estimativa de custo

| Componente | Custo/pergunta |
|-----------|---------------|
| Claude Haiku (interpretar + responder) | ~R$ 0,005 |
| Claude Sonnet (interpretar + responder) | ~R$ 0,03 |
| Query ao banco | desprezivel |

## Metricas de sucesso

- **Adocao:** 40%+ dos usuarios ativos fazem pelo menos 1 pergunta/semana
- **Precisao:** 90%+ das respostas corretas (dados precisos)
- **Satisfacao:** NPS do chat > 50
- **Retencao:** Usuarios que usam chat tem retencao 2x maior

## Riscos

| Risco | Mitigacao |
|-------|----------|
| IA responde com dados errados | Function calling com queries fixas (nao SQL livre) |
| Perguntas fora do escopo | IA responde "Nao sei responder isso, mas posso ajudar com..." |
| Custo escala | Limites por plano + cache de respostas similares |
| Latencia (2-5s) | Streaming da resposta (token a token) |
| Pergunta ambigua ("como estou?") | IA pede clarificacao ou assume "resumo geral" |
