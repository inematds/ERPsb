# Epic 7: Captura Inteligente (v2.0)

## Visao Geral

Permitir que o usuario registre despesas, notas de fornecedor e vendas **tirando uma foto ou enviando pelo WhatsApp**, com extracao automatica de dados por IA e aprovacao com 1 clique.

## Problema

O MEI nao registra despesas porque **da trabalho demais**: abrir o sistema, preencher formulario, digitar valores. Resultado: 70%+ das despesas nao sao registradas, o financeiro fica incompleto e o "quanto posso retirar" perde precisao.

## Solucao

Tres canais de entrada rapida, todos convergindo para uma **tela de aprovacao unificada**:

```
Canal 1: Camera do app  ──┐
Canal 2: WhatsApp         ├──> IA extrai dados ──> Tela de aprovacao ──> 1 clique ──> Registrado
Canal 3: Anotacao rapida ─┘
```

## Stories

| Story | Titulo | Descricao | Prioridade |
|-------|--------|-----------|------------|
| 7.1 | Infra de IA e Storage | Claude Vision API + Supabase Storage + modelo de DocumentCapture | Must |
| 7.2 | Captura de nota/despesa por foto | Camera no app, OCR por IA, extracao de dados, tela de aprovacao | Must |
| 7.3 | Captura de venda por foto/anotacao | Foto de itens ou texto livre, IA monta venda, aprovacao | Should |
| 7.4 | Entrada via WhatsApp | Receber foto/texto pelo WhatsApp, processar com IA, pedir confirmacao | Should |
| 7.5 | Historico e reprocessamento | Historico de capturas, status, reprocessar fotos com erro | Could |

## Dependencias

- **Claude API** (Vision) - para extracao de dados de imagens
- **Supabase Storage** - para armazenar fotos originais
- **WhatsApp Business API** - ja integrado (Epic 6), precisa suportar recebimento de midia

## Modelo de dados (novo)

```prisma
model DocumentCapture {
  id            String   @id @default(cuid())
  tenantId      String
  tenant        Tenant   @relation(fields: [tenantId], references: [id])

  // Origem
  source        String   // CAMERA, WHATSAPP, MANUAL
  imageUrl      String?  // URL no Supabase Storage
  rawText       String?  // Texto livre (anotacao manual)

  // Dados extraidos pela IA
  extractedData Json?    // Dados estruturados extraidos
  confidence    Float?   // Confianca da extracao (0-1)

  // Resultado
  type          String   // DESPESA, NOTA_FORNECEDOR, VENDA
  status        String   @default("PENDENTE") // PENDENTE, APROVADO, REJEITADO, ERRO

  // Vinculo com entidade criada apos aprovacao
  contaPagarId  String?
  vendaId       String?

  // Metadata
  processedAt   DateTime?
  approvedAt    DateTime?
  errorMessage  String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([tenantId, status])
  @@index([tenantId, createdAt])
  @@map("document_captures")
}
```

## Formato do extractedData (JSON)

### Para nota de fornecedor / despesa:
```json
{
  "supplierName": "Distribuidora ABC",
  "supplierCnpj": "12.345.678/0001-90",
  "items": [
    { "description": "Camiseta P branca", "quantity": 10, "unitPrice": 1500, "total": 15000 }
  ],
  "subtotal": 15000,
  "total": 15000,
  "date": "2026-02-09",
  "invoiceNumber": "12345",
  "category": "Fornecedores"
}
```

### Para venda:
```json
{
  "clientName": "Joao Silva",
  "clientPhone": "11999887766",
  "items": [
    { "productName": "Camiseta P", "quantity": 3, "unitPrice": 4990, "total": 14970 }
  ],
  "total": 14970,
  "paymentMethod": "PIX"
}
```

## Fluxo de aprovacao (unificado)

1. **Pendente** - IA processou, dados extraidos, aguardando revisao
2. Usuario visualiza dados extraidos em formulario pre-preenchido
3. Usuario pode **editar** qualquer campo antes de aprovar
4. **Aprovar** (1 clique) → cria ContaPagar / entrada de estoque / Venda
5. **Rejeitar** → marca como rejeitado, nao cria nada

## Limites por plano

| Plano | Capturas/mes | IA |
|-------|-------------|-----|
| Gratis | 5 | Claude Haiku |
| Starter | 50 | Claude Haiku |
| Growth | 200 | Claude Sonnet |
| Pro | Ilimitado | Claude Sonnet |

## Estimativa de custo por captura

| Componente | Custo |
|-----------|-------|
| Claude Vision (Haiku) | ~R$ 0,01/foto |
| Claude Vision (Sonnet) | ~R$ 0,05/foto |
| Supabase Storage | ~R$ 0,001/foto |
| **Total** | **R$ 0,01 - 0,05/foto** |

## Metricas de sucesso

- **Adocao:** 30%+ dos usuarios ativos usam captura por foto no primeiro mes
- **Precisao:** 85%+ dos campos extraidos corretos (sem edicao pelo usuario)
- **Conversao:** 90%+ das capturas pendentes sao aprovadas (baixa rejeicao)
- **Tempo:** Registro de despesa em < 10 segundos (foto + aprovar)

## Riscos

| Risco | Mitigacao |
|-------|----------|
| Foto ruim (desfocada, escura) | Feedback imediato + opcao de reenviar |
| IA extrai dados errados | Tela de aprovacao obrigatoria, nunca auto-criar |
| Custo de API escala | Limites por plano, cache de resultados |
| WhatsApp nao entrega midia | Fallback para camera no app |
| Latencia da IA (2-5s) | Processar async, notificar quando pronto |
