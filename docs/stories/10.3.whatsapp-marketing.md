# Story 10.3: WhatsApp Marketing

## Status: Draft

## Story

**As a** usuario,
**I want** enviar campanhas de promocao e reativacao de clientes pelo WhatsApp,
**so that** eu aumente minhas vendas usando o canal que meus clientes ja usam.

## Acceptance Criteria

1. Model Campanha no Prisma para gerenciar campanhas de marketing
2. Tela de campanhas em `/marketing` com lista de campanhas (rascunho, agendadas, concluidas)
3. Criar campanha com:
   - Nome e tipo (Promocao, Reativacao, Lancamento, Personalizada)
   - Mensagem com variaveis ({nome_cliente}, {link_catalogo}, {cupom}, {desconto})
   - Selecao de publico-alvo com filtros:
     - Todos os clientes
     - Compraram produto X
     - Nao compram ha X dias (inativos)
     - Gastaram mais de R$ X total
     - Aniversariantes do mes
   - Cupom de desconto opcional (codigo + percentual + validade)
   - Agendamento (enviar agora ou agendar data/hora)
4. Preview da mensagem antes de enviar com contagem de destinatarios
5. Envio em lote com rate limiting (respeitar limites WhatsApp Business: 80 msg/s)
6. Dashboard de metricas por campanha: enviadas, entregues, lidas, cliques, vendas atribuidas
7. Atribuicao de vendas: se cliente compra em ate 7 dias apos receber campanha, atribui venda a campanha
8. Templates de campanha prontos para usar (4-5 templates por tipo)
9. Opt-out: cliente pode responder "SAIR" para nao receber mais campanhas
10. Limite de campanhas por plano (0/2/10/ilimitado por mes)

## Tasks / Subtasks

- [ ] Adicionar model Campanha ao Prisma (AC: 1)
  - [ ] Model conforme definido no Epic 10.0
  - [ ] Campos: id, tenantId, name, type, message, discount, couponCode, targetFilter (Json), status, scheduledAt, sentCount, deliveredCount, readCount, clickCount, salesCount, salesTotal, createdAt, updatedAt
  - [ ] `@@map("campanhas")`
- [ ] Adicionar model CupomDesconto (AC: 3)
  - [ ] Model: id, tenantId, code (unique per tenant), type (PERCENTUAL/VALOR), value, maxUses, usedCount, validUntil, campanhaId, active, createdAt
  - [ ] `@@map("cupons_desconto")`
- [ ] Criar service de campanhas (AC: 3, 5, 6, 7)
  - [ ] `src/modules/marketing/campanha.service.ts`
  - [ ] createCampanha: salva rascunho
  - [ ] getTargetAudience(filter): aplica filtros e retorna lista de clientes
  - [ ] sendCampanha(id): envia para todos os destinatarios com rate limiting
  - [ ] trackDelivery(campanhaId, messageId, status): atualiza contadores
  - [ ] atribuirVenda(vendaId): verifica se cliente recebeu campanha nos ultimos 7 dias
- [ ] Criar service de cupons (AC: 3)
  - [ ] `src/modules/marketing/cupom.service.ts`
  - [ ] validateCupom(code, tenantId): verifica validade, limite de uso
  - [ ] applyCupom(code, vendaId): registra uso
- [ ] Criar tela de campanhas (AC: 2)
  - [ ] `src/app/(dashboard)/marketing/page.tsx`
  - [ ] Lista de campanhas com status badges
  - [ ] Metricas rapidas: enviadas esse mes, taxa de leitura, vendas atribuidas
  - [ ] Botao "Nova campanha"
- [ ] Criar tela de nova campanha (AC: 3, 4, 8)
  - [ ] `src/app/(dashboard)/marketing/nova/page.tsx`
  - [ ] Step 1: Tipo e mensagem (templates prontos ou personalizada)
  - [ ] Step 2: Publico-alvo (filtros com preview de qtd)
  - [ ] Step 3: Cupom opcional (codigo, desconto, validade)
  - [ ] Step 4: Agendar ou enviar agora
  - [ ] Preview final: mensagem renderizada + contagem destinatarios
  - [ ] Botao "Enviar" / "Agendar"
- [ ] Criar tela de metricas da campanha (AC: 6)
  - [ ] `src/app/(dashboard)/marketing/[id]/page.tsx`
  - [ ] Funil: Enviadas â†’ Entregues â†’ Lidas â†’ Clicaram â†’ Compraram
  - [ ] Grafico de barras com conversao em cada etapa
  - [ ] Lista de vendas atribuidas
  - [ ] ROI: (vendas atribuidas - custo WhatsApp) / custo
- [ ] Opt-out (AC: 9)
  - [ ] Campo `optOutMarketing` no model Cliente (Boolean, default false)
  - [ ] Webhook WhatsApp: detectar resposta "SAIR" e marcar opt-out
  - [ ] Filtrar clientes opt-out de todas as campanhas
  - [ ] Incluir "Responda SAIR para nao receber mais" no rodape
- [ ] Cron para campanhas agendadas (AC: 3)
  - [ ] Verificar campanhas AGENDADA com scheduledAt <= now()
  - [ ] Iniciar envio
  - [ ] Adicionar no vercel.json crons (a cada 15 min)
- [ ] Adicionar "Marketing" na sidebar (AC: 2)
  - [ ] Icone Megaphone, entre Estoque e Configuracoes

## Dev Notes

**Source Tree relevante:**
```
src/
â”œâ”€â”€ modules/marketing/
â”‚   â”œâ”€â”€ campanha.service.ts
â”‚   â”œâ”€â”€ cupom.service.ts
â”‚   â””â”€â”€ marketing.schema.ts
â”œâ”€â”€ app/(dashboard)/marketing/
â”‚   â”œâ”€â”€ page.tsx                       # Lista de campanhas
â”‚   â”œâ”€â”€ nova/page.tsx                  # Wizard nova campanha
â”‚   â””â”€â”€ [id]/page.tsx                 # Metricas da campanha
â”œâ”€â”€ app/api/v1/marketing/
â”‚   â”œâ”€â”€ campanhas/route.ts             # CRUD
â”‚   â”œâ”€â”€ campanhas/[id]/send/route.ts   # Enviar
â”‚   â””â”€â”€ cupons/route.ts               # CRUD cupons
```

**Depende de:** Story 6.1 (WhatsApp adapter), Story 10.1 (catalogo online para link)

**CRITICO - Rate limiting WhatsApp:**
- WhatsApp Business API tem limites por tier (1k/10k/100k msg/dia)
- Enviar em batches de 50 com intervalo de 2 segundos
- Se falhar, retry com backoff exponencial
- Nunca enviar mais de 1 campanha por dia para o mesmo cliente

**CRITICO - Compliance:**
- LGPD: opt-in implicito (cliente deu telefone ao cadastrar), opt-out obrigatorio
- WhatsApp Business Policy: nao enviar spam, respeitar opt-out
- Templates devem ser aprovados pelo WhatsApp (se usar Meta Cloud API)
- Incluir "Responda SAIR" em toda mensagem de marketing

**Atribuicao de vendas (simplificada):**
- Ao confirmar venda, verificar se cliente recebeu campanha nos ultimos 7 dias
- Se sim, incrementar salesCount e salesTotal da campanha
- Nao usar UTM/tracking complexo (MVP)

**Templates prontos:**
```
PROMOCAO:
"ðŸ”¥ {nome_loja}: Promocao imperdivel!
{mensagem_personalizada}
Confira: {link_catalogo}
Use o cupom {cupom} e ganhe {desconto}% OFF!
Valido ate {data_fim}
Responda SAIR para nao receber mais"

REATIVACAO:
"Oi {nome_cliente}! ðŸ‘‹
Faz tempo que voce nao aparece na {nome_loja}!
Separamos uma surpresa: {desconto}% de desconto na proxima compra.
Use o cupom {cupom}
Veja as novidades: {link_catalogo}
Responda SAIR para nao receber mais"

LANCAMENTO:
"Novidade na {nome_loja}! ðŸŽ‰
Acabou de chegar: {nome_produto}
Por apenas R$ {preco}
Garanta o seu: {link_produto}
Responda SAIR para nao receber mais"

ANIVERSARIO:
"Parabens {nome_cliente}! ðŸŽ‚
A {nome_loja} deseja um feliz aniversario!
Presente especial: {desconto}% de desconto valido por 7 dias
Use o cupom {cupom}
Responda SAIR para nao receber mais"
```

### Testing

- **Testes necessarios:**
  - getTargetAudience: filtra clientes por criterios
  - getTargetAudience: exclui opt-out
  - sendCampanha: envia em batches com rate limit
  - validateCupom: valida codigo, validade, limite de uso
  - atribuirVenda: vincula venda a campanha se dentro de 7 dias
  - opt-out: marca cliente e exclui de futuras campanhas

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-09 | 1.0 | Criacao inicial da story | Sarah (PO) |

## Dev Agent Record
*A ser preenchido durante implementacao*

## QA Results
*A ser preenchido pelo QA agent*
