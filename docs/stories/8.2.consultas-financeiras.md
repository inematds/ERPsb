# Story 8.2: Consultas Financeiras Avancadas

## Status: Draft

## Story

**As a** usuario,
**I want** perguntar sobre vendas, despesas, lucro e comparativos no chat,
**so that** eu entenda a saude financeira do meu negocio sem planilhas.

## Acceptance Criteria

1. Novas funcoes de consulta para a IA:
   - getVendasPorProduto(inicio, fim, top): ranking de produtos mais vendidos
   - getVendasPorCliente(inicio, fim, top): ranking de clientes
   - getVendasPorFormaPagamento(inicio, fim): distribuicao por forma de pagamento
   - getDespesasPorCategoria(inicio, fim): despesas agrupadas por categoria
   - compararPeriodos(periodo1, periodo2): comparativo mes a mes ou semana a semana
   - getLucroEstimado(inicio, fim): receitas - despesas (lucro operacional simplificado)
2. IA interpreta periodos em linguagem natural: "essa semana", "janeiro", "ultimos 30 dias", "ontem"
3. Respostas incluem comparativos automaticos quando relevante ("15% a mais que o mes passado")
4. Para rankings, IA mostra top 5 por padrao, usuario pode pedir mais
5. Respostas de lucro incluem aviso: "Lucro estimado (nao considera todos os custos fixos)"
6. Funcao de fluxo de caixa projetado basico: baseado em contas agendadas + media historica

## Tasks / Subtasks

- [ ] Adicionar funcoes de consulta (AC: 1)
  - [ ] Adicionar em `src/modules/chat/chat-functions.ts`:
  - [ ] getVendasPorProduto: agrupa vendas.items por productName, soma qtd e total
  - [ ] getVendasPorCliente: agrupa por clientId, soma total, inclui nome
  - [ ] getVendasPorFormaPagamento: agrupa por paymentMethodId
  - [ ] getDespesasPorCategoria: agrupa ContaPagar por category
  - [ ] compararPeriodos: calcula metricas para 2 periodos e retorna diff percentual
  - [ ] getLucroEstimado: soma ContaReceber RECEBIDO - soma ContaPagar PAGO no periodo
  - [ ] getFluxoCaixaProjetado: contas agendadas + media diaria historica
- [ ] Registrar novas tools no Claude adapter (AC: 1, 2)
  - [ ] Atualizar definicoes de tools em `claude-chat.client.ts`
  - [ ] Incluir descricao clara de cada funcao para a IA
  - [ ] IA resolve "essa semana" → datas concretas (segunda a hoje)
- [ ] Adicionar logica de comparativos automaticos (AC: 3)
  - [ ] Quando IA retorna dados de um periodo, automaticamente buscar periodo anterior
  - [ ] Incluir diff percentual na resposta
  - [ ] Exemplo: getVendasPeriodo(fev) → automaticamente compara com jan
- [ ] Atualizar system prompt (AC: 4, 5)
  - [ ] Instruir IA a mostrar top 5 por padrao em rankings
  - [ ] Instruir IA a incluir aviso em calculos de lucro
  - [ ] Instruir IA a sugerir acoes praticas

## Dev Notes

**Depende de:** Story 8.1 (infra de chat)

**CRITICO - Performance de aggregations:**
- Vendas por produto requer desserializar campo Json (items)
- Para tenants com muitas vendas, pode ser lento
- Considerar view materializada ou cache de aggregations
- Alternativa: campo calculado `productSales` atualizado em cada venda

**Interpretacao de datas:**
- "Esse mes" = 1o dia do mes atual ate hoje
- "Mes passado" = 1o dia do mes anterior ate ultimo dia
- "Essa semana" = segunda-feira ate hoje
- "Ultimos 30 dias" = hoje - 30 dias ate hoje
- "Janeiro" = 01/01 a 31/01 do ano corrente
- A IA resolve isso no function calling (parametros inicio/fim)

### Testing

- **Localizacao:** `tests/unit/modules/chat/`
- **Framework:** Vitest
- **Testes necessarios:**
  - getVendasPorProduto: agrupa e ordena corretamente
  - getVendasPorCliente: inclui nome do cliente
  - compararPeriodos: calcula diff percentual
  - getLucroEstimado: receitas - despesas
  - getFluxoCaixaProjetado: soma contas agendadas + media

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-09 | 1.0 | Criacao inicial da story | Sarah (PO) |

## Dev Agent Record
*A ser preenchido durante implementacao*

## QA Results
*A ser preenchido pelo QA agent*
