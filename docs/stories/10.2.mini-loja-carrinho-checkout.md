# Story 10.2: Mini Loja com Carrinho e Checkout

## Status: Draft

## Story

**As a** cliente de uma loja,
**I want** adicionar produtos ao carrinho e pagar por PIX direto no catalogo online,
**so that** eu compre sem precisar ligar ou mandar mensagem.

## Acceptance Criteria

1. Botao "Adicionar ao carrinho" em cada produto do catalogo
2. Icone de carrinho no header com badge de quantidade
3. Pagina de carrinho: lista de itens, quantidade editavel (+/-), remover, subtotal
4. Checkout simplificado (sem cadastro): nome, telefone, observacao
5. Pagamento exclusivamente via PIX (QR code Mercado Pago, integracao existente)
6. Pagina de "Pedido realizado" com QR code PIX e status em tempo real
7. Ao confirmar pagamento (webhook PIX):
   - Cria Venda no ERPsb automaticamente
   - Baixa estoque dos produtos
   - Cria ContaReceber ja marcada como RECEBIDO
   - Notifica dono via WhatsApp: "Novo pedido online de R$ X de {nome}!"
8. Pedido expira em 30 minutos se PIX nao pago
9. Carrinho persistente (localStorage, sobrevive a refresh)
10. Validacao de estoque no checkout: se produto esgotou entre adicionar e finalizar, avisa
11. Model Pedido no Prisma para rastrear pedidos online separados das vendas presenciais

## Tasks / Subtasks

- [ ] Adicionar model Pedido ao Prisma (AC: 11)
  - [ ] Model: id, tenantId, customerName, customerPhone, items (Json), subtotal, total, notes, status (AGUARDANDO_PAGAMENTO/PAGO/EXPIRADO/CANCELADO), pixChargeId, vendaId, expiresAt, paidAt, createdAt, updatedAt
  - [ ] Indices: [tenantId, status], [tenantId, createdAt]
  - [ ] Relation com Tenant
  - [ ] `@@map("pedidos")`
- [ ] Criar componente de carrinho (AC: 1, 2, 9)
  - [ ] Criar `src/app/loja/[slug]/_components/cart-provider.tsx`
  - [ ] Context com: items, addItem, removeItem, updateQuantity, clearCart, total
  - [ ] Persistencia em localStorage (key: `cart-{slug}`)
  - [ ] Badge no icone com quantidade total
- [ ] Criar pagina de carrinho (AC: 3)
  - [ ] Criar `src/app/loja/[slug]/carrinho/page.tsx`
  - [ ] Lista de itens com foto, nome, preco, quantidade (+/-), remover
  - [ ] Subtotal por item e total geral
  - [ ] Botao "Finalizar pedido" â†’ vai para checkout
  - [ ] Botao "Continuar comprando" â†’ volta ao catalogo
  - [ ] Empty state se carrinho vazio
- [ ] Criar pagina de checkout (AC: 4, 5, 10)
  - [ ] Criar `src/app/loja/[slug]/checkout/page.tsx`
  - [ ] Resumo do pedido (itens + total)
  - [ ] Formulario: nome (obrigatorio), telefone (obrigatorio), observacao (opcional)
  - [ ] Validacao de estoque antes de gerar PIX
  - [ ] Ao submeter: POST /api/public/loja/[slug]/pedidos â†’ gera PIX
  - [ ] Redirect para pagina de pagamento
- [ ] Criar pagina de pagamento/status (AC: 6, 8)
  - [ ] Criar `src/app/loja/[slug]/pedido/[id]/page.tsx`
  - [ ] QR code PIX (imagem gerada pelo Mercado Pago)
  - [ ] Codigo copia-e-cola do PIX
  - [ ] Timer de expiracao (30 min countdown)
  - [ ] Polling a cada 5s para verificar status do pagamento
  - [ ] Ao pagar: tela de "Pedido confirmado!" com confetti
  - [ ] Se expirar: "Pedido expirado. Tente novamente."
- [ ] Criar service de pedidos (AC: 7, 8)
  - [ ] Criar `src/modules/pedidos/pedido.service.ts`
  - [ ] Funcao createPedido(slug, data): cria Pedido + PixCharge
  - [ ] Funcao confirmPedido(pedidoId): ao receber webhook PIX:
    1. Atualiza Pedido status=PAGO
    2. Cria Venda CONFIRMADA com items do pedido
    3. Baixa estoque
    4. Cria ContaReceber RECEBIDO
    5. Envia WhatsApp para dono
  - [ ] Funcao expirePedidos(): cron job que marca expirados
  - [ ] Funcao getPedidoStatus(id): retorna status atual
- [ ] APIs publicas (AC: 5, 6)
  - [ ] `src/app/api/public/loja/[slug]/pedidos/route.ts` POST (criar pedido + PIX)
  - [ ] `src/app/api/public/loja/[slug]/pedidos/[id]/route.ts` GET (status)
  - [ ] `src/app/api/public/loja/[slug]/pedidos/[id]/status/route.ts` GET (polling)
- [ ] Estender webhook PIX (AC: 7)
  - [ ] Modificar webhook do Mercado Pago para detectar PIX de pedido online
  - [ ] Se PixCharge tem Pedido vinculado â†’ chamar confirmPedido()
- [ ] Notificacao ao dono (AC: 7)
  - [ ] Ao confirmar pedido, enviar WhatsApp para storeWhatsApp do tenant:
    ```
    ðŸ›’ Novo pedido online!
    Cliente: {nome} ({telefone})
    Itens: {lista}
    Total: R$ {valor}
    Pagamento: PIX confirmado âœ…
    ```
  - [ ] Criar Notification interna tambem
- [ ] Cron para expirar pedidos (AC: 8)
  - [ ] Criar `src/app/api/v1/pedidos/expirar/route.ts`
  - [ ] Busca pedidos AGUARDANDO_PAGAMENTO com expiresAt < now()
  - [ ] Marca como EXPIRADO
  - [ ] Cancela PixCharge vinculada
  - [ ] Adicionar no vercel.json crons (a cada 15 min)

## Dev Notes

**Source Tree relevante:**
```
src/
â”œâ”€â”€ app/loja/[slug]/
â”‚   â”œâ”€â”€ _components/cart-provider.tsx   # Context do carrinho
â”‚   â”œâ”€â”€ carrinho/page.tsx              # Pagina do carrinho
â”‚   â”œâ”€â”€ checkout/page.tsx              # Checkout
â”‚   â””â”€â”€ pedido/[id]/page.tsx           # Status do pedido
â”œâ”€â”€ modules/pedidos/
â”‚   â”œâ”€â”€ pedido.service.ts              # Business logic
â”‚   â””â”€â”€ pedido.schema.ts              # Zod schemas
â”œâ”€â”€ app/api/public/loja/[slug]/pedidos/
â”‚   â”œâ”€â”€ route.ts                       # POST criar
â”‚   â””â”€â”€ [id]/
â”‚       â”œâ”€â”€ route.ts                   # GET detalhes
â”‚       â””â”€â”€ status/route.ts           # GET polling
```

**Depende de:** Story 10.1 (catalogo), Story 4.3/4.4 (integracao PIX Mercado Pago)

**CRITICO - Sem autenticacao:**
- Todo o fluxo do cliente e publico (sem login)
- Validar dados do formulario server-side (sanitizar nome/telefone)
- Rate limit: max 5 pedidos por IP por hora (evitar abuso)
- Honeypot field para evitar bots

**CRITICO - Estoque:**
- Nao reservar estoque ao adicionar no carrinho (complexidade excessiva)
- Validar estoque no momento do checkout
- Se produto esgotou: remover do carrinho e avisar
- Race condition: 2 clientes compram ultimo item simultaneamente â†’ primeiro a pagar ganha

**Carrinho no localStorage:**
```typescript
type CartItem = {
  productId: string
  name: string
  price: number      // centavos (snapshot no momento de adicionar)
  quantity: number
  imageUrl?: string
}
```

### Testing

- **Testes necessarios:**
  - Cart provider: add/remove/update/clear
  - Cart provider: persiste em localStorage
  - createPedido: cria Pedido + PixCharge
  - confirmPedido: cria Venda + baixa estoque + ContaReceber
  - confirmPedido: notifica dono via WhatsApp
  - expirePedidos: marca expirados
  - Checkout: valida estoque antes de gerar PIX
  - API: rate limit funciona

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-09 | 1.0 | Criacao inicial da story | Sarah (PO) |

## Dev Agent Record
*A ser preenchido durante implementacao*

## QA Results
*A ser preenchido pelo QA agent*
