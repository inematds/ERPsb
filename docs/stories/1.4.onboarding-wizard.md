# Story 1.4: Onboarding Wizard

## Status: Draft

## Story

**As a** novo usuario,
**I want** configurar minha empresa respondendo 5 perguntas simples,
**so that** o sistema esteja pronto para uso em menos de 5 minutos.

## Acceptance Criteria

1. Wizard de 5 steps com UI conversacional (1 pergunta por tela, progresso visual):
   - Step 1: "Qual o nome do seu negocio?" (texto livre)
   - Step 2: "Que tipo de negocio voce tem?" (opcoes: Servicos, Comercio, Alimentacao, Beleza, Outro)
   - Step 3: "Quanto voce fatura por mes, mais ou menos?" (faixas: Ate R$5k, R$5-20k, R$20-100k, Acima R$100k)
   - Step 4: "Voce tem CNPJ?" (Sim - informar CNPJ / Nao - modo informal)
   - Step 5: "Como voce cobra seus clientes hoje?" (multipla escolha: PIX, Dinheiro, Cartao, Boleto)
2. Sistema configura automaticamente: tipo de tenant, plano sugerido, formas de pagamento, categorias financeiras
3. Ao concluir, redireciona para dashboard com mensagem de boas-vindas e dicas contextuais
4. Possibilidade de pular o wizard e configurar depois
5. Dados do wizard salvos no tenant e editaveis em Configuracoes
6. Mobile-first: botoes grandes, transicoes suaves, funciona bem em telas de 320px

## Tasks / Subtasks

- [ ] Criar pagina de onboarding (AC: 1, 6)
  - [ ] Criar `src/app/(auth)/onboarding/page.tsx` como Server Component
  - [ ] Criar `src/app/(auth)/onboarding/onboarding-wizard.tsx` como Client Component (`'use client'`)
  - [ ] Implementar wizard multi-step com state local (useState para step atual)
  - [ ] Step 1: Input de texto para nome do negocio (autofocus, validacao nao-vazio)
  - [ ] Step 2: Grid de cards clicaveis com icones para tipo de negocio
  - [ ] Step 3: Cards com faixas de faturamento (Ate R$5k, R$5-20k, R$20-100k, Acima R$100k)
  - [ ] Step 4: Botoes Sim/Nao para CNPJ; se Sim, mostrar input de CNPJ com mascara e validacao
  - [ ] Step 5: Checkboxes visuais para formas de pagamento (multipla selecao)
  - [ ] Barra de progresso visual (1/5 a 5/5) no topo
  - [ ] Transicoes suaves entre steps (animacao de slide)
  - [ ] Layout centrado, max-width 400px, padding adequado para 320px
  - [ ] Botao "Voltar" (exceto step 1) e "Proximo" em cada step
- [ ] Implementar botao "Pular e configurar depois" (AC: 4)
  - [ ] Link discreto abaixo do wizard "Pular e configurar depois"
  - [ ] Ao pular: criar tenant com valores default e redirecionar para dashboard
  - [ ] Marcar `onboardingCompleted = false` no tenant (para lembrar depois)
- [ ] Criar API de onboarding (AC: 2, 5)
  - [ ] Criar endpoint ou Server Action para processar dados do wizard
  - [ ] Receber: businessName, businessType, monthlyRevenue, hasCnpj, cnpj (opcional), paymentMethods[]
  - [ ] Validar input com Zod schema (`onboardingSchema`)
  - [ ] Criar Tenant com dados informados
  - [ ] Criar UserTenant com role OWNER e isActive=true
  - [ ] Determinar `type` do tenant: se hasCnpj=true, definir MEI/ME baseado no faturamento; se nao, INFORMAL
  - [ ] Sugerir plano: Ate R$5k -> FREE, R$5-20k -> STARTER, R$20-100k -> GROWTH, Acima R$100k -> PRO
- [ ] Criar formas de pagamento automaticamente (AC: 2)
  - [ ] Com base no step 5 (paymentMethods[]), criar registros em FormaPagamento
  - [ ] Sempre criar PIX (default), DINHEIRO (default) se selecionados
  - [ ] Criar CREDITO, DEBITO, BOLETO conforme selecao
  - [ ] Marcar PIX como `isDefault = true` se selecionado
- [ ] Criar categorias financeiras default (AC: 2)
  - [ ] Categorias de despesa: Aluguel, Funcionarios, Fornecedores, Impostos, Marketing, Servicos, Outros
  - [ ] Categorias de receita: Vendas, Servicos, Outros
  - [ ] Armazenar em `src/lib/constants.ts` como constantes (nao no banco por enquanto)
- [ ] Implementar redirect pos-onboarding (AC: 3)
  - [ ] Apos salvar dados, marcar `onboardingCompleted = true` no tenant
  - [ ] Atualizar sessao do NextAuth com novo tenantId ativo
  - [ ] Redirect para `/` (dashboard)
  - [ ] Dashboard detecta primeiro acesso e mostra mensagem de boas-vindas
- [ ] Implementar validacao de CNPJ (AC: 1)
  - [ ] Criar/usar `src/lib/validators.ts` com funcao `validateCNPJ()`
  - [ ] Mascara de input: XX.XXX.XXX/XXXX-XX
  - [ ] Validacao de digitos verificadores
  - [ ] Feedback visual: input fica verde se valido, vermelho se invalido

## Dev Notes

**Source Tree relevante:**
```
src/
├── app/(auth)/onboarding/
│   ├── page.tsx                # Server Component (redirect se ja tem tenant)
│   └── onboarding-wizard.tsx   # Client Component (wizard UI)
├── core/tenant/
│   └── tenant.service.ts      # createTenant() (de Story 1.3)
├── modules/cadastros/
│   └── forma-pagamento.service.ts  # Criacao de formas de pagamento
├── lib/
│   ├── validators.ts           # validateCNPJ()
│   └── constants.ts            # Categorias default
└── types/
    └── domain.ts               # OnboardingData type
```

**Depende de:** Story 1.2 (autenticacao, redirect), Story 1.3 (Tenant/UserTenant models, tenant service)

**Logica de determinacao de tipo de tenant:**
```typescript
function determineTenantType(hasCnpj: boolean, monthlyRevenue: string): string {
  if (!hasCnpj) return 'INFORMAL';
  if (monthlyRevenue === 'ATE_5K') return 'MEI';
  if (monthlyRevenue === '5K_20K') return 'MEI'; // MEI limite R$81k/ano
  return 'ME'; // Acima de R$20k/mes provavelmente ME
}
```

**Logica de sugestao de plano:**
```typescript
function suggestPlan(monthlyRevenue: string): string {
  switch (monthlyRevenue) {
    case 'ATE_5K': return 'FREE';
    case '5K_20K': return 'STARTER';
    case '20K_100K': return 'GROWTH';
    case 'ACIMA_100K': return 'PRO';
    default: return 'FREE';
  }
}
```

**Coding Standards:**
- Wizard como Client Component (`'use client'`), page.tsx como Server Component
- Validacao de CNPJ apenas no client (algoritmo de digitos verificadores)
- Zod schema para validar dados antes de enviar ao server
- Animacoes via CSS transitions (nao JS) para performance em mobile
- Botoes com min-height 48px para toque confortavel (WCAG)

### Testing

- **Localizacao:** `tests/unit/lib/` e `tests/integration/api/`
- **Framework:** Vitest
- **Testes necessarios:**
  - `validateCNPJ()` valida CNPJs corretos e rejeita incorretos
  - `determineTenantType()` retorna tipo correto para cada combinacao
  - `suggestPlan()` retorna plano correto para cada faixa de faturamento
  - Onboarding cria Tenant + UserTenant + FormaPagamento corretamente
  - Onboarding com "pular" cria tenant com defaults e onboardingCompleted=false
  - Redirect para dashboard apos completar onboarding
  - Zod schema rejeita dados invalidos (nome vazio, CNPJ invalido)
- **E2E (futuro):** Fluxo completo de onboarding via Playwright

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-07 | 1.0 | Criacao inicial da story | Sarah (PO) |

## Dev Agent Record

### Agent Model Used
*A ser preenchido pelo dev agent*

### Debug Log References
*A ser preenchido pelo dev agent*

### Completion Notes List
*A ser preenchido pelo dev agent*

### File List
*A ser preenchido pelo dev agent*

## QA Results
*A ser preenchido pelo QA agent*
