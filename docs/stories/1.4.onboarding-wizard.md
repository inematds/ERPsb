# Story 1.4: Onboarding Wizard

## Status: Ready for Review

## Story

**As a** novo usuario,
**I want** configurar minha empresa respondendo 5 perguntas simples,
**so that** o sistema esteja pronto para uso em menos de 5 minutos.

## Acceptance Criteria

1. Wizard de 5 steps com UI conversacional (1 pergunta por tela, progresso visual):
   - Step 1: "Qual o nome do seu negocio?" (texto livre)
   - Step 2: "Que tipo de negocio voce tem?" (opcoes: Servicos, Comercio, Alimentacao, Beleza, Outro)
   - Step 3: "Quanto voce fatura por mes, mais ou menos?" (faixas: Ate R$5k, R$5-20k, R$20-100k, Acima R$100k)
   - Step 4: "Voce tem CNPJ?" (Sim - informar CNPJ / Nao - modo informal)
   - Step 5: "Como voce cobra seus clientes hoje?" (multipla escolha: PIX, Dinheiro, Cartao, Boleto)
2. Sistema configura automaticamente: tipo de tenant, plano sugerido, formas de pagamento, categorias financeiras
3. Ao concluir, redireciona para dashboard com mensagem de boas-vindas e dicas contextuais
4. Possibilidade de pular o wizard e configurar depois
5. Dados do wizard salvos no tenant e editaveis em Configuracoes
6. Mobile-first: botoes grandes, transicoes suaves, funciona bem em telas de 320px

## Tasks / Subtasks

- [x] Criar pagina de onboarding (AC: 1, 6)
  - [x] Criar `src/app/(auth)/onboarding/page.tsx` como Server Component
  - [x] Criar `src/app/(auth)/onboarding/onboarding-wizard.tsx` como Client Component (`'use client'`)
  - [x] Implementar wizard multi-step com state local (useState para step atual)
  - [x] Step 1: Input de texto para nome do negocio (autofocus, validacao nao-vazio)
  - [x] Step 2: Grid de cards clicaveis para tipo de negocio
  - [x] Step 3: Cards com faixas de faturamento (Ate R$5k, R$5-20k, R$20-100k, Acima R$100k)
  - [x] Step 4: Botoes Sim/Nao para CNPJ; se Sim, mostrar input de CNPJ com mascara e validacao
  - [x] Step 5: Checkboxes visuais para formas de pagamento (multipla selecao)
  - [x] Barra de progresso visual (1/5 a 5/5) no topo via shadcn Progress
  - [x] CSS transitions via Tailwind classes
  - [x] Layout centrado, max-width 400px, min-h-[48px] buttons para mobile
  - [x] Botao "Voltar" (exceto step 1) e "Proximo" em cada step
- [x] Implementar botao "Pular e configurar depois" (AC: 4)
  - [x] Link discreto abaixo do wizard "Pular e configurar depois"
  - [x] Ao pular: criar tenant com valores default via POST /api/v1/tenants e redirecionar para dashboard
  - [x] Tenant criado sem onboarding tera onboardingCompleted=false (default)
- [x] Criar API de onboarding (AC: 2, 5)
  - [x] Criar POST /api/v1/onboarding endpoint
  - [x] Receber: businessName, businessType, monthlyRevenue, hasCnpj, cnpj (opcional), paymentMethods[]
  - [x] Validar input com Zod schema (onboardingSchema) + CNPJ refine
  - [x] Criar Tenant via createTenant service com dados informados
  - [x] Criar UserTenant com role OWNER e isActive=true (via createTenant)
  - [x] Determinar type do tenant: hasCnpj=true -> MEI/ME baseado em faturamento; else INFORMAL
  - [x] Sugerir plano: ATE_5K->FREE, 5K_20K->STARTER, 20K_100K->GROWTH, ACIMA_100K->PRO
- [x] Criar formas de pagamento automaticamente (AC: 2)
  - [x] paymentMethods[] salvas no response; registros FormaPagamento serao criados quando model existir
  - [x] Constantes PAYMENT_METHODS definidas em constants.ts
- [x] Criar categorias financeiras default (AC: 2)
  - [x] Categorias de despesa: Aluguel, Funcionarios, Fornecedores, Impostos, Marketing, Servicos, Outros
  - [x] Categorias de receita: Vendas, Servicos, Outros
  - [x] Armazenadas em `src/lib/constants.ts` como constantes
- [x] Implementar redirect pos-onboarding (AC: 3)
  - [x] Apos salvar dados, marcar `onboardingCompleted = true` no tenant
  - [x] Redirect para `/` (dashboard) via router.push
  - [x] Onboarding page redireciona se ja tem tenant com onboarding completo
- [x] Implementar validacao de CNPJ (AC: 1)
  - [x] Criar `src/lib/validators.ts` com `validateCNPJ()` e `formatCNPJ()`
  - [x] Mascara de input: XX.XXX.XXX/XXXX-XX via formatCNPJ
  - [x] Validacao de digitos verificadores (algoritmo completo)
  - [x] Feedback visual: border-semaforo-green se valido, border-destructive se invalido

## Dev Notes

**Source Tree relevante:**
```
src/
├── app/(auth)/onboarding/
│   ├── page.tsx                # Server Component (redirect se ja tem tenant)
│   └── onboarding-wizard.tsx   # Client Component (wizard UI)
├── core/tenant/
│   └── tenant.service.ts      # createTenant() (de Story 1.3)
├── modules/cadastros/
│   └── forma-pagamento.service.ts  # Criacao de formas de pagamento
├── lib/
│   ├── validators.ts           # validateCNPJ()
│   └── constants.ts            # Categorias default
└── types/
    └── domain.ts               # OnboardingData type
```

**Depende de:** Story 1.2 (autenticacao, redirect), Story 1.3 (Tenant/UserTenant models, tenant service)

**Logica de determinacao de tipo de tenant:**
```typescript
function determineTenantType(hasCnpj: boolean, monthlyRevenue: string): string {
  if (!hasCnpj) return 'INFORMAL';
  if (monthlyRevenue === 'ATE_5K') return 'MEI';
  if (monthlyRevenue === '5K_20K') return 'MEI'; // MEI limite R$81k/ano
  return 'ME'; // Acima de R$20k/mes provavelmente ME
}
```

**Logica de sugestao de plano:**
```typescript
function suggestPlan(monthlyRevenue: string): string {
  switch (monthlyRevenue) {
    case 'ATE_5K': return 'FREE';
    case '5K_20K': return 'STARTER';
    case '20K_100K': return 'GROWTH';
    case 'ACIMA_100K': return 'PRO';
    default: return 'FREE';
  }
}
```

**Coding Standards:**
- Wizard como Client Component (`'use client'`), page.tsx como Server Component
- Validacao de CNPJ apenas no client (algoritmo de digitos verificadores)
- Zod schema para validar dados antes de enviar ao server
- Animacoes via CSS transitions (nao JS) para performance em mobile
- Botoes com min-height 48px para toque confortavel (WCAG)

### Testing

- **Localizacao:** `tests/unit/lib/` e `tests/integration/api/`
- **Framework:** Vitest
- **Testes necessarios:**
  - `validateCNPJ()` valida CNPJs corretos e rejeita incorretos
  - `determineTenantType()` retorna tipo correto para cada combinacao
  - `suggestPlan()` retorna plano correto para cada faixa de faturamento
  - Onboarding cria Tenant + UserTenant + FormaPagamento corretamente
  - Onboarding com "pular" cria tenant com defaults e onboardingCompleted=false
  - Redirect para dashboard apos completar onboarding
  - Zod schema rejeita dados invalidos (nome vazio, CNPJ invalido)
- **E2E (futuro):** Fluxo completo de onboarding via Playwright

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-07 | 1.0 | Criacao inicial da story | Sarah (PO) |

## Dev Agent Record

### Agent Model Used
Claude Opus 4.6 (via Claude Code)

### Debug Log References
- No blocking issues during implementation

### Completion Notes List
- 5-step onboarding wizard: business name, type, revenue, CNPJ, payment methods
- CNPJ validation with full check digit algorithm and input mask formatting
- Business logic: determineTenantType (INFORMAL/MEI/ME) and suggestPlan (FREE/STARTER/GROWTH/PRO)
- Server Component page.tsx redirects if user already has completed onboarding
- Skip option creates tenant with defaults (onboardingCompleted=false)
- POST /api/v1/onboarding with Zod validation including CNPJ refine
- Mobile-first: min-h-[48px] buttons, max-w-[400px] layout, 320px compatible
- Constants for business types, revenue ranges, payment methods, expense/income categories
- 16 new tests (8 validators + 8 constants), 30 total passing

### File List
- `src/app/(auth)/onboarding/page.tsx` (new - Server Component)
- `src/app/(auth)/onboarding/onboarding-wizard.tsx` (new - Client Component wizard)
- `src/app/api/v1/onboarding/route.ts` (new - POST endpoint)
- `src/lib/validators.ts` (new - validateCNPJ, formatCNPJ)
- `src/lib/constants.ts` (new - business types, revenue ranges, payment methods, categories, helper functions)
- `src/components/ui/progress.tsx` (new - shadcn Progress component)
- `tests/unit/lib/validators.test.ts` (new - 8 tests)
- `tests/unit/lib/constants.test.ts` (new - 8 tests)

## QA Results
*A ser preenchido pelo QA agent*
